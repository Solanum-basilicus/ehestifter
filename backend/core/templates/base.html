<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}">
  <script src="{{ url_for('static', filename='js/status-utils.js') }}"></script>  
  <script src="{{ url_for('static', filename='js/net-utils.js') }}"></script>
  <title>{{ title or "Ehestifter" }}</title>
  {% block head_extra %}{% endblock %}
  <style>
    /* tiny header styling */
    .topbar { padding:10px 16px; background:#fff; border-bottom:1px solid #e5e7eb; }
    .wrap { max-width:1100px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; }
    .muted { color:#6b7280; }
    .sep { color:#9ca3af; margin:0 .5rem; }
  </style>
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
</head>
<body style="margin:0; background:#f8fafc; color:#111827; font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, 'Noto Color Emoji';">
  <header class="topbar">
    <div class="wrap">
      <a href="{{ url_for('index') }}" style="text-decoration:none; font-weight:600; color:#111827;">Ehestifter</a>
      <nav style="font-size:14px; display:flex; align-items:center;">
        <!-- user link is hydrated client-side -->
        <a id="user-link" class="muted" href="{{ url_for('me') }}">Loading user…</a>
        <span class="sep">|</span>
        <a href="{{ url_for('identity.logout') }}">Logout</a>
      </nav>
    </div>
  </header>

  <main>
    {% block content %}{% endblock %}
  </main>

  <footer style="padding:20px 16px; color:#6b7280; font-size:12px; text-align:center;">
    © {{ now.strftime("%Y") if now else "" }} Ehestifter
  </footer>

  <script>window.TELEGRAM_BOT_USERNAME = "EhestifterBot";</script>



  <!-- User-bar cold-start helper -->
  <script>

  (function(){
    const userLink = document.getElementById('user-link');
    let inited = false;

    function setUser(text, href) {
      userLink.textContent = text;
      if (href) userLink.href = href;
      userLink.classList.remove('muted');
    }

    function showError(msg) {
      userLink.textContent = 'User info unavailable - ' + msg;
      userLink.removeAttribute('href');
      // replace/add a Retry button next to the link
      let btn = document.getElementById('retry-user');
      if (!btn) {
        btn = document.createElement('button');
        btn.id = 'retry-user';
        btn.type = 'button';
        btn.textContent = 'Retry';
        btn.style.marginLeft = '.5rem';
        userLink.insertAdjacentElement('afterend', btn);
      }
      btn.onclick = initUser;
    }

    async function initUser() {
      if (inited) return;
      inited = true;
      try {
        const data = await window.fetchWithRetry('/ui/users/me', 4);
        if (data && !data.error) {
          const username = data.name || data.preferred_username || data.username || data.email || 'me';
          setUser('To profile: ' + username, "{{ url_for('me') }}");
        } else {
          showError((data && data.message) || 'please try again');
        }
      } catch {
        showError('please try again');
      } finally {
        // allow manual retry even after first pass
        inited = false;
      }
    }

    document.addEventListener('DOMContentLoaded', initUser);
  })();

    // Local "Today / Yesterday / N days ago" based on browser time
  window.__relativeFromLocal = (iso) => {
    if (!iso) return '';
    const d = new Date(iso);
    const now = new Date();

    // Truncate to local midnight
    const startOfDay = (x) => new Date(x.getFullYear(), x.getMonth(), x.getDate());
    const diffDays = Math.floor((startOfDay(now) - startOfDay(d)) / (24*3600*1000));

    if (diffDays <= 0) return 'Today';
    if (diffDays === 1) return 'Yesterday';
    return `${diffDays} days ago`;
  };

  // Back-compat alias (safe to keep for a while)
  window.__relativeFromUtc = window.__relativeFromLocal;
  </script>
</body>
</html>
