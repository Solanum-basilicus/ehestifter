{% extends "base.html" %}

{% block head_extra %}
<style>
  table { border-collapse: collapse; width: 100%; }
  th, td { border: 1px solid #ddd; padding: 8px; vertical-align: top; }
  th { background: #f7f7f7; text-align: left; position: sticky; top: 0; }
  .toolbar { display:flex; justify-content: space-between; align-items: center; margin: 10px 0; gap: 10px; }
  .pager { display:flex; align-items:center; gap:6px; }
  .text-dim { opacity:.7; }         /* do not override .muted from base.html */
  .truncate { max-width: 48ch; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: inline-block; vertical-align: bottom; }
  .hidden { display:none; }
  .title-link { font-weight: 600; text-decoration: none; }
  .title-link:hover { text-decoration: underline; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  /* Reserve space so rows don't jump when pills arrive */
  .col-status { min-width: 26ch; } /* fits "Rejected with Unfortunately" + pill padding */
  /* A subtle private cue on the whole column (matches private-block theme) */
  thead th.th-status { background: linear-gradient(90deg, rgba(124,58,237,.08), #f7f7f7 36px) }
  tbody td.col-status { background: linear-gradient(90deg, rgba(124,58,237,.05), transparent 12px); }
  .chip { border:1px solid #ddd; border-radius:999px; padding:2px 8px; font-size:12px; line-height:20px; }
  .chip.muted { opacity:.75; }

</style>
{% endblock %}

{% block content %}
  <div style="max-width:1100px; margin:0 auto; padding:16px;">
    <h3 style="display:flex; align-items:center; gap:10px; margin: 14px 0;">
      I have those jobs for you
      <a href="{{ url_for('job_new') }}"
        style="font-size:.95rem; padding:6px 10px; border:1px solid #bbb; border-radius:6px; text-decoration:none;">
        + Add new
      </a>
    </h3>

    <div class="toolbar">
      <div>
        <label for="page-size">Rows per page:</label>
        <select id="page-size">
          <option value="10">10</option>
          <option value="25" selected>25</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
        <span class="text-dim" id="jobs-status">Loadingâ€¦</span>
      </div>
      <div class="pager">
        <button id="prev" disabled>&larr; Prev</button>
        <span class="nowrap">Page <span id="page-num">1</span></span>
        <button id="next" disabled>Next &rarr;</button>
        <button id="refresh">Refresh</button>
      </div>
    </div>

    <div id="jobs-error" class="hidden"></div>

    <!-- Cards list -->
    <div id="jobs-list" class="cards" aria-busy="true"></div>

    <details style="margin-top:16px;">
      <summary><p style="display:inline">Debug: Jobs API</p></summary>
      <pre id="dbg-jobs" class="mono" style="min-height:4rem; opacity:.7">Loadingâ€¦</pre>
    </details>
  </div>

  <script>
  (function(){
    // ---------------------------
    // Tiny time helpers
    // ---------------------------
    const rtf = new Intl.RelativeTimeFormat(undefined, { numeric: 'auto' });
    const dfHM = new Intl.DateTimeFormat(undefined, { hour: '2-digit', minute: '2-digit', hour12: false });
    const dfDM = new Intl.DateTimeFormat(undefined, { day: '2-digit', month: 'short' });
    const dfDMY = new Intl.DateTimeFormat(undefined, { day: '2-digit', month: 'short', year: 'numeric' });

    
    
    function formatWhen(iso) {
      if (!iso) return '';
      const d = new Date(iso);
      if (isNaN(d)) return iso;
      const now = new Date();
      const diffMs = d - now;
      const absMin = Math.abs(diffMs) / 60000;

      if (absMin < 15) return 'just now';
      const sameDay = d.toDateString() === now.toDateString();
      if (sameDay) return dfHM.format(d);

      const absDays = Math.abs(d - now) / 86400000;
      if (absDays < 7) return `${dfDM.format(d)} at ${dfHM.format(d)}`;
      if (d.getFullYear() === now.getFullYear()) return dfDM.format(d);
      return dfDMY.format(d);
    }

    // ---------------------------
    // async data fetch with progressive retry timeout
    // (kept local; base.html has its own for user bar)
    // ---------------------------
    async function fetchWithRetry(url, attempts = 4) {
      let delay = 500; // ms
      for (let i = 1; i <= attempts; i++) {
        try {
          const resp = await fetch(url, { credentials: 'same-origin' });
          if (!resp.ok) throw new Error('HTTP ' + resp.status);
          return await resp.json();
        } catch (err) {
          if (i === attempts) throw err;
          await new Promise(r => setTimeout(r, delay));
          delay *= 2; // 0.5s, 1s, 2s, 4s
        }
      }
    }
    async function postWithRetry(url, body, attempts = 4) {
      let delay = 500;
      for (let i = 1; i <= attempts; i++) {
        try {
          const resp = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify(body)
          });
          if (!resp.ok) throw new Error('HTTP ' + resp.status);
          return await resp.json();
        } catch (err) {
          if (i === attempts) throw err;
          await new Promise(r => setTimeout(r, delay));
          delay *= 2;
        }
      }
    }
    // ---------- DOM refs ----------
    const listEl = document.getElementById('jobs-list');
    const statusEl = document.getElementById('jobs-status');
    const errEl = document.getElementById('jobs-error');
    const dbgJobs = document.getElementById('dbg-jobs');
    const pageSizeSel = document.getElementById('page-size');
    const prevBtn = document.getElementById('prev');
    const nextBtn = document.getElementById('next');
    const refreshBtn = document.getElementById('refresh');
    const pageNumEl = document.getElementById('page-num');

    // ---------- Paging state ----------
    let pageSize = Number(sessionStorage.getItem('jobs.pageSize') || 25);
    if (![10,25,50,100].includes(pageSize)) pageSize = 25;
    pageSizeSel.value = String(pageSize);

    let page = 1;
    let lastReceived = 0;

    function setLoading(loading, note='') {
      listEl?.setAttribute('aria-busy', loading ? 'true' : 'false');
      statusEl.textContent = loading ? (note || 'Loadingâ€¦') : (note || `Showing ${lastReceived} row(s)`);
      if (loading) errEl?.setAttribute('hidden', 'hidden');
    }

    function setPagerState() {
      pageNumEl.textContent = String(page);
      prevBtn.disabled = page <= 1;
      nextBtn.disabled = lastReceived < pageSize;
    }

    function summarizeLocations(row) {
      const locs = Array.isArray(row.locations) ? row.locations : [];
      const remote = row.RemoteType && row.RemoteType !== 'Unknown' ? row.RemoteType : '';

      if (!locs.length) return remote || '';

      // Group by country (prefer ISO code for compactness)
      const byCountry = new Map(); // key -> Set(cities)
      for (const l of locs) {
        const key = (l.countryCode || '').toUpperCase() || (l.countryName || '').trim();
        const city = (l.cityName || '').trim();
        if (!key) continue;
        if (!byCountry.has(key)) byCountry.set(key, new Set());
        if (city) byCountry.get(key).add(city);
      }

      // Build "DE: Berlin, Munich; ES: Madrid; GB: London"
      const parts = [];
      for (const [country, cities] of byCountry) {
        const cityArr = Array.from(cities);
        const cityStr = cityArr.slice(0, 2).join(", ") + (cityArr.length > 2 ? ", â€¦" : "");
        parts.push(cityArr.length ? `${country}: ${cityStr}` : country);
        if (parts.length >= 4) { parts.push("â€¦"); break; } // keep short
      }
      const geo = parts.join("; ");
      return remote ? `${geo} Â· ${remote}` : geo;
    }

    function displayTitle(row) {
      const t = (row.Title || '').trim();
      if (t) return t;
      const xid = (row.ExternalId || '').trim();
      return xid || '(no title)';
    }

    // ---------- Card rendering ----------
    function cardHTML(row) {
      const title = displayTitle(row);
      const company = row.HiringCompanyName || '';
      const geo = summarizeLocations(row);
      const firstSeen = row.FirstSeenAt || '';
      const sid = `ust_${row.Id}`;
      const via = (row.FoundOn || '').trim();

      const esc = (s) => String(s).replaceAll('"','&quot;');

      return `
        <article class="card" style="padding:12px 16px;">
          <div class="flex-between" style="gap:12px;">
            <div style="min-width:0;">
              <h4 class="truncate-1" style="font-size:18px; margin:0 0 4px 0;">
                <a class="title-link" href="/jobs/${encodeURIComponent(row.Id)}" title="${esc(title)}">${title}</a>
              </h4>
              <div class="flex muted" style="flex-wrap:wrap; font-size:14px; gap:8px;">
                ${company ? `<span class="truncate-1" style="max-width:36ch;" title="${esc(company)}">${company}</span>` : ''}
                ${geo ? `<span class="truncate-1" style="max-width:38ch;" title="${esc(geo)}">${geo}</span>` : ''}
                ${via ? `<span class="chip muted" title="Found on">${esc(via)}</span>` : ''}
              </div>
            </div>
            <div style="text-align:right;">
              <div class="muted" style="font-size:11px; text-transform:uppercase; letter-spacing:.04em;">First seen</div>
              <div style="font-size:14px;">${formatWhen(firstSeen)}</div>
            </div>
          </div>

          <div class="flex" style="margin-top:8px; flex-wrap:wrap; gap:10px; align-items:center;">
            <div class="muted" style="font-size:14px;">Your status</div>
            <span class="chip-private">ðŸ”’ Only you</span>
            <span class="status-slot">
              <span class="status-badge" data-k="unset" id="${sid}">loadingâ€¦</span>
            </span>
          </div>
        </article>
      `;
    }

    function renderCards(items) {
      listEl.innerHTML = items.map(cardHTML).join('');
    }

    async function loadStatusesFor(ids) {
      if (!ids || !ids.length) return;
      try {
        const data = await postWithRetry('/ui/jobs/status', { jobIds: ids }, 4);
        const map = (data && data.statuses) || {};
        for (const id of ids) {
          const el = document.getElementById(`ust_${id}`);
          if (!el) continue;
          const raw = map[id] ?? map[id?.toLowerCase?.()] ?? 'Unset';
          el.textContent = raw || 'Unset';
          el.dataset.k = window.Status.statusKey(raw);
        }
      } catch (e) {
        // graceful degrade
        for (const id of ids) {
          const el = document.getElementById(`ust_${id}`);
          if (!el) continue;
          el.textContent = 'unavailable';
          el.dataset.k = 'unset';
        }
      }
    }

    // ---------- Page load ----------
    async function loadPage() {
      const offset = (page - 1) * pageSize;
      setLoading(true, `Loading page ${page}â€¦`);
      try {
        const data = await fetchWithRetry(`/ui/jobs?limit=${pageSize}&offset=${offset}`, 4);
        if (data && !data.error) {
          const items = Array.isArray(data.items) ? data.items : [];
          lastReceived = data.received || items.length;
          if (dbgJobs) { dbgJobs.style.opacity = 1; dbgJobs.textContent = JSON.stringify(data, null, 2); }

          if (items.length === 0) {
            listEl.innerHTML = `<div class="card" style="padding:12px 16px;"><span class="muted">No data</span></div>`;
            setLoading(false, 'No rows');
            setPagerState();
            return;
          }

          renderCards(items);
          setLoading(false);
          setPagerState();

          // Fetch statuses asynchronously
          loadStatusesFor(items.map(x => x.Id).filter(Boolean));
        } else {
          throw new Error((data && data.message) || 'Jobs service is warming up');
        }
      } catch (e) {
        console.error('loadPage error', e);
        errEl.style.display = 'block';
        errEl.innerHTML = `
          <span class="text-dim">Jobs unavailable - ${e.message || e}</span>
          <button id="retry-jobs" type="button" style="margin-left:.5rem">Retry</button>
        `;
        document.getElementById('retry-jobs').addEventListener('click', () => {
          errEl.style.display = 'none';
          loadPage();
        });
        setLoading(false, 'Failed to load');
      }
    }

    // ---------- Wiring ----------
    pageSizeSel.addEventListener('change', () => {
      pageSize = Number(pageSizeSel.value);
      sessionStorage.setItem('jobs.pageSize', String(pageSize));
      page = 1;
      loadPage();
    });
    prevBtn.addEventListener('click', () => { if (page > 1) { page -= 1; loadPage(); } });
    nextBtn.addEventListener('click', () => { if (!nextBtn.disabled) { page += 1; loadPage(); } });
    refreshBtn.addEventListener('click', loadPage);

    document.addEventListener('DOMContentLoaded', loadPage);
  })();
</script>
{% endblock %}
