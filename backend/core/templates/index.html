{% extends "base.html" %}

{% block head_extra %}
<style>
  table { border-collapse: collapse; width: 100%; }
  th, td { border: 1px solid #ddd; padding: 8px; vertical-align: top; }
  th { background: #f7f7f7; text-align: left; position: sticky; top: 0; }
  .toolbar { display:flex; justify-content: space-between; align-items: center; margin: 10px 0; gap: 10px; }
  .pager { display:flex; align-items:center; gap:6px; }
  .text-dim { opacity:.7; }         /* do not override .muted from base.html */
  .truncate { max-width: 48ch; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: inline-block; vertical-align: bottom; }
  .hidden { display:none; }
  .title-link { font-weight: 600; text-decoration: none; }
  .title-link:hover { text-decoration: underline; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  /* Reserve space so rows don't jump when pills arrive */
  .col-status { min-width: 26ch; } /* fits "Rejected with Unfortunately" + pill padding */
  /* A subtle private cue on the whole column (matches private-block theme) */
  thead th.th-status { background: linear-gradient(90deg, rgba(124,58,237,.08), #f7f7f7 36px) }
  tbody td.col-status { background: linear-gradient(90deg, rgba(124,58,237,.05), transparent 12px); }
  .chip { border:1px solid #ddd; border-radius:999px; padding:2px 8px; font-size:12px; line-height:20px; }
  .chip.muted { opacity:.75; }
  /* --- Controls for categories / search / filters / sort / pagination --- */
  .tabs { display:flex; gap:8px; margin: 8px 0 12px; flex-wrap:wrap; }
  .tab { padding:6px 12px; border:1px solid #e5e7eb; border-radius:999px; background:#fff; cursor:pointer; }
  .tab.active { background:#111827; color:#fff; border-color:#111827; }
  .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  .input, .select, .button { border:1px solid #e5e7eb; border-radius:8px; padding:8px 10px; background:#fff; }
  .button { cursor:pointer; }
  .list-controls { border:1px solid #e5e7eb; border-radius:12px; background:#fff; padding:10px 12px; margin:12px 0; }
  .filters { border-top:1px dashed #e5e7eb; padding-top:10px; margin-top:8px; }
  .filters-header { display:flex; align-items:center; gap:12px; }
  .chips { display:flex; gap:8px; flex-wrap:wrap; }
  .sort-inline { display:flex; gap:8px; align-items:center; margin-left:auto; }
  .pagination { margin-top:10px; display:flex; justify-content:flex-end; gap:8px; align-items:center; flex-wrap:wrap; color:#111827; }
  .pagination .select { padding:6px 8px; }
  .page-link { padding:2px 6px; border-radius:6px; border:1px solid transparent; cursor:pointer; }
  .page-link.current { border-color:#e5e7eb; font-weight:600; }
  /* Category bar with status left and +Add new right */
  .catsbar { display:flex; justify-content:space-between; align-items:center; gap:12px; margin: 8px 0 8px; }
  .catsbar-left { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .status-ephemeral { font-size:.9rem; color:#6b7280; transition: opacity .35s ease, visibility .35s ease; }
  .status-ephemeral.fade { opacity:0; visibility:hidden; }  
  @media (max-width: 720px) {
    .sort-inline { width:100%; justify-content:flex-end; }
    .pagination { justify-content:center; }
    .catsbar { flex-direction:column; align-items:stretch; gap:8px; }
    .catsbar > a { align-self:flex-end; }    
  }
</style>
{% endblock %}

{% block content %}
  <div style="max-width:1100px; margin:0 auto; padding:16px;">
    <!-- Category bar: tabs + status (left), +Add new (right) -->
    <div class="catsbar">
      <div class="catsbar-left">
        <div class="tabs" role="tablist" aria-label="Categories">
          <button class="tab" data-cat="my"    role="tab" aria-selected="true">My Jobs</button>
          <button class="tab" data-cat="open"  role="tab">Open Opportunities</button>
          <button class="tab active" data-cat="all"  role="tab">All Jobs</button>
        </div>
        <span id="jobs-status" class="status-ephemeral">Loadingâ€¦</span>
      </div>
      <a href="{{ url_for('job_new') }}" class="button">+ Add new</a>
    </div>

    <!-- List controls: Search + Filters (collapsed/expanded) + inline Sort -->
    <div class="list-controls" aria-label="List controls">
      <div class="row" aria-label="Search and sort">
        <input class="input" id="searchText" style="flex:1; min-width:260px;" placeholder="Searchâ€¦" aria-label="Search text" />
        <label class="select" for="searchField">
          <select id="searchField" aria-label="Search field">
            <option value="title_company">Title+Company</option>
            <option value="company">Company</option>
            <option value="title">Title</option>
            <option value="location">Location</option>
            <option value="description">Description</option>
          </select>
        </label>
        <button class="button" id="searchBtn">Search</button>
        <div class="sort-inline" aria-label="Sort">
          <span class="muted">Sort:</span>
          <label class="select" for="sortSelect">
            <select id="sortSelect" aria-label="Sort">
              <option value="created_desc" selected>Created desc</option>
              <option value="updated_desc">Last status update</option>
              <option value="status_progression">Status progression</option>
              <option value="location_az">Location (Aâ†’Z)</option>
              <option value="created_asc">Created asc</option>
              <option value="updated_asc">Last update asc</option>
            </select>
          </label>
        </div>
      </div>
      <!-- Filters (collapsed header) -->
      <div class="filters" aria-label="Filters">
        <div class="filters-header">
          <div class="chips" id="activeChips" aria-label="Active filters">
            <!-- Collapsed chips preview; filled dynamically later -->
            <!-- Example placeholder chips for look & feel: -->
            <!-- <span class="chip">Remote Ã—</span> <span class="chip">HQ: Berlin Ã—</span> -->
          </div>
          <div class="row" style="margin-left:auto;">
            <button class="button" id="filtersExpandBtn" aria-expanded="false">Filters âŒ„</button>
            <button class="button" id="filtersClearBtn">Clear</button>
          </div>
        </div>
        <!-- Expanded filter panel (mock) -->
        <div id="filtersPanel" style="display:none; margin-top:10px;">
          <div class="row" style="gap:16px; align-items:flex-start;">
            <div>
              <div class="muted" style="font-size:12px;">Mode</div>
              <label><input type="checkbox" class="f-mode" value="remote"> Remote</label>
              <label><input type="checkbox" class="f-mode" value="onsite"> Onsite</label>
              <label><input type="checkbox" class="f-mode" value="hybrid"> Hybrid</label>
            </div>
            <div>
              <div class="muted" style="font-size:12px;">Location (city)</div>
              <input class="input" id="f-city" placeholder="e.g. Berlin" style="min-width:180px;">
            </div>
            <div>
              <div class="muted" style="font-size:12px;">Location (country)</div>
              <input class="input" id="f-country" placeholder="e.g. DE or Germany" style="min-width:200px;">
            </div>
            <div>
              <div class="muted" style="font-size:12px;">Ignore status</div>
              <select id="f-ignore" class="select" multiple size="4" style="min-width:220px;">
                <!-- Mocked options; wire later to STATUS_OPTIONS -->
                <option value="applied">Applied</option>
                <option value="screening booked">Screening Booked</option>
                <option value="screening done">Screening Done</option>
                <option value="interview">Interview</option>
                <option value="offer">Got Offer</option>
              </select>
            </div>
            <div style="margin-left:auto; align-self:flex-end;">
              <button class="button" id="filtersApplyBtn">Apply</button>
            </div>
          </div>
        </div>
      </div>
    </div>



    <div id="jobs-error" class="hidden"></div>

    <!-- Cards list -->
    <div id="jobs-list" class="cards" aria-busy="true"></div>

    <!-- Compact bottom pagination -->
    <div class="pagination" id="pagination" aria-label="Pagination">
      <label class="select" for="pageSize">
        <select id="pageSize" aria-label="Items per page">
          <option value="10">10</option>
          <option value="25" selected>25</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
      </label>
      <span id="pageline">of <strong>0</strong> per page:</span>
      <span class="page-link" data-act="first">Â« First</span>
      <span class="page-link" data-act="prev">â€¹ Prev</span>
      <span class="page-link current" data-page="1">1</span>
      <span class="page-link" data-page="2">2</span>
      <span class="page-link" data-page="3">3</span>
      <span class="page-link">â€¦</span>
      <span class="page-link" data-act="last">Last Â»</span>
      <span class="page-link" data-act="next">Next â€º</span>
    </div>    

    <details style="margin-top:16px;">
      <summary><p style="display:inline">Debug: Jobs API</p></summary>
      <pre id="dbg-jobs" class="mono" style="min-height:4rem; opacity:.7">Loadingâ€¦</pre>
    </details>
  </div>

  <script>
  (function(){
    // ---------------------------
    // Tiny time helpers
    // ---------------------------
    const rtf = new Intl.RelativeTimeFormat(undefined, { numeric: 'auto' });
    const dfHM = new Intl.DateTimeFormat(undefined, { hour: '2-digit', minute: '2-digit', hour12: false });
    const dfDM = new Intl.DateTimeFormat(undefined, { day: '2-digit', month: 'short' });
    const dfDMY = new Intl.DateTimeFormat(undefined, { day: '2-digit', month: 'short', year: 'numeric' });

    
    
    function formatWhen(iso) {
      if (!iso) return '';
      const d = new Date(iso);
      if (isNaN(d)) return iso;
      const now = new Date();
      const diffMs = d - now;
      const absMin = Math.abs(diffMs) / 60000;

      if (absMin < 15) return 'just now';
      const sameDay = d.toDateString() === now.toDateString();
      if (sameDay) return dfHM.format(d);

      const absDays = Math.abs(d - now) / 86400000;
      if (absDays < 7) return `${dfDM.format(d)} at ${dfHM.format(d)}`;
      if (d.getFullYear() === now.getFullYear()) return dfDM.format(d);
      return dfDMY.format(d);
    }

    // ---------------------------
    // async data fetch with progressive retry timeout
    // (kept local; base.html has its own for user bar)
    // ---------------------------
    async function fetchWithRetry(url, attempts = 4) {
      let delay = 500; // ms
      for (let i = 1; i <= attempts; i++) {
        try {
          const resp = await fetch(url, { credentials: 'same-origin' });
          if (!resp.ok) throw new Error('HTTP ' + resp.status);
          return await resp.json();
        } catch (err) {
          if (i === attempts) throw err;
          await new Promise(r => setTimeout(r, delay));
          delay *= 2; // 0.5s, 1s, 2s, 4s
        }
      }
    }
    async function postWithRetry(url, body, attempts = 4) {
      let delay = 500;
      for (let i = 1; i <= attempts; i++) {
        try {
          const resp = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify(body)
          });
          if (!resp.ok) throw new Error('HTTP ' + resp.status);
          return await resp.json();
        } catch (err) {
          if (i === attempts) throw err;
          await new Promise(r => setTimeout(r, delay));
          delay *= 2;
        }
      }
    }
    // ---------- DOM refs ----------
    const listEl = document.getElementById('jobs-list');
    const statusEl = document.getElementById('jobs-status');
    const errEl = document.getElementById('jobs-error');
    const dbgJobs = document.getElementById('dbg-jobs');
    const refreshBtn = document.getElementById('refresh');
    const tabs = Array.from(document.querySelectorAll('.tab[data-cat]'));
    const searchFieldSel = document.getElementById('searchField');
    const searchTextEl = document.getElementById('searchText');
    const searchBtn = document.getElementById('searchBtn');
    const sortSel = document.getElementById('sortSelect');
    const pageline = document.getElementById('pageline');
    const pageSizeSel = document.getElementById('pageSize');
    const paginationEl = document.getElementById('pagination');
    // Filters (mock wiring)
    const filtersExpandBtn = document.getElementById('filtersExpandBtn');
    const filtersClearBtn  = document.getElementById('filtersClearBtn');
    const filtersPanel     = document.getElementById('filtersPanel');
    const modeChecks       = Array.from(document.querySelectorAll('.f-mode'));
    const cityInput        = document.getElementById('f-city');
    const countryInput     = document.getElementById('f-country');
    const ignoreSelect     = document.getElementById('f-ignore');
    const filtersApplyBtn  = document.getElementById('filtersApplyBtn');    

    // ---------- Paging state ----------
    let pageSize = Number(sessionStorage.getItem('jobs.pageSize') || 25);
    if (![10,25,50,100].includes(pageSize)) pageSize = 25;

    pageSizeSel.value = String(pageSize);

    let page = 1;             // 1-based
    let total = 0;            // from API
    let currentCategory = 'my'; // default to 'my' for user convinience
    let currentSort = 'created_desc';
    let searchField = 'title_company';
    let searchText = '';
    // Filter state (mocked; wire progressively)
    let modes = [];        // ['remote','onsite','hybrid']
    let cities = [];       // ['Berlin']
    let countries = [];    // ['DE','Germany']
    let ignoreStatuses = [];// ['applied',...]    

    function setStatus(text, {error=false, ephemeral=false} = {}){
      if (!statusEl) return;
      statusEl.classList.remove('fade');
      statusEl.textContent = text;
      if (error) {
        statusEl.style.color = '#9b1c1c'; // subtle red
        return;
      }
      statusEl.style.color = '#6b7280';
      if (ephemeral) {
        // fade out after 5s
        setTimeout(() => statusEl.classList.add('fade'), 5000);
      }
    }
    function setLoading(loading, note='') {
      listEl?.setAttribute('aria-busy', loading ? 'true' : 'false');
      if (loading) {
        errEl?.setAttribute('hidden', 'hidden');
        setStatus(note || 'Loadingâ€¦', {error:false, ephemeral:false});
      }
    }

    function buildApiUrl(){
      const offset = (page - 1) * pageSize;
      const p = new URLSearchParams();
      p.set('category', currentCategory);
      if (searchText) {
        p.set('q', searchText);
        p.set('search_field', searchField);
      }
      p.set('sort', currentSort);
      // Apply filters if present (minimal wiring now: mode, city, country, ignore_status)
      modes.forEach(m => p.append('mode', m));
      cities.forEach(c => p.append('city', c));
      countries.forEach(cn => p.append('country', cn));
      ignoreStatuses.forEach(s => p.append('ignore_status', s));      
      p.set('limit', String(pageSize));
      p.set('offset', String(offset));
      return `/ui/jobs?${p.toString()}`;
    }

    function renderPagination(){
      const lastPage = Math.max(1, Math.ceil(total / pageSize));
      // Build simple window around current page: 1 2 3 ... last
      const nums = [];
      const pushNum = (n) => nums.push(`<span class="page-link ${n===page?'current':''}" data-page="${n}">${n}</span>`);
      const windowSize = 3;
      const start = 1;
      const end = Math.min(lastPage, windowSize);
      for (let n = start; n <= end; n++) pushNum(n);
      if (lastPage > end) {
        nums.push('<span class="page-link">â€¦</span>');
        nums.push(`<span class="page-link" data-page="${lastPage}">${lastPage}</span>`);
      }
      pageline.innerHTML = `of <strong>${total}</strong> per page:`;
      // Replace number links block (between prev/next clusters)
      const parts = [
        // left cluster already in DOM as labeled spans; rebuild whole line for simplicity:
        `<label class="select"><select id="pageSize"><option value="10"${pageSize===10?' selected':''}>10</option><option value="25"${pageSize===25?' selected':''}>25</option><option value="50"${pageSize===50?' selected':''}>50</option><option value="100"${pageSize===100?' selected':''}>100</option></select></label>`,
        `<span id="pageline">of <strong>${total}</strong> per page:</span>`,
        `<span class="page-link" data-act="first">Â« First</span>`,
        `<span class="page-link" data-act="prev">â€¹ Prev</span>`,
        ...nums,
        `<span class="page-link" data-act="next">Next â€º</span>`,
        `<span class="page-link" data-act="last">Last Â»</span>`
      ];
      paginationEl.innerHTML = parts.join('\n');
      // rewire pageSize element after re-render
      const newSel = paginationEl.querySelector('#pageSize');
      newSel.addEventListener('change', () => {
        pageSize = Number(newSel.value);
        sessionStorage.setItem('jobs.pageSize', String(pageSize));
        page = 1;
        loadPage();
      });
    }

    function summarizeLocations(row) {
      const locs = Array.isArray(row.locations) ? row.locations : [];
      const remote = row.RemoteType && row.RemoteType !== 'Unknown' ? row.RemoteType : '';

      if (!locs.length) return remote || '';

      // Group by country (prefer ISO code for compactness)
      const byCountry = new Map(); // key -> Set(cities)
      for (const l of locs) {
        const key = (l.countryCode || '').toUpperCase() || (l.countryName || '').trim();
        const city = (l.cityName || '').trim();
        if (!key) continue;
        if (!byCountry.has(key)) byCountry.set(key, new Set());
        if (city) byCountry.get(key).add(city);
      }

      // Build "DE: Berlin, Munich; ES: Madrid; GB: London"
      const parts = [];
      for (const [country, cities] of byCountry) {
        const cityArr = Array.from(cities);
        const cityStr = cityArr.slice(0, 2).join(", ") + (cityArr.length > 2 ? ", â€¦" : "");
        parts.push(cityArr.length ? `${country}: ${cityStr}` : country);
        if (parts.length >= 4) { parts.push("â€¦"); break; } // keep short
      }
      const geo = parts.join("; ");
      return remote ? `${geo} Â· ${remote}` : geo;
    }

    function displayTitle(row) {
      const t = (row.Title || '').trim();
      if (t) return t;
      const xid = (row.ExternalId || '').trim();
      return xid || '(no title)';
    }

    // ---------- Card rendering ----------
    function cardHTML(row) {
      const title = displayTitle(row);
      const company = row.HiringCompanyName || '';
      const geo = summarizeLocations(row);
      const firstSeen = row.FirstSeenAt || '';
      const sid = `ust_${row.Id}`;
      const via = (row.FoundOn || '').trim();

      const esc = (s) => String(s).replaceAll('"','&quot;');

      return `
        <article class="card" style="padding:12px 16px;">
          <div class="flex-between" style="gap:12px;">
            <div style="min-width:0;">
              <h4 class="truncate-1" style="font-size:18px; margin:0 0 4px 0;">
                <a class="title-link" href="/jobs/${encodeURIComponent(row.Id)}" title="${esc(title)}">${title}</a>
              </h4>
              <div class="flex muted" style="flex-wrap:wrap; font-size:14px; gap:8px;">
                ${company ? `<span class="truncate-1" style="max-width:36ch;" title="${esc(company)}">${company}</span>` : ''}
                ${geo ? `<span class="truncate-1" style="max-width:38ch;" title="${esc(geo)}">${geo}</span>` : ''}
                ${via ? `<span class="chip muted" title="Found on">${esc(via)}</span>` : ''}
              </div>
            </div>
            <div style="text-align:right;">
              <div class="muted" style="font-size:11px; text-transform:uppercase; letter-spacing:.04em;">First seen</div>
              <div style="font-size:14px;">${formatWhen(firstSeen)}</div>
            </div>
          </div>

          <div class="flex" style="margin-top:8px; flex-wrap:wrap; gap:10px; align-items:center;">
            <div class="muted" style="font-size:14px;">Your status</div>
            <span class="chip-private">ðŸ”’ Only you</span>
            <span class="status-slot">
              <span class="status-badge" data-k="unset" id="${sid}">loadingâ€¦</span>
            </span>
          </div>
        </article>
      `;
    }

    function renderCards(items) {
      listEl.innerHTML = items.map(cardHTML).join('');
    }

    async function loadStatusesFor(ids) {
      if (!ids || !ids.length) return;
      try {
        const data = await postWithRetry('/ui/jobs/status', { jobIds: ids }, 4);
        const map = (data && data.statuses) || {};
        for (const id of ids) {
          const el = document.getElementById(`ust_${id}`);
          if (!el) continue;
          const raw = map[id] ?? map[id?.toLowerCase?.()] ?? 'Unset';
          el.textContent = raw || 'Unset';
          el.dataset.k = window.Status.statusKey(raw);
        }
      } catch (e) {
        // graceful degrade
        for (const id of ids) {
          const el = document.getElementById(`ust_${id}`);
          if (!el) continue;
          el.textContent = 'unavailable';
          el.dataset.k = 'unset';
        }
      }
    }

    // ---------- Page load ----------
    async function loadPage() {
      const offset = (page - 1) * pageSize;
      setLoading(true, `Loading page ${page}â€¦`);
      try {
        const url = buildApiUrl();
        const data = await fetchWithRetry(url, 4);
        if (data && !data.error) {
          const items = Array.isArray(data.items) ? data.items : [];
          total = Number(data.total || 0);
          if (dbgJobs) { dbgJobs.style.opacity = 1; dbgJobs.textContent = JSON.stringify(data, null, 2); }

          if (items.length === 0) {
            listEl.innerHTML = `<div class="card" style="padding:12px 16px;"><span class="muted">No data</span></div>`;
            setStatus('Ready', {ephemeral:true});
            renderPagination();
            return;
          }

          renderCards(items);
          setStatus('Ready', {ephemeral:true});
          renderPagination();

          // Fetch statuses asynchronously
          loadStatusesFor(items.map(x => x.Id).filter(Boolean));
        } else {
          throw new Error((data && data.message) || 'Jobs service is warming up');
        }
      } catch (e) {
        console.error('loadPage error', e);
        errEl.style.display = 'block';
        errEl.innerHTML = `
          <span class="text-dim">Jobs unavailable - ${e.message || e}</span>
          <button id="retry-jobs" type="button" style="margin-left:.5rem">Retry</button>
        `;
        document.getElementById('retry-jobs').addEventListener('click', () => {
          errEl.style.display = 'none';
          loadPage();
        });
        setStatus('Failed to load', {error:true, ephemeral:false});
      }
    }

    // ---------- Wiring ----------
    refreshBtn.addEventListener('click', loadPage);

    // Category tabs
    tabs.forEach(btn => {
      btn.addEventListener('click', () => {
        tabs.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentCategory = btn.dataset.cat || 'all';
        page = 1;
        loadPage();
      });
    });

    // Search
    function triggerSearch(){
      searchField = searchFieldSel.value || 'title_company';
      searchText = (searchTextEl.value || '').trim();
      page = 1;
      loadPage();
    }
    searchBtn.addEventListener('click', triggerSearch);
    searchTextEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') triggerSearch();
    });
    searchFieldSel.addEventListener('change', () => {
      // sticky field selection; only reload when query exists
      if ((searchTextEl.value || '').trim()) triggerSearch();
    });

    // Sort
    sortSel.addEventListener('change', () => {
      currentSort = sortSel.value || 'created_desc';
      page = 1;
      loadPage();
    });

    // Filters (mock behavior)
    filtersExpandBtn.addEventListener('click', () => {
      const expanded = filtersExpandBtn.getAttribute('aria-expanded') === 'true';
      filtersExpandBtn.setAttribute('aria-expanded', String(!expanded));
      filtersPanel.style.display = expanded ? 'none' : 'block';
    });
    filtersClearBtn.addEventListener('click', () => {
      // clear local state and inputs
      modes = []; cities = []; countries = []; ignoreStatuses = [];
      modeChecks.forEach(c => c.checked = false);
      cityInput.value = ''; countryInput.value = '';
      for (const opt of ignoreSelect.options) opt.selected = false;
      page = 1;
      triggerSearch(); // reuse apply path
    });
    filtersApplyBtn.addEventListener('click', () => {
      // minimal wiring: collect current UI into state
      modes = modeChecks.filter(c => c.checked).map(c => c.value);
      const cval = (cityInput.value || '').trim();   cities = cval ? [cval] : [];
      const kval = (countryInput.value || '').trim();countries = kval ? [kval] : [];
      ignoreStatuses = Array.from(ignoreSelect.selectedOptions).map(o => o.value);
      page = 1;
      triggerSearch(); // Search acts as Apply
    });

    // Pagination (delegate)
    paginationEl.addEventListener('click', (e) => {
      const t = e.target.closest('.page-link');
      if (!t) return;
      const act = t.getAttribute('data-act');
      const toPageAttr = t.getAttribute('data-page');
      const lastPage = Math.max(1, Math.ceil(total / pageSize));
      if (act === 'first') page = 1;
      else if (act === 'prev') page = Math.max(1, page - 1);
      else if (act === 'next') page = Math.min(lastPage, page + 1);
      else if (act === 'last') page = lastPage;
      else if (toPageAttr) page = Math.max(1, Math.min(lastPage, Number(toPageAttr)));
      else return;
      loadPage();
    });

    document.addEventListener('DOMContentLoaded', loadPage);
  })();
</script>
{% endblock %}
