{% extends "base.html" %}

{% block head_extra %}
<style>
  table { border-collapse: collapse; width: 100%; }
  th, td { border: 1px solid #ddd; padding: 8px; vertical-align: top; }
  th { background: #f7f7f7; text-align: left; position: sticky; top: 0; }
  .toolbar { display:flex; justify-content: space-between; align-items: center; margin: 10px 0; gap: 10px; }
  .pager { display:flex; align-items:center; gap:6px; }
  .text-dim { opacity:.7; }         /* do not override .muted from base.html */
  .truncate { max-width: 48ch; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: inline-block; vertical-align: bottom; }
  .hidden { display:none; }
  .title-link { font-weight: 600; text-decoration: none; }
  .title-link:hover { text-decoration: underline; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  /* Reserve space so rows don't jump when pills arrive */
  .col-status { min-width: 26ch; } /* fits "Rejected with Unfortunately" + pill padding */
  /* A subtle private cue on the whole column (matches private-block theme) */
  thead th.th-status { background: linear-gradient(90deg, rgba(124,58,237,.08), #f7f7f7 36px) }
  tbody td.col-status { background: linear-gradient(90deg, rgba(124,58,237,.05), transparent 12px); }
  .chip { border:1px solid #ddd; border-radius:999px; padding:2px 8px; font-size:12px; line-height:20px; }
  .chip.muted { opacity:.75; }
  /* --- Controls for categories / search / filters / sort / pagination --- */
  .tabs { display:flex; gap:8px; margin: 8px 0 12px; flex-wrap:wrap; }
  .tab { padding:6px 12px; border:1px solid #e5e7eb; border-radius:999px; background:#fff; cursor:pointer; }
  .tab.active { background:#111827; color:#fff; border-color:#111827; }
  .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  .input, .select, .button { border:1px solid #e5e7eb; border-radius:8px; padding:8px 10px; background:#fff; }
  .button { cursor:pointer; }
  .list-controls { border:1px solid #e5e7eb; border-radius:12px; background:#fff; padding:10px 12px; margin:12px 0; }
  .filters { border-top:1px dashed #e5e7eb; padding-top:10px; margin-top:8px; }
  .filters-header { display:flex; align-items:center; gap:12px; }
  .chips { display:flex; gap:8px; flex-wrap:wrap; }
  .sort-inline { display:flex; gap:8px; align-items:center; margin-left:auto; }
  .pagination { margin-top:10px; display:flex; justify-content:flex-end; gap:8px; align-items:center; flex-wrap:wrap; color:#111827; }
  .pagination .select { padding:6px 8px; }
  .page-link { padding:2px 6px; border-radius:6px; border:1px solid transparent; cursor:pointer; }
  .page-link.current { border-color:#e5e7eb; font-weight:600; }
  /* Link-like action buttons (compact, not nav) */
  .linklike { background:none; border:none; padding:0; margin:0 6px; color:#111827; cursor:pointer; text-decoration:underline dotted; }
  .linklike:hover { text-decoration:underline; }
  /* Filters header layout: keep left/right on top row, chips can wrap */
  .filters-header { display:flex; align-items:flex-start; gap:12px; flex-wrap:wrap; }
  .filters-left { display:flex; align-items:center; gap:8px; }
  .filters-right { margin-left:auto; display:flex; gap:8px; align-items:flex-start; }
  .chips { flex:1 1 auto; min-width:200px; }  
  /* Link-like action buttons (compact) */
  .linklike { background:none; border:none; padding:0; margin:0 6px; color:#111827; cursor:pointer; text-decoration:underline dotted; }
  .linklike:hover { text-decoration:underline; }
  .filters-header { display:flex; align-items:flex-start; gap:12px; flex-wrap:wrap; }
  .filters-left { display:flex; align-items:center; gap:8px; }
  .filters-right { margin-left:auto; display:flex; gap:8px; align-items:flex-start; }
  /* Keep left & right controls on top row while chips can wrap below */
  .filters { display:block; }
  .chips { flex:1 1 auto; min-width:200px; }  
  /* Category bar with status left and +Add new right */
  .catsbar { display:flex; justify-content:space-between; align-items:center; gap:12px; margin: 8px 0 8px; }
  .catsbar-left { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .status-ephemeral { font-size:.9rem; color:#6b7280; transition: opacity .35s ease, visibility .35s ease; }
  .status-ephemeral.fade { opacity:0; visibility:hidden; }  
  @media (max-width: 720px) {
    .sort-inline { width:100%; justify-content:flex-end; }
    .pagination { justify-content:center; }
    .catsbar { flex-direction:column; align-items:stretch; gap:8px; }
    .catsbar > a { align-self:flex-end; }    
  }
  /* Option underline tweaks (lighter & clean) */
  .optlist { display:flex; gap:10px; flex-wrap:wrap; max-width:100%; }
  .opt {
    cursor:pointer;
    text-decoration: underline dotted rgba(17,24,39,.35);
    text-underline-offset: 2px;
  }
  .opt:hover { text-decoration-color: rgba(17,24,39,.45); }
  .opt.is-active { color:#6b7280; text-decoration:none; cursor:default; }

  /* Filters grid: label left, values right; stack rows */
  .filters-grid {
    display:grid;
    grid-template-columns: 160px minmax(0,1fr);
    gap:8px 14px;
    align-items:center;
    margin-bottom: 8px;
  }
  .fg-label { font-size:12px; }
  .fg-values { min-width:0; display:flex; align-items:center; flex-wrap:wrap; gap:6px; }
  .fg-sep { grid-column: 1 / -1; border-top:1px dashed #e5e7eb; margin:4px 0; }

  /* inline label preceding a list */
  .inline-label { font-size:12px; }  

  /* Autocomplete dropdowns */
  .ac-wrap { position:relative; }
  .ac-menu {
    position:absolute; left:0; right:0; top: calc(100% + 2px);
    background:#fff; border:1px solid #e5e7eb; border-radius:8px;
    box-shadow: 0 6px 16px rgba(0,0,0,.06);
    z-index: 20; display:none; max-height: 240px; overflow:auto;
  }
  .ac-item { padding:6px 10px; cursor:pointer; }
  .ac-item[aria-selected="true"], .ac-item:hover { background:#f3f4f6; }
  
</style>
{% endblock %}

{% block content %}
  <div style="max-width:1100px; margin:0 auto; padding:16px;">
    <!-- Category bar: tabs + status (left), +Add new (right) -->
    <div class="catsbar">
      <div class="catsbar-left">
        <div class="tabs" role="tablist" aria-label="Categories">
          <button class="tab active" data-cat="my"    role="tab" aria-selected="true">My Jobs</button>
          <button class="tab" data-cat="open"  role="tab">Open Opportunities</button>
          <button class="tab" data-cat="all"   role="tab">All Jobs</button>
        </div>
        <span id="jobs-status" class="status-ephemeral">Loading…</span>
      </div>
    </div>

    <!-- List controls: Search + Filters (collapsed/expanded) + inline Sort -->
    <div class="list-controls" aria-label="List controls">
      <div class="row" aria-label="Search and sort">
        <input class="input" id="searchText" style="flex:1; min-width:260px;" placeholder="Search…" aria-label="Search text" />
        <label class="select" for="searchField">
          <select id="searchField" aria-label="Search field">
            <option value="title_company">Title+Company</option>
            <option value="company">Company</option>
            <option value="title">Title</option>
            <option value="location">Location</option>
            <option value="description">Description</option>
          </select>
        </label>
        <button class="button" id="searchBtn">Search</button>
        <div class="sort-inline" aria-label="Sort">
          <span class="muted">Sort:</span>
          <label class="select" for="sortSelect">
            <select id="sortSelect" aria-label="Sort">
              <option value="created_desc" selected>Created desc</option>
              <option value="updated_desc">Last status update</option>
              <option value="status_progression">Status progression</option>
              <option value="location_az">Location (A→Z)</option>
              <option value="created_asc">Created asc</option>
              <option value="updated_asc">Last update asc</option>
            </select>
          </label>
        </div>
      </div>
      <!-- Filters (collapsed header) -->
      <div class="filters" aria-label="Filters">
        <div class="filters-header">
          <div class="filters-left">
            <a href="#" class="linklike" id="filtersExpandLink" aria-expanded="false">Filters ⌄</a>
          </div>
          <div class="chips" id="activeChips" aria-label="Active filters"></div>
          <div class="filters-right">
            <a href="#" class="linklike" id="filtersClearLink" title="Clear all filters">Clear all</a>
          </div>
        </div>
        <!-- Expanded filter panel (mock) -->
        <div id="filtersPanel" style="display:none; margin-top:10px;">
          <div class="filters-grid">
            <!-- Row 1: Mode -->
            <div class="fg-label muted">Mode</div>
            <div class="fg-values"><div id="optlist-mode" class="optlist"></div></div>

            <!-- separator row (spans both columns) -->
            <div class="fg-sep" aria-hidden="true"></div>

            <!-- Row 2: Ignore status (label inline at the very beginning) -->
            <div class="fg-label muted">Ignore status</div>
            <div class="fg-values">
              <div id="optlist-status" class="optlist"></div>
            </div>
          </div>
            <!-- separator row (spans both columns) -->
            <div class="fg-sep" aria-hidden="true"></div>
          <!-- Locations row in the same grid look -->
          <div class="filters-grid">
            <div class="fg-label muted">Locations</div>
            <div class="fg-values">
              <div class="row" style="gap:10px; position:relative; flex-wrap:wrap;">
                <div class="ac-wrap">
                  <input class="input" id="f-country" placeholder="Country (e.g., Germany)" style="min-width:200px;">
                  <div id="ac-country" class="ac-menu" role="listbox" aria-label="Country suggestions"></div>
                </div>
                <div class="ac-wrap">
                  <input class="input" id="f-city" placeholder="City (e.g., Berlin)" style="min-width:200px;">
                  <div id="ac-city" class="ac-menu" role="listbox" aria-label="City suggestions"></div>
                </div>
                <a href="#" id="geoAddLink" class="opt" style="align-self:center;">add to filters</a>
              </div>
            </div>
          </div>
          <div class="muted" style="font-size:12px; margin-top:6px;">
            Tip: changing country resets city suggestions. Adding with an empty city adds the country.
          </div>
        </div>
      </div>
    </div>



    <div id="jobs-error" class="hidden"></div>

    <!-- Cards list -->
    <div id="jobs-list" class="cards" aria-busy="true"></div>

    <!-- Compact bottom pagination -->
    <div class="pagination" id="pagination" aria-label="Pagination">
      <label class="select" for="pageSize">
        <select id="pageSize" aria-label="Items per page">
          <option value="10">10</option>
          <option value="25" selected>25</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
      </label>
      <span id="pageline">of <strong>0</strong> per page:</span>
      <span class="page-link" data-act="first">« First</span>
      <span class="page-link" data-act="prev">‹ Prev</span>
      <span class="page-link current" data-page="1">1</span>
      <span class="page-link" data-page="2">2</span>
      <span class="page-link" data-page="3">3</span>
      <span class="page-link">…</span>
      <span class="page-link" data-act="last">Last »</span>
      <span class="page-link" data-act="next">Next ›</span>
    </div>    

    <details style="margin-top:16px;">
      <summary><p style="display:inline">Debug: Jobs API</p></summary>
      <pre id="dbg-jobs" class="mono" style="min-height:4rem; opacity:.7">Loading…</pre>
    </details>
  </div>

  <script>
  (function(){
    // ---------------------------
    // Tiny time helpers
    // ---------------------------
    const rtf = new Intl.RelativeTimeFormat(undefined, { numeric: 'auto' });
    const dfHM = new Intl.DateTimeFormat(undefined, { hour: '2-digit', minute: '2-digit', hour12: false });
    const dfDM = new Intl.DateTimeFormat(undefined, { day: '2-digit', month: 'short' });
    const dfDMY = new Intl.DateTimeFormat(undefined, { day: '2-digit', month: 'short', year: 'numeric' });
    
    function formatWhen(iso) {
      if (!iso) return '';
      const d = new Date(iso);
      if (isNaN(d)) return iso;
      const now = new Date();
      const diffMs = d - now;
      const absMin = Math.abs(diffMs) / 60000;

      if (absMin < 15) return 'just now';
      const sameDay = d.toDateString() === now.toDateString();
      if (sameDay) return dfHM.format(d);

      const absDays = Math.abs(d - now) / 86400000;
      if (absDays < 7) return `${dfDM.format(d)} at ${dfHM.format(d)}`;
      if (d.getFullYear() === now.getFullYear()) return dfDM.format(d);
      return dfDMY.format(d);
    }

    // ---------------------------
    // async data fetch with progressive retry timeout
    // (kept local; base.html has its own for user bar)
    // ---------------------------
    async function fetchWithRetry(url, attempts = 4) {
      let delay = 500; // ms
      for (let i = 1; i <= attempts; i++) {
        try {
          const resp = await fetch(url, { credentials: 'same-origin' });
          if (!resp.ok) throw new Error('HTTP ' + resp.status);
          return await resp.json();
        } catch (err) {
          if (i === attempts) throw err;
          await new Promise(r => setTimeout(r, delay));
          delay *= 2; // 0.5s, 1s, 2s, 4s
        }
      }
    }
    async function postWithRetry(url, body, attempts = 4) {
      let delay = 500;
      for (let i = 1; i <= attempts; i++) {
        try {
          const resp = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify(body)
          });
          if (!resp.ok) throw new Error('HTTP ' + resp.status);
          return await resp.json();
        } catch (err) {
          if (i === attempts) throw err;
          await new Promise(r => setTimeout(r, delay));
          delay *= 2;
        }
      }
    }
    // ---------- DOM refs ----------
    const listEl = document.getElementById('jobs-list');
    const statusEl = document.getElementById('jobs-status');
    const errEl = document.getElementById('jobs-error');
    const dbgJobs = document.getElementById('dbg-jobs');
    const tabs = Array.from(document.querySelectorAll('.tab[data-cat]'));
    const searchFieldSel = document.getElementById('searchField');
    const searchTextEl = document.getElementById('searchText');
    const searchBtn = document.getElementById('searchBtn');
    const sortSel = document.getElementById('sortSelect');
    const pageline = document.getElementById('pageline');
    const pageSizeSel = document.getElementById('pageSize');
    const paginationEl = document.getElementById('pagination');
    // Filters (mock wiring)
    const filtersExpandLink = document.getElementById('filtersExpandLink');
    const filtersClearLink  = document.getElementById('filtersClearLink');
    const filtersPanel     = document.getElementById('filtersPanel');
    const activeChips       = document.getElementById('activeChips');
    const cityInput        = document.getElementById('f-city');
    const countryInput     = document.getElementById('f-country');
    const ignoreSelect     = document.getElementById('f-ignore'); 
    // Route URLs we need in JS (server-provided)
    const addNewHref = "{{ url_for('job_new') }}";    
    // For filters' graying out of selected chips
    const optlistMode   = document.getElementById('optlist-mode');
    const optlistStatus = document.getElementById('optlist-status');
    const geoAddLink    = document.getElementById('geoAddLink');    

    // ---------- Paging state ----------
    let pageSize = Number(sessionStorage.getItem('jobs.pageSize') || 25);
    if (![10,25,50,100].includes(pageSize)) pageSize = 25;

    pageSizeSel.value = String(pageSize);

    let page = 1;             // 1-based
    let total = 0;            // from API
    let currentCategory = 'my'; // default to 'my' (URL can override)
    let currentSort = 'created_desc';
    let searchField = 'title_company';
    let searchText = '';
    // Filter state (mocked; wire progressively)
    let modes = [];        // e.g. ['remote','onsite','hybrid']
    let cities = [];       // e.g. ['Berlin', 'Munich']
    let countries = [];    // e.g. ['Germany', 'DE']
    let ignoreStatuses = [];   // exact labels from STATUS_OPTIONS, e.g. ['Screening Done']
    let ignoreStatusesK = [];  // normalized keys via Status.statusKey(label)  
    // Small normalizer for modes, to be used in filters
    const VALID_MODES = ['remote','onsite','hybrid'];
    function normMode(x){ return (x || '').toLowerCase().trim(); }    

    // Small helper used by both the Filters "Clear" link and empty-state CTA
    function doClearFilters(){
      modes = []; cities = []; countries = []; ignoreStatuses = [];
      cityInput.value = '';
      countryInput.value = '';
      for (const opt of ignoreSelect.options) opt.selected = false;
      // clear mock chips too
      document.querySelectorAll('[data-chip]').forEach(el => el.remove());
    }

    // --- URL sync helpers ---
    function paramsFromState(){
      const p = new URLSearchParams();
      p.set('category', currentCategory);
      if (searchText) {
        p.set('q', searchText);
        p.set('search_field', searchField);
      }
      p.set('sort', currentSort);
      modes.forEach(m => p.append('mode', m));
      cities.forEach(c => p.append('city', c));
      countries.forEach(cn => p.append('country', cn));
      ignoreStatuses.forEach(s => p.append('ignore_status', s));
      ignoreStatusesK.forEach(s => p.append('ignore_status_k', s)); // for backend robustness
      p.set('limit', String(pageSize));
      p.set('offset', String((page - 1) * pageSize));
      return p;
    }

    function syncUrl(){
      const p = paramsFromState();
      const newUrl = `${location.pathname}?${p.toString()}`;
      history.replaceState(null, '', newUrl);
    }

    function stateFromUrl(){
      const sp = new URLSearchParams(location.search);
      currentCategory = sp.get('category') || currentCategory;
      currentSort     = sp.get('sort') || currentSort;
      pageSize        = Number(sp.get('limit') || pageSize);
      if (![10,25,50,100].includes(pageSize)) pageSize = 25;
      pageSizeSel.value = String(pageSize);
      const off   = Number(sp.get('offset') || 0);
      page        = Math.max(1, Math.floor(off / pageSize) + 1);
      searchText  = sp.get('q') || '';
      searchField = sp.get('search_field') || searchField;

      // filters
      modes      = sp.getAll('mode').map(normMode).filter(x => VALID_MODES.includes(x));
      cities     = sp.getAll('city').filter(Boolean);
      countries  = sp.getAll('country').filter(Boolean);

      // statuses: prefer labels in URL; fall back to keys -> labels when only _k given
      const lbls = sp.getAll('ignore_status').filter(Boolean);
      const ks   = sp.getAll('ignore_status_k').filter(Boolean);
      let fromK  = [];
      if (lbls.length === 0 && ks.length > 0) {
        // We only have keys; try to back-map using STATUS_OPTIONS by comparing statusKey
        fromK = Status.STATUS_OPTIONS.filter(l => ks.includes(Status.statusKey(l)));
      }
      ignoreStatuses = (lbls.length ? lbls : fromK).filter(Boolean);
      ignoreStatusesK = ignoreStatuses.map((l) => Status.statusKey(l)).filter(Boolean);

      // reflect in UI widgets (we don't clear country/city inputs on reload by design)
      searchTextEl.value = searchText;
      searchFieldSel.value = searchField;
      setActiveTab(currentCategory);
      afterStateChangedRender();
    }

    function setActiveTab(cat){
      tabs.forEach(b => {
        if ((b.dataset.cat || '') === cat) b.classList.add('active');
        else b.classList.remove('active');
      });
    }


    function setStatus(text, {error=false, ephemeral=false} = {}){
      if (!statusEl) return;
      statusEl.classList.remove('fade');
      statusEl.textContent = text;
      if (error) {
        statusEl.style.color = '#9b1c1c'; // subtle red
        return;
      }
      statusEl.style.color = '#6b7280';
      if (ephemeral) {
        // fade out after 5s
        setTimeout(() => statusEl.classList.add('fade'), 5000);
      }
    }
    function setLoading(loading, note='') {
      listEl?.setAttribute('aria-busy', loading ? 'true' : 'false');
      if (loading) {
        errEl?.setAttribute('hidden', 'hidden');
        setStatus(note || 'Loading…', {error:false, ephemeral:false});
      }
    }

    function buildApiUrl(){
      const p = paramsFromState();
      return `/ui/jobs?${p.toString()}`;
    }

    function renderPagination(){
      const lastPage = Math.max(1, Math.ceil(total / pageSize));

      // Compute the numeric page buttons as per spec:
      // - first page: [1(bold), 2]
      // - second page: [1, 2(bold), 3]
      // - last page: [last-1, last(bold)]
      // - general: [page-1, page(bold), page+1]
      let pages = [];
      if (lastPage === 1) {
        pages = [1];
      } else if (page <= 1) {
        pages = [1, 2].filter(n => n <= lastPage);
      } else if (page >= lastPage) {
        pages = [lastPage - 1, lastPage].filter(n => n >= 1);
      } else {
        pages = [page - 1, page, page + 1];
      }

      // build the numeric links
      const nums = pages.map(n =>
        `<span class="page-link ${n===page ? 'current' : ''}" data-page="${n}" aria-label="Page ${n}" ${n===page ? 'aria-current="page"' : ''}>${n}</span>`
      );

      // rewrite the whole control (keeps arrows always visible)
      const parts = [
        `<label class="select"><select id="pageSize">
            <option value="10"${pageSize===10?' selected':''}>10</option>
            <option value="25"${pageSize===25?' selected':''}>25</option>
            <option value="50"${pageSize===50?' selected':''}>50</option>
            <option value="100"${pageSize===100?' selected':''}>100</option>
          </select></label>`,
        `<span id="pageline">of <strong>${total}</strong> per page:</span>`,
        `<span class="page-link" data-act="first">« First</span>`,
        `<span class="page-link" data-act="prev">‹ Prev</span>`,
        ...nums,
        `<span class="page-link" data-act="next">Next ›</span>`,
        `<span class="page-link" data-act="last">Last »</span>`
      ];

      paginationEl.innerHTML = parts.join('\n');

      // re-bind page size change handler after re-render
      const newSel = paginationEl.querySelector('#pageSize');
      newSel.addEventListener('change', () => {
        pageSize = Number(newSel.value);
        sessionStorage.setItem('jobs.pageSize', String(pageSize));
        page = 1;
        loadPage();
      });

      // keep the summary text ("of N per page:") in sync as well
      const pl = paginationEl.querySelector('#pageline');
      if (pl) pl.innerHTML = `of <strong>${total}</strong> per page:`;
    }

    // ---------- Empty states ----------
    function renderEmptyMyOnboard(){
      listEl.innerHTML = `
        <div class="card" style="padding:16px;">
          <h4 style="margin:0 0 6px 0;">No personal jobs yet</h4>
          <p class="muted" style="margin:0 0 10px 0;">
            Looks like you don’t have anything in <em>My Jobs</em> yet. This tool helps you track applications, statuses, notes—
            and later we’ll add CV matching and interview pointers.
          </p>
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <a class="button" href="${addNewHref}">+ Add a job</a>
            <a class="button" href="#" id="cta-browse-open">Browse open opportunities</a>
          </div>
          <p class="muted" style="margin:10px 0 0 0; font-size:0.95rem;">
            Tip: you can update statuses from your phone via our Telegram bot once linked.
          </p>
        </div>
      `;
      const browse = document.getElementById('cta-browse-open');
      if (browse) {
        browse.addEventListener('click', (e) => {
          e.preventDefault();
          currentCategory = 'open';
          setActiveTab('open');
          page = 1;
          loadPage();
        });
      }
    }

    function renderModeOptions(){
      const active = new Set(modes);
      const html = VALID_MODES.map(m => {
        const label = m[0].toUpperCase() + m.slice(1);
        const activeCls = active.has(m) ? 'is-active' : '';
        return `<span class="opt ${activeCls}" data-opt="mode" data-val="${m}">${label}</span>`;
      }).join(' ');
      optlistMode.innerHTML = html;
    }

    function renderStatusOptions(){
      const active = new Set(ignoreStatuses);
      const html = Status.STATUS_OPTIONS.map(label => {
        const isActive = active.has(label);
        return `<span class="opt ${isActive ? 'is-active':''}" data-opt="status" data-val="${label}">${label}</span>`;
      }).join(' ');
      optlistStatus.innerHTML = html;
    }


    function renderEmptyGeneric(){
      listEl.innerHTML = `
        <div class="card" style="padding:16px;">
          <h4 style="margin:0 0 6px 0;">Nothing matched</h4>
          <p class="muted" style="margin:0 0 10px 0;">
            Try relaxing your search, clearing filters, or add the job manually if you know it.
            Heads-up: finalized jobs only appear in <strong>All Jobs</strong>.
          </p>
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <a class="button" href="#" id="cta-clear-filters">Clear filters</a>
            <a class="button" href="${addNewHref}">+ Add a job</a>
          </div>
        </div>
      `;
      const clear = document.getElementById('cta-clear-filters');
      if (clear) {
        clear.addEventListener('click', (e) => {
          e.preventDefault();
          doClearFilters();
          page = 1;
          loadPage();
        });
      }
    }

    function summarizeLocations(row) {
      const locs = Array.isArray(row.locations) ? row.locations : [];
      const remote = row.RemoteType && row.RemoteType !== 'Unknown' ? row.RemoteType : '';

      if (!locs.length) return `·&nbsp&nbsp${remote}` || '';

      // Group by country (prefer ISO code for compactness)
      const byCountry = new Map(); // key -> Set(cities)
      for (const l of locs) {
        const key = (l.countryCode || '').toUpperCase() || (l.countryName || '').trim();
        const city = (l.cityName || '').trim();
        if (!key) continue;
        if (!byCountry.has(key)) byCountry.set(key, new Set());
        if (city) byCountry.get(key).add(city);
      }

      // Build "DE: Berlin, Munich; ES: Madrid; GB: London"
      const parts = [];
      for (const [country, cities] of byCountry) {
        const cityArr = Array.from(cities);
        const cityStr = cityArr.slice(0, 2).join(", ") + (cityArr.length > 2 ? ", …" : "");
        parts.push(cityArr.length ? `${country}: ${cityStr}` : country);
        if (parts.length >= 4) { parts.push("…"); break; } // keep short
      }
      const geo = parts.join("; ");
      return remote ? `·&nbsp&nbsp${geo} · ${remote}` : `·&nbsp&nbsp${geo}`;
    }

    function displayTitle(row) {
      const t = (row.Title || '').trim();
      if (t) return t;
      const xid = (row.ExternalId || '').trim();
      return xid || '(no title)';
    }

    function extractCompanyParts(row){
      const company = (row.HiringCompanyName || '').trim();
      const posting = (row.PostingCompanyName || row.AgencyName || row.PostingCompany || '').trim();
      return { company, posting };
    }
    function companyLineFromRow(row) {
      const { company, posting } = extractCompanyParts(row);
      if (posting) return company ? `${company}, through ${posting}` : `through ${posting}`;
      return company || '';
    }

    // ---------- Card rendering ----------
    function cardHTML(row) {
      const title = displayTitle(row);
      const { company, posting } = extractCompanyParts(row);
      const companyLine = company && posting ? `<b>${company}</b>, through <b>${posting}</b>` : (`<b>${company}</b>` || (posting ? `through <b>${posting}</b>` : ''));
          
      const geo = summarizeLocations(row);
      const firstSeen = row.FirstSeenAt || row.CreatedAt || row.LastUpdateAt || '';
      const sid = `ust_${row.Id}`;
      const via = (row.FoundOn || '').trim();

      const esc = (s) => String(s).replaceAll('"','&quot;');

      return `
        <article class="card" style="padding:12px 16px;">
          <div class="flex-between" style="gap:12px;">
            <div style="min-width:0;">
              <h4 class="truncate-1" style="font-size:18px; margin:0 0 4px 0;">
                <a class="title-link" href="/jobs/${encodeURIComponent(row.Id)}" title="${esc(title)}">${title}</a>
              </h4>
              <div class="flex muted" style="flex-wrap:wrap; font-size:14px; gap:8px;">
                ${companyLine ? `<span class="truncate-1" style="max-width:36ch;" title="${esc(companyLine)}">${companyLine}</span>` : ''}
                ${geo ? `<span class="truncate-1" style="max-width:38ch;" title="${esc(geo)}">${geo}</span>` : ''}
                ${via ? `<span class="chip muted" title="Found on">${esc(via)}</span>` : ''}
              </div>
            </div>
            <div style="text-align:right;">
              <div class="muted" style="font-size:11px; text-transform:uppercase; letter-spacing:.04em;">First seen</div>
              <div style="font-size:14px;">${formatWhen(firstSeen)}</div>
            </div>
          </div>

          <div class="flex" style="margin-top:8px; flex-wrap:wrap; gap:10px; align-items:center;">
            <div class="muted" style="font-size:14px;"> 🔒 Your status</div>
            <span class="status-slot">
              <span class="status-badge" data-k="unset" id="${sid}">loading…</span>
            </span>
          </div>
        </article>
      `;
    }

    function renderCards(items) {
      listEl.innerHTML = items.map(cardHTML).join('');
    }

    function renderChips(){
      const parts = [];

      // Mode chips
      for (const m of modes) {
        const label = m[0].toUpperCase() + m.slice(1);
        parts.push(`<span class="chip" data-chip="mode" data-val="${m}">Mode: ${label} <span aria-hidden="true">×</span></span>`);
      }

      // Countries
      for (const c of countries) {
        parts.push(`<span class="chip" data-chip="country" data-val="${c}">Country: ${escapeHtml(c)} <span aria-hidden="true">×</span></span>`);
      }

      // Cities
      for (const c of cities) {
        parts.push(`<span class="chip" data-chip="city" data-val="${c}">City: ${escapeHtml(c)} <span aria-hidden="true">×</span></span>`);
      }

      // Ignore statuses (one chip per label)
      for (const s of ignoreStatuses) {
        parts.push(`<span class="chip" data-chip="ignore_status" data-val="${escapeHtml(s)}">Ignore: ${escapeHtml(s)} <span aria-hidden="true">×</span></span>`);
      }

      activeChips.innerHTML = parts.join(' ');
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    activeChips.addEventListener('click', (e) => {
      const chip = e.target.closest('.chip[data-chip]');
      if (!chip) return;
      const type = chip.dataset.chip;
      const val  = chip.dataset.val;

      const removeFrom = (arr, v) => {
        const i = arr.indexOf(v);
        if (i >= 0) arr.splice(i,1);
      };

      if (type === 'mode') removeFrom(modes, val);
      else if (type === 'country') removeFrom(countries, val);
      else if (type === 'city') removeFrom(cities, val);
      else if (type === 'ignore_status') {
        removeFrom(ignoreStatuses, val);
        ignoreStatusesK = ignoreStatuses.map(l => Status.statusKey(l)).filter(Boolean);
      }

      page = 1;
      loadPage();
    });

    function afterStateChangedRender(){
      renderChips();
      renderModeOptions();
      renderStatusOptions();
    }

    async function loadStatusesFor(ids) {
      if (!ids || !ids.length) return;
      try {
        const data = await postWithRetry('/ui/jobs/status', { jobIds: ids }, 4);
        const map = (data && data.statuses) || {};
        for (const id of ids) {
          const el = document.getElementById(`ust_${id}`);
          if (!el) continue;
          const raw = map[id] ?? map[id?.toLowerCase?.()] ?? 'Unset';
          el.textContent = raw || 'Unset';
          el.dataset.k = window.Status.statusKey(raw);
        }
      } catch (e) {
        // graceful degrade
        for (const id of ids) {
          const el = document.getElementById(`ust_${id}`);
          if (!el) continue;
          el.textContent = 'unavailable';
          el.dataset.k = 'unset';
        }
      }
    }

    // ---------- Page load ----------
    async function loadPage() {
      const offset = (page - 1) * pageSize;
      setLoading(true, `Loading page ${page}…`);
      try {
        const url = buildApiUrl();
        syncUrl();
        const data = await fetchWithRetry(url, 4);
        if (data && !data.error) {
          const items = Array.isArray(data.items) ? data.items : [];
          total = Number(data.total || 0);
          if (dbgJobs) { dbgJobs.style.opacity = 1; dbgJobs.textContent = JSON.stringify(data, null, 2); }

          if (items.length === 0) {
            const defaultFilters =
              !searchText &&
              (!modes || modes.length === 0) &&
              (!cities || cities.length === 0) &&
              (!countries || countries.length === 0) &&
              (!ignoreStatuses || ignoreStatuses.length === 0);
            if (currentCategory === 'my' && defaultFilters) {
              renderEmptyMyOnboard();
            } else {
              renderEmptyGeneric();
            }
            setStatus('Ready', {ephemeral:true});
            renderPagination();
            afterStateChangedRender();
            return;
          }

          renderCards(items);
          afterStateChangedRender();
          setStatus('Ready', {ephemeral:true});
          renderPagination();

          // Fetch statuses asynchronously
          loadStatusesFor(items.map(x => x.Id).filter(Boolean));
        } else {
          throw new Error((data && data.message) || 'Jobs service is warming up');
        }
      } catch (e) {
        console.error('loadPage error', e);
        errEl.style.display = 'block';
        errEl.innerHTML = `
          <span class="text-dim">Jobs unavailable - ${e.message || e}</span>
          <button id="retry-jobs" type="button" style="margin-left:.5rem">Retry</button>
        `;
        document.getElementById('retry-jobs').addEventListener('click', () => {
          errEl.style.display = 'none';
          loadPage();
        });
        setStatus('Failed to load', {error:true, ephemeral:false});
      }
    }

    // ---------- Wiring ----------
    // Category tabs
    tabs.forEach(btn => {
      btn.addEventListener('click', () => {
        tabs.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentCategory = btn.dataset.cat || 'all';
        page = 1;
        loadPage();
      });
    });

    // Search
    function triggerSearch(){
      searchField = searchFieldSel.value || 'title_company';
      searchText = (searchTextEl.value || '').trim();
      page = 1;
      loadPage();
    }
    searchBtn.addEventListener('click', triggerSearch);
    searchTextEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') triggerSearch();
    });
    searchFieldSel.addEventListener('change', () => {
      // sticky field selection; only reload when query exists
      if ((searchTextEl.value || '').trim()) triggerSearch();
    });

    // Sort
    sortSel.addEventListener('change', () => {
      currentSort = sortSel.value || 'created_desc';
      page = 1;
      loadPage();
    });

    // Filters (mock behavior)
    filtersExpandLink.addEventListener('click', (e) => {
      e.preventDefault();
      const expanded = filtersExpandLink.getAttribute('aria-expanded') === 'true';
      filtersExpandLink.setAttribute('aria-expanded', String(!expanded));
      filtersPanel.style.display = expanded ? 'none' : 'block';
    });

    filtersClearLink.addEventListener('click', (e) => {
      e.preventDefault();
      modes = []; cities = []; countries = []; ignoreStatuses = []; ignoreStatusesK = [];
      // Do NOT clear the country/city inputs on reload (per spec)
      page = 1;
      loadPage();
    });

    // Pagination (delegate)
    paginationEl.addEventListener('click', (e) => {
      const t = e.target.closest('.page-link');
      if (!t) return;
      const act = t.getAttribute('data-act');
      const toPageAttr = t.getAttribute('data-page');
      const lastPage = Math.max(1, Math.ceil(total / pageSize));
      if (act === 'first') page = 1;
      else if (act === 'prev') page = Math.max(1, page - 1);
      else if (act === 'next') page = Math.min(lastPage, page + 1);
      else if (act === 'last') page = lastPage;
      else if (toPageAttr) page = Math.max(1, Math.min(lastPage, Number(toPageAttr)));
      else return;
      loadPage();
    });


    optlistMode.addEventListener('click', (e) => {
      const t = e.target.closest('.opt[data-opt="mode"]');
      if (!t || t.classList.contains('is-active')) return;
      const val = normMode(t.dataset.val);
      if (VALID_MODES.includes(val) && !modes.includes(val)) {
        modes.push(val);
        page = 1;
        loadPage(); // will rebuild URL + chips + options
      }
    });

    optlistStatus.addEventListener('click', (e) => {
      const t = e.target.closest('.opt[data-opt="status"]');
      if (!t || t.classList.contains('is-active')) return;
      const lbl = t.dataset.val;
      if (lbl && !ignoreStatuses.includes(lbl)) {
        ignoreStatuses.push(lbl);
        ignoreStatusesK = ignoreStatuses.map(l => Status.statusKey(l)).filter(Boolean);
        page = 1;
        loadPage();
      }
    });    


    geoAddLink.addEventListener('click', (e) => {
      e.preventDefault();
      const ctry = (countryInput.value || '').trim();
      const city = (cityInput.value || '').trim();
      // If both empty: do nothing
      if (!ctry && !city) return;

      // If country provided and not already present, add it
      if (ctry && !countries.includes(ctry)) countries.push(ctry);

      // City adds independently (OR semantics); avoid duplicates
      if (city && !cities.includes(city)) cities.push(city);

      // Clear both fields (per spec)
      countryInput.value = '';
      cityInput.value = '';
      page = 1;
      loadPage();
    });    

    document.addEventListener('DOMContentLoaded', () => {
      stateFromUrl();   // deep-link support
      syncUrl();        // write defaults if nothing present
      loadPage();
    });
  })();
</script>

<script type="module">
import { loadGeoDict, countryMatches, countryLookup, citiesByCountry } from "{{ url_for('static', filename='js/geo-dict.js') }}";

const countryInput = document.getElementById('f-country');
const cityInput    = document.getElementById('f-city');
const acCountry    = document.getElementById('ac-country');
const acCity       = document.getElementById('ac-city');

await loadGeoDict();

// Internal selection cache: show country NAME in the input, keep CODE for city lookups
let selectedCountry = { name: '', code: '' };

// ---------- Utilities ----------
function show(el){ if (el) el.style.display = 'block'; }
function hide(el){ if (el) el.style.display = 'none'; }
function clear(el){ if (el) el.innerHTML = ''; }
function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }

// Close menus on outside click
document.addEventListener('mousedown', (e) => {
  if (!acCountry.contains(e.target) && e.target !== countryInput) hide(acCountry);
  if (!acCity.contains(e.target) && e.target !== cityInput) hide(acCity);
});

// ---------- Country autocomplete ----------
let cIdx = -1;

function renderCountryMenu(items) {
  if (!items.length) { hide(acCountry); clear(acCountry); return; }
  acCountry.innerHTML = items.slice(0, 20).map((c, i) =>
    `<div class="ac-item" role="option" data-cc="${c.code}" data-name="${c.name}" aria-selected="${i===cIdx?'true':'false'}">${c.name} (${c.code})</div>`
  ).join('');
  show(acCountry);
}

function pickCountry(name, code) {
  selectedCountry = { name, code };
  countryInput.value = name; // NAME ONLY for backend
  cityInput.value = '';      // reset city when country changes
  hide(acCountry); clear(acCountry);
  // Prime city suggestions for the new country if user starts typing immediately
  const pool = code ? citiesByCountry(code) : [];
  if ((cityInput.value || '').trim()) renderCityMenu(pool); else { hide(acCity); clear(acCity); }
  // Move focus to city for quick flow
  cityInput.focus();
}

countryInput.addEventListener('input', () => {
  const q = (countryInput.value || '').trim();
  cIdx = -1;
  // While typing, selection is tentative
  selectedCountry = { name:'', code:'' };
  if (!q) { hide(acCountry); clear(acCountry); return; }
  renderCountryMenu(countryMatches(q));
});

countryInput.addEventListener('keydown', (e) => {
  const items = Array.from(acCountry.querySelectorAll('.ac-item'));
  if (!items.length) return;
  if (e.key === 'ArrowDown') {
    e.preventDefault();
    cIdx = clamp(cIdx + 1, 0, items.length - 1);
    // Re-flag selected item
    items.forEach((el, i) => el.setAttribute('aria-selected', String(i===cIdx)));
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    cIdx = clamp(cIdx - 1, 0, items.length - 1);
    items.forEach((el, i) => el.setAttribute('aria-selected', String(i===cIdx)));
  } else if (e.key === 'Enter') {
    e.preventDefault();
    const el = items[clamp(cIdx, 0, items.length - 1)];
    if (el) pickCountry(el.dataset.name, el.dataset.cc);
  } else if (e.key === 'Escape') {
    hide(acCountry);
  }
});

acCountry.addEventListener('mousedown', (e) => {
  const it = e.target.closest('.ac-item'); if (!it) return;
  pickCountry(it.dataset.name, it.dataset.cc);
});

// On blur: if unambiguous, autocomplete to canonical name
countryInput.addEventListener('blur', () => {
  const c = countryLookup(countryInput.value);
  if (c) pickCountry(c.name, c.code);
  else { hide(acCountry); }
});

// ---------- City autocomplete (dependent on selectedCountry.code) ----------
let cityIdx = -1;

function renderCityMenu(allCities) {
  const q = (cityInput.value || '').trim().toLowerCase();
  if (!q) { hide(acCity); clear(acCity); return; }
  const items = allCities.filter(n => n.toLowerCase().startsWith(q)).slice(0, 30);
  if (!items.length) { hide(acCity); clear(acCity); return; }
  acCity.innerHTML = items.map((name, i) =>
    `<div class="ac-item" role="option" data-name="${name}" aria-selected="${i===cityIdx?'true':'false'}">${name}</div>`
  ).join('');
  show(acCity);
}

cityInput.addEventListener('input', () => {
  cityIdx = -1;
  const pool = selectedCountry.code ? citiesByCountry(selectedCountry.code) : [];
  renderCityMenu(pool);
});

cityInput.addEventListener('keydown', (e) => {
  const items = Array.from(acCity.querySelectorAll('.ac-item'));
  if (!items.length) return;
  if (e.key === 'ArrowDown') {
    e.preventDefault();
    cityIdx = clamp(cityIdx + 1, 0, items.length - 1);
    items.forEach((el, i) => el.setAttribute('aria-selected', String(i===cityIdx)));
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    cityIdx = clamp(cityIdx - 1, 0, items.length - 1);
    items.forEach((el, i) => el.setAttribute('aria-selected', String(i===cityIdx)));
  } else if (e.key === 'Enter') {
    e.preventDefault();
    const el = items[clamp(cityIdx, 0, items.length - 1)];
    if (el) { cityInput.value = el.dataset.name; hide(acCity); clear(acCity); }
  } else if (e.key === 'Escape') {
    hide(acCity);
  }
});

acCity.addEventListener('mousedown', (e) => {
  const it = e.target.closest('.ac-item'); if (!it) return;
  cityInput.value = it.dataset.name;
  hide(acCity); clear(acCity);
});

// On blur: close quietly (keep whatever the user typed)
cityInput.addEventListener('blur', () => { hide(acCity); });

// (Optional) if country is already filled from URL when the page loads,
// try to resolve it to a known country so city suggestions work immediately.
(function bootstrapSelectedCountryFromInput(){
  const name = (countryInput?.value || '').trim();
  if (!name) return;
  const c = countryLookup(name);
  if (c) selectedCountry = { name: c.name, code: c.code };
})();
</script>


{% endblock %}
