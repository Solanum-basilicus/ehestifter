{% extends "base.html" %}

{% block head_extra %}
<style>
  table { border-collapse: collapse; width: 100%; }
  th, td { border: 1px solid #ddd; padding: 8px; vertical-align: top; }
  th { background: #f7f7f7; text-align: left; position: sticky; top: 0; }
  .toolbar { display:flex; justify-content: space-between; align-items: center; margin: 10px 0; gap: 10px; }
  .pager { display:flex; align-items:center; gap:6px; }
  .text-dim { opacity:.7; }         /* do not override .muted from base.html */
  .truncate { max-width: 48ch; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: inline-block; vertical-align: bottom; }
  .hidden { display:none; }
  .title-link { font-weight: 600; text-decoration: none; }
  .title-link:hover { text-decoration: underline; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
</style>
{% endblock %}

{% block content %}
  <div style="max-width:1100px; margin:0 auto; padding:16px;">
    <h2 style="margin:0 0 12px;">Welcome to {{ title }}, {{ user.get("name") }}!</h2>

    <h3 style="display:flex; align-items:center; gap:10px; margin: 14px 0;">
      Job offerings
      <a href="{{ url_for('job_new') }}"
        style="font-size:.95rem; padding:6px 10px; border:1px solid #bbb; border-radius:6px; text-decoration:none;">
        + Add offering
      </a>
    </h3>

    <div class="toolbar">
      <div>
        <label for="page-size">Rows per page:</label>
        <select id="page-size">
          <option value="10">10</option>
          <option value="25" selected>25</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
        <span class="text-dim" id="jobs-status">Loading…</span>
      </div>
      <div class="pager">
        <button id="prev" disabled>&larr; Prev</button>
        <span class="nowrap">Page <span id="page-num">1</span></span>
        <button id="next" disabled>Next &rarr;</button>
        <button id="refresh">Refresh</button>
      </div>
    </div>

    <div id="jobs-error" class="hidden"></div>

    <div style="overflow:auto">
      <table id="jobs-table">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>

    <details style="margin-top:16px;">
      <summary><p style="display:inline">Debug: Jobs API</p></summary>
      <pre id="dbg-jobs" class="mono" style="min-height:4rem; opacity:.7">Loading…</pre>
    </details>
  </div>

  <script>
  (function(){
    // ---------------------------
    // Tiny time helpers
    // ---------------------------
    const rtf = new Intl.RelativeTimeFormat(undefined, { numeric: 'auto' });
    const dfHM = new Intl.DateTimeFormat(undefined, { hour: '2-digit', minute: '2-digit', hour12: false });
    const dfDM = new Intl.DateTimeFormat(undefined, { day: '2-digit', month: 'short' });
    const dfDMY = new Intl.DateTimeFormat(undefined, { day: '2-digit', month: 'short', year: 'numeric' });

    function formatWhen(iso) {
      if (!iso) return '';
      const d = new Date(iso);
      if (isNaN(d)) return iso;
      const now = new Date();
      const diffMs = d - now;
      const absMin = Math.abs(diffMs) / 60000;

      if (absMin < 15) return 'just now';
      const sameDay = d.toDateString() === now.toDateString();
      if (sameDay) return dfHM.format(d);

      const absDays = Math.abs(d - now) / 86400000;
      if (absDays < 7) return `${dfDM.format(d)} at ${dfHM.format(d)}`;
      if (d.getFullYear() === now.getFullYear()) return dfDM.format(d);
      return dfDMY.format(d);
    }

    // ---------------------------
    // async data fetch with progressive retry timeout
    // (kept local; base.html has its own for user bar)
    // ---------------------------
    async function fetchWithRetry(url, attempts = 4) {
      let delay = 500; // ms
      for (let i = 1; i <= attempts; i++) {
        try {
          const resp = await fetch(url, { credentials: 'same-origin' });
          if (!resp.ok) throw new Error('HTTP ' + resp.status);
          return await resp.json();
        } catch (err) {
          if (i === attempts) throw err;
          await new Promise(r => setTimeout(r, delay));
          delay *= 2; // 0.5s, 1s, 2s, 4s
        }
      }
    }

    // ---------------------------
    // Jobs table
    // ---------------------------
    const TBL = document.getElementById('jobs-table');
    const THEAD = TBL.querySelector('thead');
    const TBODY = TBL.querySelector('tbody');
    const statusEl = document.getElementById('jobs-status');
    const errEl = document.getElementById('jobs-error');
    const dbgJobs = document.getElementById('dbg-jobs');
    const pageSizeSel = document.getElementById('page-size');
    const prevBtn = document.getElementById('prev');
    const nextBtn = document.getElementById('next');
    const refreshBtn = document.getElementById('refresh');
    const pageNumEl = document.getElementById('page-num');

    let pageSize = Number(sessionStorage.getItem('jobs.pageSize') || 25);
    if (![10,25,50,100].includes(pageSize)) pageSize = 25;
    pageSizeSel.value = String(pageSize);

    let page = 1; // 1-based
    let lastReceived = 0;

    const COLS = [
      { key: 'Title', label: 'Title' },
      { key: 'HiringCompanyName', label: 'Company' },
      { key: 'RemoteType', label: 'Remote' },
      { key: 'Location', label: 'Location' },   // virtual: Country (Locality)
      { key: 'FirstSeenAt', label: 'First Seen At' }
    ];

    function buildHeader() {
      THEAD.innerHTML = '';
      const tr = document.createElement('tr');
      for (const c of COLS) {
        const th = document.createElement('th');
        th.textContent = c.label;
        tr.appendChild(th);
      }
      THEAD.appendChild(tr);
    }

    function locationFrom(row) {
      const country = row.Country || '';
      const loc = row.Locality || '';
      if (!country && !loc) return '';
      if (country && !loc) return country;
      if (!country && loc) return loc;
      return `${country} (${loc})`;
    }

    function tdTitle(row) {
      const td = document.createElement('td');
      const a = document.createElement('a');
      a.className = 'title-link';
      a.href = `/jobs/${encodeURIComponent(row.Id)}`;
      a.textContent = row.Title || '(no title)';
      td.appendChild(a);
      return td;
    }

    function tdText(text) {
      const td = document.createElement('td');
      if (typeof text === 'string' && text.length > 200) {
        td.innerHTML = `<span class="truncate" title="${text.replaceAll('"','&quot;')}">${text}</span>`;
      } else {
        td.textContent = text || '';
      }
      return td;
    }

    function tdWhen(iso) {
      const td = document.createElement('td');
      td.dataset.iso = iso || ''; // keep ISO available for later sorting/filtering
      td.textContent = formatWhen(iso);
      return td;
    }

    function buildRows(items) {
      TBODY.innerHTML = '';
      for (const row of items) {
        const tr = document.createElement('tr');
        tr.appendChild(tdTitle(row));
        tr.appendChild(tdText(row.HiringCompanyName || ''));
        tr.appendChild(tdText(row.RemoteType || ''));
        tr.appendChild(tdText(locationFrom(row)));
        tr.appendChild(tdWhen(row.FirstSeenAt || row.PostedDate || ''));
        TBODY.appendChild(tr);
      }
    }

    function setLoading(loading, note='') {
      if (loading) {
        statusEl.textContent = note || 'Loading…';
        errEl?.classList.add('hidden');
      } else {
        statusEl.textContent = note || `Showing ${lastReceived} row(s)`;
      }
    }

    function setPagerState() {
      pageNumEl.textContent = String(page);
      prevBtn.disabled = page <= 1;
      nextBtn.disabled = lastReceived < pageSize;
    }

    async function loadPage() {
      const offset = (page - 1) * pageSize;
      setLoading(true, `Loading page ${page}…`);
      try {
        const url = `/ui/jobs?limit=${pageSize}&offset=${offset}`;
        const data = await fetchWithRetry(url, 4);
        if (data && !data.error) {
          const items = Array.isArray(data.items) ? data.items : [];
          lastReceived = data.received || items.length;
          if (dbgJobs) { dbgJobs.style.opacity = 1; dbgJobs.textContent = JSON.stringify(data, null, 2); }

          buildHeader();
          if (items.length === 0) {
            TBODY.innerHTML = `<tr><td class="text-dim" colspan="${COLS.length}">No data</td></tr>`;
            setLoading(false, 'No rows');
            setPagerState();
            return;
          }

          buildRows(items);
          setLoading(false);
          setPagerState();
        } else {
          throw new Error((data && data.message) || 'Jobs service is warming up');
        }
      } catch (e) {
        console.error('loadPage error', e);
        if (errEl) {
          errEl.classList.remove('hidden');
          errEl.innerHTML = `
            <span class="text-dim">Jobs unavailable - ${e.message || e}</span>
            <button id="retry-jobs" type="button" style="margin-left:.5rem">Retry</button>
          `;
          document.getElementById('retry-jobs').addEventListener('click', () => {
            errEl.classList.add('hidden');
            loadPage();
          });
        }
        setLoading(false, 'Failed to load');
      }
    }

    pageSizeSel.addEventListener('change', () => {
      pageSize = Number(pageSizeSel.value);
      sessionStorage.setItem('jobs.pageSize', String(pageSize));
      page = 1;
      loadPage();
    });

    prevBtn.addEventListener('click', () => { if (page > 1) { page -= 1; loadPage(); } });
    nextBtn.addEventListener('click', () => { if (!nextBtn.disabled) { page += 1; loadPage(); } });
    refreshBtn.addEventListener('click', loadPage);

    // single init (user bar handled by base.html)
    document.addEventListener('DOMContentLoaded', loadPage);
  })();
  </script>
{% endblock %}
