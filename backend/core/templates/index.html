<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ title }}</title>
</head>
<body>
  <h2>Welcome to Ehestifter, {{ user.get("name") }}!</h2>

  <div id="user-bar" style="text-align: right; padding: 10px;">
    <span id="user-link" style="opacity:.6">Loading user…</span>
    <p>Updated at: {{ now }}</p>
    <a href="{{ url_for('identity.logout') }}">Logout</a>
  </div>

  

<details>
  <summary><p style="display:inline">Debug info</p></summary>

  <h3>MSAL claims (server)</h3>
  <pre>{{ user | tojson(indent=2) }}</pre>

  <h3>In-app user (API)</h3>
  <pre id="dbg-inapp" style="min-height:4rem; opacity:.7">Loading user…</pre>
</details>

  <hr>
  <footer style="text-align: right">{{ title }}</footer>
</body>
</html>

<script>
  (function(){
    const userLink = document.getElementById('user-link');
    const dbgBlock = document.getElementById('dbg-inapp');

    async function fetchWithRetry(url, attempts = 4) {
      let delay = 500; // ms
      for (let i = 1; i <= attempts; i++) {
        try {
          const resp = await fetch(url, { credentials: 'same-origin' });
          if (!resp.ok) throw new Error('HTTP ' + resp.status);
          return await resp.json();
        } catch (err) {
          if (i === attempts) throw err;
          await new Promise(r => setTimeout(r, delay));
          delay *= 2; // 0.5s, 1s, 2s, 4s
        }
      }
    }

    function renderUser(u) {
      // defensive defaults
      const username = (u && (u.username || u.email)) || 'me';
      const href = "{{ url_for('me') }}";
      userLink.outerHTML = `<a href="${href}">To profile: ${username}</a>`;
    }

    function renderError(msg) {
      userLink.outerHTML = `
        <span style="opacity:.8">User info unavailable - ${msg}</span>
        <button id="retry-user" type="button" style="margin-left:.5rem">Retry</button>
      `;
      document.getElementById('retry-user').addEventListener('click', init);
    }

    async function init() {
      try {
        const data = await fetchWithRetry("/ui/users/me", 4);
        if (data && !data.error) {
          renderUser(data); // Right top block
          dbgBlock.style.opacity = 1; // debug block
          dbgBlock.textContent = JSON.stringify(data, null, 2); // debug block
        } else {
          renderError(data.message || 'please try again'); // Right top block
          dbgBlock.textContent = (data && data.message) || 'User service is warming up'; // debug block
        }
      } catch (e) {
        renderError('please try again');
      }
    }

    document.addEventListener('DOMContentLoaded', init);
  })();
  </script>