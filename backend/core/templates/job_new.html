<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{{ title }}</title>
  <style>
    form { max-width: 900px; }
    .grid { display:grid; grid-template-columns: 220px 1fr; gap: 10px 14px; }
    label { align-self: center; }
    input[type="text"], input[type="url"], input[type="datetime-local"], textarea {
      width: 100%; padding: 8px; border:1px solid #ccc; border-radius:6px;
    }
    textarea { min-height: 140px; }
    .muted { opacity:.75; font-size: 0.92rem; }
    .help-row { grid-column: 2 / span 1; margin-top: -6px; }
    .chips { display:flex; flex-wrap: wrap; gap:6px; }
    .chip { font-size: 0.88rem; padding: 2px 8px; border:1px dashed #bbb; border-radius: 999px; color:#444; cursor:pointer; }
    .err { color:#a40000; }
    .row { margin: 10px 0; }
    .actions { display:flex; gap:8px; margin-top: 8px; }
    .btn { padding:8px 12px; border:1px solid #bbb; border-radius:6px; cursor:pointer; background:#fafafa; }
    .btn.primary { background:#f2f7ff; border-color:#8fb3ff; }
    .req::after { content:" *"; color:#a40000; }
    .radio-row { display:flex; gap:16px; align-items:center; }
    .inline-tip { color:#666; font-size:.9rem; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <div id="user-bar" style="text-align: right; padding: 10px;">
    <span id="user-link" style="opacity:.6">Loading user…</span>
    <p>Updated at: {{ now }}</p>
    <a href="{{ url_for('identity.logout') }}">Logout</a>
  </div>

  <h2>{{ title }}</h2>
  <p class="muted">Fields marked with * are required.</p>

  <form id="job-form" novalidate>
    <div class="grid">

      <!-- Source + helpers -->
      <label class="req" for="Source">Source</label>
      <input id="Source" name="Source" type="text" required placeholder="e.g. LinkedIn">
      <div class="help-row muted">
        <div class="chips" data-target="Source">
          <span class="chip">LinkedIn</span>
          <span class="chip">Stepstone</span>
          <span class="chip">Indeed</span>
          <span class="chip">Xing</span>
          <span class="chip">arbitenow</span>
          <span class="chip">weworkremotely</span>
          <span class="chip">DinamiteJobs</span>
        </div>
      </div>

      <!-- URL first -->
      <label class="req" for="Url">Url</label>
      <input id="Url" name="Url" type="url" required placeholder="https://…">

      <!-- ExternalId after URL, with tip -->
      <label class="req" for="ExternalId">ExternalId</label>
      <div>
        <input id="ExternalId" name="ExternalId" type="text" required placeholder="e.g. 4284137177">
        <div class="inline-tip muted">Unique ID, often visible in the job URL, e.g. https://www.linkedin.com/jobs/view/<b>4284137177</b></div>
      </div>

      <!-- Company mapping -->
      <label class="req" for="Company">Company</label>
      <input id="Company" name="Company" type="text" required placeholder="Company or agency name">

      <label for="IsAgency">It's a talent agency</label>
      <div class="radio-row">
        <input id="IsAgency" name="IsAgency" type="checkbox" />
        <label class="muted" for="IsAgency" style="margin-left:4px;">If checked, we'll ask who they hire for.</label>
      </div>

      <label for="TheyHireFor" id="TheyHireForLabel" class="hidden">They hire for</label>
      <div id="TheyHireForBox" class="hidden">
        <input id="TheyHireFor" name="TheyHireFor" type="text" placeholder="Hiring company name, if known">
        <div class="inline-tip muted">You can leave empty if unsure.</div>
      </div>

      <!-- Title -->
      <label class="req" for="Title">Title</label>
      <input id="Title" name="Title" type="text" required>

      <!-- Country + helpers -->
      <label class="req" for="Country">Country</label>
      <input id="Country" name="Country" type="text" required placeholder="e.g. Germany">
      <div class="help-row muted">
        <div class="chips" data-target="Country">
          <span class="chip">Germany</span>
          <span class="chip">EU</span>
        </div>
      </div>

      <!-- Locality -->
      <label for="Locality">Locality</label>
      <input id="Locality" name="Locality" type="text" placeholder="Munich, Remote, …">

      <!-- RemoteType radios -->
      <label for="RemoteType">RemoteType</label>
      <div class="radio-row" id="RemoteTypeGroup">
        <label><input type="radio" name="RemoteType" value="Remote"> Remote</label>
        <label><input type="radio" name="RemoteType" value="Hybrid"> Hybrid</label>
        <label><input type="radio" name="RemoteType" value="On-Site"> On‑Site</label>
        <label><input type="radio" name="RemoteType" value="Unknown"> Unknown</label>
      </div>

      <!-- PostedDate -->
      <label for="PostedDate">PostedDate</label>
      <input id="PostedDate" name="PostedDate" type="datetime-local" placeholder="auto: now">
      <div class="help-row muted">Default is “now”. If you pick a date from calendar, time will be set to 00:00.</div>

      <!-- Description -->
      <label for="Description">Description</label>
      <textarea id="Description" name="Description" placeholder="Optional details…"></textarea>
    </div>

    <div class="row err" id="form-error" hidden></div>
    <div class="row actions">
      <button type="submit" class="btn primary" id="btn-submit">Create</button>
      <a href="{{ url_for('index') }}" class="btn">Cancel</a>
    </div>
  </form>

  <details>
    <summary><p style="display:inline">Debug</p></summary>
    <pre id="dbg" class="muted"></pre>
  </details>

  <hr>
  <footer style="text-align:right">{{ title }}</footer>

<script>
(function(){
  const userLink = document.getElementById('user-link');
  const form = document.getElementById('job-form');
  const btn = document.getElementById('btn-submit');
  const errEl = document.getElementById('form-error');
  const dbg = document.getElementById('dbg');

  const isAgency = document.getElementById('IsAgency');
  const hireForLabel = document.getElementById('TheyHireForLabel');
  const hireForBox = document.getElementById('TheyHireForBox');
  const postedEl = document.getElementById('PostedDate');

  function toggleAgencyFields() {
    const show = isAgency.checked;
    hireForLabel.classList.toggle('hidden', !show);
    hireForBox.classList.toggle('hidden', !show);
  }
  isAgency.addEventListener('change', toggleAgencyFields);

  // Helper chips: click to fill
  document.querySelectorAll('.chips').forEach(group => {
    const targetId = group.getAttribute('data-target');
    const target = document.getElementById(targetId);
    group.addEventListener('click', (e) => {
      const chip = e.target.closest('.chip');
      if (!chip || !target) return;
      target.value = chip.textContent.trim();
      target.dispatchEvent(new Event('input'));
    });
  });

  // Prefill PostedDate with "now" in local tz (YYYY-MM-DDTHH:mm)
  function localNowForDatetimeLocal() {
    const d = new Date();
    const pad = n => String(n).padStart(2,'0');
    const yyyy = d.getFullYear();
    const mm = pad(d.getMonth()+1);
    const dd = pad(d.getDate());
    const hh = pad(d.getHours());
    const mi = pad(d.getMinutes());
    return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
  }
  if (!postedEl.value) {
    postedEl.value = localNowForDatetimeLocal();
    postedEl.dataset.lastDate = postedEl.value.slice(0,10); // remember date part
  }

  // If user changes the date part, snap time to 00:00
  postedEl.addEventListener('change', () => {
    const datePart = postedEl.value.slice(0,10);
    const last = postedEl.dataset.lastDate || '';
    if (datePart && datePart !== last) {
      postedEl.value = `${datePart}T00:00`;
    }
    postedEl.dataset.lastDate = datePart || '';
  });

  async function fetchWithRetry(url, options, attempts=4) {
    let delay = 500;
    for (let i=1;i<=attempts;i++){
      try {
        const resp = await fetch(url, options);
        if (!resp.ok) throw resp;
        return resp;
      } catch (e) {
        if (i===attempts) throw e;
        await new Promise(r=>setTimeout(r, delay));
        delay *= 2;
      }
    }
  }

  async function initUser(){
    try{
      const r = await fetch('/ui/users/me', {credentials:'same-origin'});
      const d = await r.json();
      const username = d?.username || d?.email || 'me';
      userLink.outerHTML = `<a href="{{ url_for('me') }}">To profile: ${username}</a>`;
    }catch{
      userLink.outerHTML = `<span style="opacity:.8">User info unavailable</span>`;
    }
  }

  function getRadio(name) {
    const el = document.querySelector(`input[name="${name}"]:checked`);
    return el ? el.value : null;
  }

  function getFormData(){
    const o = {};
    // Required/plain fields
    o.Source = document.getElementById('Source').value.trim();
    o.Url = document.getElementById('Url').value.trim();
    o.ExternalId = document.getElementById('ExternalId').value.trim();
    o.Title = document.getElementById('Title').value.trim();
    o.Country = document.getElementById('Country').value.trim();
    o.Locality = document.getElementById('Locality').value.trim() || undefined;
    o.Description = document.getElementById('Description').value.trim() || undefined;

    // RemoteType radios (default Unknown if nothing picked)
    o.RemoteType = getRadio('RemoteType') || 'Unknown';

    // Company mapping
    const company = document.getElementById('Company').value.trim();
    if (isAgency.checked) {
      const hireFor = document.getElementById('TheyHireFor').value.trim();
      o.PostingCompanyName = company || undefined;
      o.HiringCompanyName = hireFor || 'Unknown';
    } else {
      o.HiringCompanyName = company || undefined;
      o.PostingCompanyName = undefined;
    }

    // PostedDate -> ISO (UTC) if present
    const pd = postedEl.value;
    if (pd) {
      const d = new Date(pd);
      if (!isNaN(d)) o.PostedDate = d.toISOString();
    }

    // Drop undefined keys
    for (const k of Object.keys(o)) {
      if (o[k] === undefined || o[k] === null || o[k] === '') delete o[k];
    }
    return o;
  }

  function validateClient(o){
    const req = ["Source","ExternalId","Url","HiringCompanyName","Title","Country"];
    const miss = req.filter(k=>!o[k]);
    if (miss.length) return "Missing required: " + miss.join(", ");

    // URL basic check
    try { new URL(o.Url); } catch { return "Invalid URL in Url"; }

    // length caps (loose mirror of server)
    const caps = {
      Source:100, ExternalId:200, Url:1000, HiringCompanyName:300,
      PostingCompanyName:300, Title:300, Country:100, Locality:300,
      RemoteType:50, Description:5000
    };
    for (const [k,max] of Object.entries(caps)) {
      if (o[k] && String(o[k]).length > max) return `${k} exceeds max length (${max})`;
    }
    return null;
  }

  function setBusy(b){
    btn.disabled = b;
    btn.textContent = b ? "Creating…" : "Create";
  }

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    errEl.hidden = true; errEl.textContent = '';

    const payload = getFormData();
    const msg = validateClient(payload);
    if (msg) { errEl.hidden = false; errEl.textContent = msg; return; }

    setBusy(true);
    try{
      dbg.textContent = JSON.stringify(payload, null, 2);
      const resp = await fetchWithRetry('/ui/jobs', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'same-origin',
        body: JSON.stringify(payload)
      }, 4);

      const body = await resp.json();
      if (resp.status === 201 && body?.id) {
        const id = encodeURIComponent(body.id);
        window.location.assign(`/jobs/${id}`);
        return;
      }
      errEl.hidden = false; errEl.textContent = body?.message || 'Failed to create';
    } catch (e) {
      let msg = 'Failed to create';
      if (e && typeof e.text === 'function') {
        try { msg = await e.text(); } catch {}
      }
      errEl.hidden = false; errEl.textContent = msg;
    } finally {
      setBusy(false);
    }
  });

  document.addEventListener('DOMContentLoaded', () => {
    initUser();
    toggleAgencyFields();
  });
})();
</script>
</body>
</html>
