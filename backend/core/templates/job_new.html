{% extends "base.html" %}

{% block head_extra %}
<link href="{{ url_for('static', filename='css/quill.snow.css') }}" rel="stylesheet">
<script src="{{ url_for('static', filename='js/quill.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/job-url-helpers.js') }}" type="module"></script>

<style>
  .card { border:1px solid #e5e7eb; border-radius:12px; background:#fff; }
  .btn { padding:8px 12px; border:1px solid #e5e7eb; border-radius:8px; cursor:pointer; background:#f9fafb; }
  .btn.primary { background:#eef2ff; border-color:#c7d2fe; }
  .form-grid { grid-template-columns: 220px 1fr; }
  label { align-self:center; color:#374151; }
  .muted { color:#6b7280; }
  .help-row { grid-column: 2 / span 1; margin-top: -6px; }
  .chips { display:flex; flex-wrap:wrap; gap:6px; }
  .chip { font-size: .88rem; padding:2px 8px; border:1px dashed #bbb; border-radius:999px; color:#444; cursor:pointer; }
  .radio-row { display:flex; gap:16px; align-items:center; }
  .err { color:#b91c1c; }
  .hidden { display:none; }
  .prose img { max-width:100%; height:auto; border-radius:8px; }
  .placeholder-img { width:100%; height:128px; border-radius:8px; background:#f3f4f6; color:#6b7280;
    display:flex; align-items:center; justify-content:center; font-size:12px; }
  /* Quill (no toolbar) */
  .ql-container { min-height: 180px; border-radius: 8px; }
  .ql-container.ql-snow { border:1px solid #e5e7eb; }
  .ql-editor { min-height: 160px; }

  /* Fix: inputs aligned with form container */
  .form-shell { max-width: 900px; margin: 0 auto; background: #fff; padding: 16px; border-radius: 8px; border:1px solid #e5e7eb; }
  .grid { display:grid; grid-template-columns: 220px 1fr; gap: 10px 14px; align-items: center; }
  .grid .label { align-self: center; }
  input[type="text"], input[type="url"], input[type="datetime-local"], textarea, select {
    width: 100%; box-sizing: border-box; padding: 8px; border:1px solid #d1d5db; border-radius:6px;
  }
  /* Fix: helper nuggets not overlapping fields */
  .help-nuggets { margin-top: 4px; display:flex; flex-wrap: wrap; gap:6px; }
  .help-nuggets .nugget { font-size: 12px; color:#6b7280; border:1px dashed #cbd5e1; padding:2px 6px; border-radius:9999px; cursor:pointer; }
  /* Buttons top */
  .actions-top { display:flex; gap:8px; margin-bottom:12px; }
</style>
{% endblock %}


{% block content %}
<div class="form-shell">
  <div class="actions-top">
    <button id="btnCreate" class="btn btn-primary">Create</button>
    <a href="{{ url_for('index') }}" class="btn btn-secondary">Cancel</a>
  </div>

  <form id="jobForm" class="grid">
    <!-- URL first -->
    <label for="url" class="label">URL</label>
    <div>
      <input type="url" id="url" name="url" placeholder="https://..." required>
      <!-- Optional helpers under Source later if you want -->
    </div>

    <!-- RemoteType immediately after URL to trigger blur early -->
    <label class="label">Remote Type</label>
    <div>
      <label><input type="radio" name="remoteType" value="Remote"> Remote</label>
      <label><input type="radio" name="remoteType" value="Hybrid"> Hybrid</label>
      <label><input type="radio" name="remoteType" value="On-Site"> On-Site</label>
      <label><input type="radio" name="remoteType" value="Unknown" checked> Unknown</label>
    </div>

    <!-- Title -->
    <label for="title" class="label">Title</label>
    <input type="text" id="title" name="title" placeholder="Job title">

    <!-- Company + TalentAgency side-by-side -->
    <label for="company" class="label">Company</label>
    <input type="text" id="company" name="company" placeholder="Company name">

    <label for="talentAgency" class="label">Talent Agency</label>
    <input type="text" id="talentAgency" name="talentAgency" placeholder="(if applicable)">

    <!-- Country + Locality -->
    <label for="country" class="label">Country</label>
    <input type="text" id="country" name="country" placeholder="e.g. Germany">

    <label for="locality" class="label">Locality</label>
    <input type="text" id="locality" name="locality" placeholder="e.g. Berlin">

    <!-- Source (with click-to-fill helpers) -->
    <label for="source" class="label">Source</label>
    <div>
      <input type="text" id="source" name="source" placeholder="e.g. LinkedIn">
      <div class="help-nuggets" id="sourceNuggets">
        <!-- Opinion: give common sources you listed -->
        <span class="nugget">LinkedIn</span>
        <span class="nugget">StepStone</span>
        <span class="nugget">Indeed</span>
        <span class="nugget">Xing</span>
        <span class="nugget">arbinow</span>
        <span class="nugget">weworkremotely</span>
        <span class="nugget">dynamitejobs</span>
      </div>
    </div>

    <!-- Posted date -->
    <label for="postedDate" class="label">Posted Date</label>
    <input type="datetime-local" id="postedDate" name="postedDate">

    <!-- ExternalId (kept but auto-filled; user can override) -->
    <label for="externalId" class="label">External ID</label>
    <input type="text" id="externalId" name="externalId" placeholder="(auto-filled from URL)">

    <!-- Description (no preview) -->
    <label for="description" class="label">Description</label>
    <textarea id="description" name="description" rows="10" placeholder="Paste or write a description"></textarea>
  </form>
</div>

<script type="module">
  import { deduceFromUrl } from "{{ url_for('static', filename='js/job-url-helpers.js') }}";

  const el = (id) => document.getElementById(id);
  const urlInput = el('url');
  const sourceInput = el('source');
  const externalIdInput = el('externalId');
  const companyInput = el('company');
  const agencyInput = el('talentAgency');
  const postedInput = el('postedDate');

  // 1) Set postedDate default to now (so user can skip for fresh offerings)
  // Opinion: using local time is friendlier for input UX; backend can normalize to UTC.
  (function presetPostedNow(){
    const now = new Date();
    const pad = (n) => String(n).padStart(2,'0');
    const isoLocal = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
    postedInput.value = isoLocal;
  })();

  // 2) Source nuggets click-to-fill
  document.getElementById('sourceNuggets')?.addEventListener('click', (e) => {
    const t = e.target;
    if (t.classList.contains('nugget')) {
      sourceInput.value = t.textContent.trim();
      sourceInput.dispatchEvent(new Event('change'));
    }
  });

  // 3) On URL blur: compute fields not yet filled by user
  urlInput.addEventListener('blur', () => {
    const raw = urlInput.value.trim();
    if (!raw) return;
    const deduced = deduceFromUrl(raw);

    // Respect existing user input: only set if empty
    if (deduced.source && !sourceInput.value.trim()) sourceInput.value = deduced.source;
    if (deduced.externalId && !externalIdInput.value.trim()) externalIdInput.value = deduced.externalId;
    if (deduced.company && !companyInput.value.trim()) companyInput.value = deduced.company;
    if (deduced.talentAgency && !agencyInput.value.trim()) agencyInput.value = deduced.talentAgency;
  });

  // 4) When user picks a date from the calendar, set time to 00:00
  postedInput.addEventListener('change', () => {
    const v = postedInput.value;
    if (v && v.length >= 10 && !v.includes('T')) {
      postedInput.value = v + "T00:00";
    }
  });

  // 5) Top buttons
  document.getElementById('btnCreate').addEventListener('click', async (e) => {
    e.preventDefault();
    const form = document.getElementById('jobForm');
    // TODO: submit via fetch to your create endpoint
    form.submit(); // or custom fetch
  });
</script>
{% endblock %}