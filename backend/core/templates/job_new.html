{% extends "base.html" %}

{% block head_extra %}
<link href="{{ url_for('static', filename='css/quill.snow.css') }}" rel="stylesheet">
<script src="{{ url_for('static', filename='js/quill.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/job-url-helpers.js') }}" type="module"></script>
<script src="{{ url_for('static', filename='js/geo-dict.js') }}" type="module"></script>
 

<style>
  .card { border:1px solid #e5e7eb; border-radius:12px; background:#fff; }
  .btn { padding:8px 12px; border:1px solid #e5e7eb; border-radius:8px; cursor:pointer; background:#f9fafb; }
  .btn.primary { background:#eef2ff; border-color:#c7d2fe; }
  .btn[disabled], .btn.disabled { opacity:.6; cursor:not-allowed; }
  .form-shell { max-width: 900px; margin: 0 auto; background: #fff; padding: 16px; border-radius: 8px; border:1px solid #e5e7eb; }
  .grid { display:grid; grid-template-columns: 220px 1fr; gap: 10px 14px; align-items: center; }
  .grid .label { align-self: center; }
  label.required::after { content:" *"; color:#b91c1c; }
  .muted { color:#6b7280; }
  .err { color:#b91c1c; margin-top:4px; }
  .hidden { display:none; }
  input[type="text"], input[type="url"], textarea, select {
    width: 100%; box-sizing: border-box; padding: 8px; border:1px solid #d1d5db; border-radius:6px;
  }
  /* helper nuggets position fix */
  .help-nuggets { margin-top: 4px; display:flex; flex-wrap: wrap; gap:6px; }
  .help-nuggets .nugget { font-size: 12px; color:#6b7280; border:1px dashed #cbd5e1; padding:2px 6px; border-radius:9999px; cursor:pointer; }
  /* Buttons top */
  .actions-top { display:flex; gap:8px; margin-bottom:6px; align-items:center; }
  .actions-top a[aria-disabled="true"] { pointer-events:none; opacity:.6; }

  /* Locations editor */
  /* Country | City | Delete */
  .loc-row {
    display:grid;
    /* Use minmax(0,1fr) so long country names don't starve the City column */
    grid-template-columns: minmax(0,1fr) minmax(0,1fr) max-content;
    gap:8px; align-items:center; margin-bottom:8px;
  }
  .loc-row input { width:100%; min-width:0; }       /* allow shrinking in grid */
  .loc-row .country, .loc-row .city { min-width:0; } /* belt-and-suspenders */
  .loc-row .cc { display:none; } /* hide country code */
  .loc-row button[data-act="del"] {
    width:28px; height:28px; padding:0;
    text-align:center; line-height:1; box-sizing:border-box;
    display:inline-flex; align-items:center; justify-content:center;
  }  
  .loc-actions { display:flex; gap:8px; }
  .section-subtle { padding:10px; border:1px dashed #e5e7eb; border-radius:8px; background:#fafafa; }
  details.advanced summary { cursor:pointer; color:#374151; }
  /* Quill styling */
  .ql-toolbar.ql-snow { border:1px solid #e5e7eb; border-radius:8px 8px 0 0; }
  .ql-container.ql-snow { border:1px solid #e5e7eb; border-top:0; border-radius:0 0 8px 8px; min-height:180px; }
  .ql-editor { min-height:160px; }

  .desc-meta { display:flex; justify-content:space-between; align-items:center; font-size:12px; color:#6b7280; margin-top:6px; }
  .desc-count.over { color:#b91c1c; font-weight:600; }  
</style>
{% endblock %}

{% block content %}
<div class="form-shell">
  <div class="actions-top">
    <button id="btnCreate" class="btn primary">Create</button>
    <a id="btnCancel" href="{{ url_for('index') }}" class="btn">Cancel</a>
  </div>
  <div id="err" class="err hidden" role="alert"></div>

  <form id="jobForm" class="grid" onsubmit="return false;">
    <!-- URL first (mandatory) -->
    <label for="url" class="label required">URL</label>
    <div>
      <input type="url" id="url" name="url" placeholder="https://..." required>
      <div class="muted" style="font-size:12px; margin-top:4px;">
        You can fill only that, leaving everything else empty. It'll work, but wouldn't be pretty.
      </div>
    </div>

    <!-- RemoteType immediately after URL to force early blur -->
    <label class="label">Remote Type</label>
    <div class="radio-row">
      <label><input type="radio" name="remoteType" value="Remote"> Remote</label>
      <label><input type="radio" name="remoteType" value="Hybrid"> Hybrid</label>
      <label><input type="radio" name="remoteType" value="On-Site"> On-Site</label>
      <label><input type="radio" name="remoteType" value="Unknown" checked> Unknown</label>
    </div>

    <!-- Title -->
    <label for="title" class="label">Title</label>
    <input type="text" id="title" name="title" placeholder="Job title">

    <!-- Company + Talent Agency -->
    <label for="hiringCompanyName" class="label">Company</label>
    <input type="text" id="hiringCompanyName" name="hiringCompanyName" placeholder="Hiring company">

    <label for="postingCompanyName" class="label">Talent Agency</label>
    <input type="text" id="postingCompanyName" name="postingCompanyName" placeholder="(if applicable)">

    <!-- Locations (multi) -->
    <label class="label">Locations</label>
    <div>
      <div id="locations" class="section-subtle"></div>
      <div class="loc-actions" style="margin-top:8px;">
        <button type="button" class="btn" id="btnAddCountry">+ More countries</button>
        <button type="button" class="btn" id="btnAddCity">+ More cities</button>
      </div>
      <div class="muted" style="font-size:12px; margin-top:4px;">
        You can add multiple countries and cities. Example: DE: Berlin · ES: Madrid · GB: London
      </div>
    </div>

    <!-- FoundOn (was Source) -->
    <label for="foundOn" class="label">Found on</label>
    <div>
      <input type="text" id="foundOn" name="foundOn" placeholder="e.g. linkedin, stepstone">
      <div class="help-nuggets" id="foundOnNuggets">
        <span class="nugget">linkedin</span>
        <span class="nugget">stepstone</span>
        <span class="nugget">indeed</span>
        <span class="nugget">xing</span>
        <span class="nugget">arbeitnow</span>
        <span class="nugget">weworkremotely</span>
        <span class="nugget">dynamitejobs</span>
      </div>
    </div>

    <!-- Advanced ATS details (optional, auto-filled) -->
    <label class="label">Advanced</label>
    <div>
      <details class="advanced">
        <summary>ATS & identifiers (optional)</summary>
        <div class="grid" style="grid-template-columns: 160px 1fr; gap:8px 12px; margin-top:8px;">
          <label for="provider" class="label">Provider</label>
          <input type="text" id="provider" name="provider" placeholder="workday / greenhouse / join / corporate-site">

          <label for="providerTenant" class="label">Provider tenant</label>
          <input type="text" id="providerTenant" name="providerTenant" placeholder="tenant or slug (optional)">

          <label for="externalId" class="label">External ID</label>
          <input type="text" id="externalId" name="externalId" placeholder="auto or custom id">
        </div>
      </details>
      <div class="muted" style="font-size:12px; margin-top:4px;">
        We’ll try to fill these from the URL. You can override them.
      </div>
    </div>

    <!-- Description (rich) -->
    <label class="label">Description</label>
    <div>
      <!-- Simple toolbar (no image/video) -->
      <div id="descToolbar">
        <span class="ql-formats">
          <select class="ql-header">
            <option selected></option>
            <option value="2">H2</option>
            <option value="3">H3</option>
          </select>
        </span>
        <span class="ql-formats">
          <button class="ql-bold"></button>
          <button class="ql-italic"></button>
          <button class="ql-underline"></button>
          <button class="ql-strike"></button>
        </span>
        <span class="ql-formats">
          <button class="ql-blockquote"></button>
          <button class="ql-code-block"></button>
        </span>
        <span class="ql-formats">
          <button class="ql-list" value="ordered"></button>
          <button class="ql-list" value="bullet"></button>
        </span>
        <span class="ql-formats">
          <button class="ql-link"></button>
          <!-- deliberately omit image/video -->
        </span>
        <span class="ql-formats">
          <button class="ql-clean"></button>
        </span>
      </div>
      <div id="descEditor"></div>
      <div class="desc-meta">
        <span>No images. Links are allowed.</span>
        <span>Length: <span id="descCount" class="desc-count">0</span>/20000</span>
      </div>
    </div>

  </form>

</div>



<script type="module">
  import { deduceFromUrl } from "{{ url_for('static', filename='js/job-url-helpers.js') }}";
  import { loadGeoDict, countryLookup, prioritizedCountries, citiesByCountry } from "{{ url_for('static', filename='js/geo-dict.js') }}";
 

  const el = (id) => document.getElementById(id);

  // Inputs
  const urlInput = el('url');
  const foundOnInput = el('foundOn');
  const externalIdInput = el('externalId');
  const companyInput = el('hiringCompanyName');
  const agencyInput = el('postingCompanyName');
  const providerInput = el('provider');
  const tenantInput = el('providerTenant');
  const titleInput = el('title');
  const errEl = el('err');
  const btnCreate = el('btnCreate');
  const btnCancel = el('btnCancel');  

  // Locations editor
  const locHost = el('locations');
  el('btnAddCountry').addEventListener('click', () => addLocRow());
  el('btnAddCity').addEventListener('click', () => addCityRowFromLast());

  // --- Quill init ---
  const quill = new Quill('#descEditor', {
    theme: 'snow',
    modules: { toolbar: '#descToolbar' }
  });

  // Prevent images on paste
  const Delta = Quill.import('delta');
  quill.clipboard.addMatcher('img', () => new Delta());  // drop images

  // Live counter (plain text length)
  const descCountEl = document.getElementById('descCount');
  const DESC_LIMIT = 20000;

  function updateDescCount() {
    const len = quill.getText().trimEnd().length; // plain text
    descCountEl.textContent = String(len);
    descCountEl.classList.toggle('over', len > DESC_LIMIT);
  }
  quill.on('text-change', updateDescCount);
  updateDescCount();

  // Build countries datalist once geo dict is loaded
  const countriesList = document.createElement('datalist');
  countriesList.id = 'countriesList';
  document.body.appendChild(countriesList);

  await loadGeoDict(); // fetch /static/data/geo.sample.json
  countriesList.innerHTML = prioritizedCountries().map(c => `<option value="${c.name}"></option>`).join('');


  // Client-side sanitize: remove dangerous tags/attrs; allow links
  function sanitizeClientHtml(html) {
    try {
      const doc = new DOMParser().parseFromString(html, 'text/html');
      const removeAll = (sel) => doc.querySelectorAll(sel).forEach(n => n.remove());

      // Drop risky/embedded content
      removeAll('script,style,iframe,object,embed,video,audio,canvas,svg,img');

      // Remove event handlers and javascript: URLs
      doc.querySelectorAll('*').forEach(el => {
        // remove on* attributes
        [...el.attributes].forEach(a => {
          if (a.name.toLowerCase().startsWith('on')) el.removeAttribute(a.name);
        });
        // tighten <a>
        if (el.tagName.toLowerCase() === 'a') {
          const href = (el.getAttribute('href') || '').trim();
          if (!/^https?:\/\//i.test(href) && !/^mailto:/i.test(href)) {
            el.removeAttribute('href');
          }
          el.setAttribute('target', '_blank');
          el.setAttribute('rel', 'noopener noreferrer nofollow');
        }
      });

      // Keep only a conservative set of tags (others -> unwrap)
      const allowed = new Set(['p','br','hr','span','div','b','strong','i','em','u','code','pre','blockquote',
                              'ul','ol','li','h1','h2','h3','h4','a']);
      doc.body.querySelectorAll('*').forEach(el => {
        if (!allowed.has(el.tagName.toLowerCase())) {
          // Replace el with its children (unwrap)
          const parent = el.parentNode;
          while (el.firstChild) parent.insertBefore(el.firstChild, el);
          parent.removeChild(el);
        }
      });

      // Normalize empty content
      const cleaned = doc.body.innerHTML
        .replace(/^\s+|\s+$/g, '')
        .replace(/<p><br><\/p>/g, '')
        .trim();
      return cleaned || '';
    } catch {
      return '';
    }
  }


  function cityDatalistId(cc) { return `cities_${cc}`; }

  function addLocRow(init = {}) {
    const row = document.createElement('div');
    row.className = 'loc-row';
    row.innerHTML = `
      <input type="text" class="country" placeholder="Country" list="countriesList" value="${init.countryName || ''}">
      <input type="text" class="city" placeholder="City (optional)" value="${init.cityName || ''}" list="">
      <button type="button" class="btn" data-act="del" aria-label="Remove location" title="Remove">✕</button>
    `;
    row.querySelector('[data-act="del"]').addEventListener('click', () => row.remove());
    const countryInput = row.querySelector('.country');
    const ccInput = row.querySelector('.cc');
    const cityInput = row.querySelector('.city');

    // Resolve initial country object (for prefilled rows)
    const ccInit = (init.countryCode || '').toUpperCase();
    const countryObj =
      (ccInit && countryLookup(ccInit)) ||
      (init.countryName && countryLookup(init.countryName)) || null;

    function refreshCities() {
      const m = countryLookup(countryInput.value);
      const currentCC = (m?.code || '').toUpperCase();
      const listId = cityDatalistId(currentCC || 'NONE');
      let listEl = document.getElementById(listId);
      if (!listEl) {
        listEl = document.createElement('datalist');
        listEl.id = listId;
        document.body.appendChild(listEl);
      }
      const cities = citiesByCountry(currentCC);
      listEl.innerHTML = cities.map(c => `<option value="${c}"></option>`).join('');
      cityInput.setAttribute('list', listId);
    }

    // Do NOT normalize on every keystroke. Keep user control and only accept on Tab (if unambiguous) or on blur/change.
    function clearCountryTransient() {
      cityInput.value = '';
      refreshCities();
    }
    function setCountryConfirmed(c) {
      countryInput.value = c.name; // UI shows full country name only
      cityInput.value = '';
      refreshCities();
    }
    countryInput.addEventListener('input', () => {
      // While typing, don't force-fill; just clear code/city until a confirm action happens
      if (!countryInput.value.trim()) {
        clearCountryTransient();
        return;
      }
      // if user typed a complete exact match (name/code/Name (CC)), we still don't normalize here
      // we wait for change/blur or Tab handler to confirm
      clearCountryTransient();
    });
    countryInput.addEventListener('keydown', (e) => {
      if (e.key === 'Tab' && !e.shiftKey) {
        const val = countryInput.value.trim();
        const exact = countryLookup(val);
        if (exact) {
          setCountryConfirmed(exact);
          return; // allow tab to move on naturally
        }
        const matches = window.countryMatches
          ? window.countryMatches(val)
          : prioritizedCountries().filter(x =>
              x.name.toLowerCase().startsWith(val.toLowerCase()) ||
              x.code.toLowerCase().startsWith(val.toLowerCase()));
        if (matches.length === 1) {
          setCountryConfirmed(matches[0]);
        }
        // In ambiguous cases, do nothing; user can arrow/select or keep typing.
      }
    });
    function confirmOnResolve() {
      const m = countryLookup(countryInput.value);
      if (m) setCountryConfirmed(m);
      else clearCountryTransient();
    }
    countryInput.addEventListener('change', confirmOnResolve);
    countryInput.addEventListener('blur', confirmOnResolve);

    // initialize country & city list for prefilled row
    if (countryObj) {
      // confirm normalized display and attach proper city list
      setCountryConfirmed(countryObj);
    } else if (ccInit) {
      // fallback if only a code is known: set cities list based on code inference
      refreshCities();
    }

    locHost.appendChild(row);
  }
  // start with one empty row
  addLocRow();

  function readLocations() {
    const rows = [...locHost.querySelectorAll('.loc-row')];
    const out = [];
    for (const r of rows) {
      const countryDisplay = r.querySelector('.country').value.trim();
      const city = r.querySelector('.city').value.trim();
      const cm = countryLookup(countryDisplay);
      const cn = cm ? cm.name : (countryDisplay || '');
      const code = cm ? cm.code : null;
      if (!cn && !code && !city) continue; // skip empty row
      out.push({
        countryName: cn || '', 
        countryCode: code || null,
        cityName: city || null
      });
    }
    return out;
  }

  function addCityRowFromLast() {
    const rows = [...locHost.querySelectorAll('.loc-row')];
    const last = rows[rows.length - 1];
    if (!last) { addLocRow(); return; }
    const disp = last.querySelector('.country')?.value || '';
    const m = countryLookup(disp);
    if (m) addLocRow({ countryName: m.name, countryCode: m.code });
    else addLocRow();
  }

  // FoundOn nuggets
  document.getElementById('foundOnNuggets')?.addEventListener('click', (e) => {
    const t = e.target;
    if (t.classList.contains('nugget')) {
      foundOnInput.value = t.textContent.trim();
      foundOnInput.dispatchEvent(new Event('change'));
    }
  });

  // On URL blur: compute fields (respect existing input)
  urlInput.addEventListener('blur', () => {
    const raw = urlInput.value.trim();
    if (!raw) return;
    const d = deduceFromUrl(raw) || {};

    // Support old helper keys if the local file wasn't updated yet
    const foundOn = d.foundOn || d.source;
    const extId = d.externalId || d.ExternalId;
    const company = d.hiringCompanyName || d.company;
    const provider = d.provider || null;
    const tenant = d.providerTenant || d.tenant || null;
    const title = d.title || null;

    if (foundOn && !foundOnInput.value.trim()) foundOnInput.value = foundOn;
    if (extId && !externalIdInput.value.trim()) externalIdInput.value = extId;
    if (company && !companyInput.value.trim()) companyInput.value = company;
    if (provider && !providerInput.value.trim()) providerInput.value = provider;
    if (tenant && !tenantInput.value.trim()) tenantInput.value = tenant;
    if (title && !titleInput.value.trim()) titleInput.value = title;
  });

  // Submit UX: block/unblock
  function setSubmitting(on) {
    if (on) {
      btnCreate.setAttribute('disabled','true');
      btnCreate.textContent = 'Creating…';
      btnCancel.setAttribute('aria-disabled','true');
    } else {
      btnCreate.removeAttribute('disabled');
      btnCreate.textContent = 'Create';
      btnCancel.removeAttribute('aria-disabled');
    }
  }
  btnCancel.addEventListener('click', (e) => {
    if (btnCancel.getAttribute('aria-disabled') === 'true') e.preventDefault();
  });

  // Create
  document.getElementById('btnCreate').addEventListener('click', async (e) => {
    e.preventDefault();
    errEl.classList.add('hidden');
    errEl.textContent = '';

    const url = urlInput.value.trim();
    if (!url) {
      errEl.textContent = 'URL is required.';
      errEl.classList.remove('hidden');
      urlInput.focus();
      return;
    }

    // Gather Quill content
    const plain = quill.getText().trim();
    const htmlRaw = quill.root.innerHTML.trim();
    if (plain.length > DESC_LIMIT) {
      errEl.textContent = `Description is too long (${plain.length} > ${DESC_LIMIT} characters).`;
      errEl.classList.remove('hidden');
      return;
    }
    const htmlSafe = sanitizeClientHtml(htmlRaw);
    const description = plain ? htmlSafe : undefined;

    // gather rest of form
    const body = {
      url,
      title: titleInput.value.trim() || undefined,
      hiringCompanyName: companyInput.value.trim() || undefined,
      postingCompanyName: agencyInput.value.trim() || undefined,
      foundOn: foundOnInput.value.trim() || undefined,
      provider: providerInput.value.trim() || undefined,
      providerTenant: tenantInput.value.trim() || undefined,
      externalId: externalIdInput.value.trim() || undefined,
      remoteType: (document.querySelector('input[name="remoteType"]:checked')?.value) || 'Unknown',
      description,
      locations: readLocations()
    };
    if (!body.locations.length) delete body.locations;
    
    setSubmitting(true);
    try {
      const resp = await fetch('/ui/jobs', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify(body)
      });
      if (!resp.ok) {
        const tx = await resp.text();
        throw new Error(tx || `HTTP ${resp.status}`);
      }
      const data = await resp.json();
      if (!data.id) throw new Error('Create succeeded but no id returned');
      window.location.assign(`/jobs/${encodeURIComponent(data.id)}`);
    } catch (err) {
      errEl.textContent = `Create failed: ${err.message || err}`;
      errEl.classList.remove('hidden');
      setSubmitting(false); // unblock on error
    }
  });
</script>
{% endblock %}
