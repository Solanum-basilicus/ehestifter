{% extends "base.html" %}

{% block head_extra %}
<link href="{{ url_for('static', filename='css/quill.snow.css') }}" rel="stylesheet">
<script src="{{ url_for('static', filename='js/quill.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/job-url-helpers.js') }}" type="module"></script>

<style>
  .card { border:1px solid #e5e7eb; border-radius:12px; background:#fff; }
  .btn { padding:8px 12px; border:1px solid #e5e7eb; border-radius:8px; cursor:pointer; background:#f9fafb; }
  .btn.primary { background:#eef2ff; border-color:#c7d2fe; }
  .form-shell { max-width: 900px; margin: 0 auto; background: #fff; padding: 16px; border-radius: 8px; border:1px solid #e5e7eb; }
  .grid { display:grid; grid-template-columns: 220px 1fr; gap: 10px 14px; align-items: center; }
  .grid .label { align-self: center; }
  label.required::after { content:" *"; color:#b91c1c; }
  .muted { color:#6b7280; }
  .err { color:#b91c1c; }
  .hidden { display:none; }
  input[type="text"], input[type="url"], textarea, select {
    width: 100%; box-sizing: border-box; padding: 8px; border:1px solid #d1d5db; border-radius:6px;
  }
  /* helper nuggets position fix */
  .help-nuggets { margin-top: 4px; display:flex; flex-wrap: wrap; gap:6px; }
  .help-nuggets .nugget { font-size: 12px; color:#6b7280; border:1px dashed #cbd5e1; padding:2px 6px; border-radius:9999px; cursor:pointer; }
  /* Buttons top */
  .actions-top { display:flex; gap:8px; margin-bottom:12px; }

  /* Locations editor */
  .loc-row { display:grid; grid-template-columns: 160px 90px 1fr auto; gap:8px; align-items:center; margin-bottom:8px; }
  .loc-row input { width:100%; }
  .loc-actions { display:flex; gap:8px; }
  .section-subtle { padding:10px; border:1px dashed #e5e7eb; border-radius:8px; background:#fafafa; }
  details.advanced summary { cursor:pointer; color:#374151; }
</style>
{% endblock %}

{% block content %}
<div class="form-shell">
  <div class="actions-top">
    <button id="btnCreate" class="btn primary">Create</button>
    <a href="{{ url_for('index') }}" class="btn">Cancel</a>
  </div>

  <form id="jobForm" class="grid" onsubmit="return false;">
    <!-- URL first (mandatory) -->
    <label for="url" class="label required">URL</label>
    <div>
      <input type="url" id="url" name="url" placeholder="https://..." required>
      <div class="muted" style="font-size:12px; margin-top:4px;">
        You can fill only that, leaving everything else empty. It'll work, but wouldn't be pretty.
      </div>
    </div>

    <!-- RemoteType immediately after URL to force early blur -->
    <label class="label">Remote Type</label>
    <div class="radio-row">
      <label><input type="radio" name="remoteType" value="Remote"> Remote</label>
      <label><input type="radio" name="remoteType" value="Hybrid"> Hybrid</label>
      <label><input type="radio" name="remoteType" value="On-Site"> On-Site</label>
      <label><input type="radio" name="remoteType" value="Unknown" checked> Unknown</label>
    </div>

    <!-- Title -->
    <label for="title" class="label">Title</label>
    <input type="text" id="title" name="title" placeholder="Job title">

    <!-- Company + Talent Agency -->
    <label for="hiringCompanyName" class="label">Company</label>
    <input type="text" id="hiringCompanyName" name="hiringCompanyName" placeholder="Hiring company">

    <label for="postingCompanyName" class="label">Talent Agency</label>
    <input type="text" id="postingCompanyName" name="postingCompanyName" placeholder="(if applicable)">

    <!-- Locations (multi) -->
    <label class="label">Locations</label>
    <div>
      <div id="locations" class="section-subtle"></div>
      <div class="loc-actions" style="margin-top:8px;">
        <button type="button" class="btn" id="btnAddLoc">+ Add location</button>
      </div>
      <div class="muted" style="font-size:12px; margin-top:4px;">
        You can add multiple countries and cities. Example: DE: Berlin · ES: Madrid · GB: London
      </div>
    </div>

    <!-- FoundOn (was Source) -->
    <label for="foundOn" class="label">Found on</label>
    <div>
      <input type="text" id="foundOn" name="foundOn" placeholder="e.g. linkedin, stepstone">
      <div class="help-nuggets" id="foundOnNuggets">
        <span class="nugget">linkedin</span>
        <span class="nugget">stepstone</span>
        <span class="nugget">indeed</span>
        <span class="nugget">xing</span>
        <span class="nugget">arbeitnow</span>
        <span class="nugget">weworkremotely</span>
        <span class="nugget">dynamitejobs</span>
      </div>
    </div>

    <!-- Advanced ATS details (optional, auto-filled) -->
    <label class="label">Advanced</label>
    <div>
      <details class="advanced">
        <summary>ATS & identifiers (optional)</summary>
        <div class="grid" style="grid-template-columns: 160px 1fr; gap:8px 12px; margin-top:8px;">
          <label for="provider" class="label">Provider</label>
          <input type="text" id="provider" name="provider" placeholder="workday / greenhouse / join / corporate-site">

          <label for="providerTenant" class="label">Provider tenant</label>
          <input type="text" id="providerTenant" name="providerTenant" placeholder="tenant or slug (optional)">

          <label for="externalId" class="label">External ID</label>
          <input type="text" id="externalId" name="externalId" placeholder="auto or custom id">
        </div>
      </details>
      <div class="muted" style="font-size:12px; margin-top:4px;">
        We’ll try to fill these from the URL. You can override them.
      </div>
    </div>

    <!-- Description (no preview) -->
    <label for="description" class="label">Description</label>
    <textarea id="description" name="description" rows="10" placeholder="Paste or write a description"></textarea>
  </form>

  <div id="err" class="err hidden" role="alert"></div>
</div>

<script type="module">
  import { deduceFromUrl } from "{{ url_for('static', filename='js/job-url-helpers.js') }}";

  const el = (id) => document.getElementById(id);

  // Inputs
  const urlInput = el('url');
  const foundOnInput = el('foundOn');
  const externalIdInput = el('externalId');
  const companyInput = el('hiringCompanyName');
  const agencyInput = el('postingCompanyName');
  const providerInput = el('provider');
  const tenantInput = el('providerTenant');
  const titleInput = el('title');
  const descInput = el('description');
  const errEl = el('err');

  // Locations editor
  const locHost = el('locations');
  el('btnAddLoc').addEventListener('click', () => addLocRow());

  function addLocRow(init = {}) {
    const row = document.createElement('div');
    row.className = 'loc-row';
    row.innerHTML = `
      <input type="text" placeholder="Country (name)" value="${init.countryName || ''}" data-k="countryName">
      <input type="text" placeholder="CC" value="${(init.countryCode || '').toUpperCase()}" maxlength="2" data-k="countryCode" style="text-transform:uppercase;">
      <input type="text" placeholder="City (optional)" value="${init.cityName || ''}" data-k="cityName">
      <button type="button" class="btn" data-act="del">✕</button>
    `;
    row.querySelector('[data-act="del"]').addEventListener('click', () => row.remove());
    locHost.appendChild(row);
  }
  // start with one empty row
  addLocRow();

  function readLocations() {
    const rows = [...locHost.querySelectorAll('.loc-row')];
    const out = [];
    for (const r of rows) {
      const cn = r.querySelector('[data-k="countryName"]').value.trim();
      const cc = r.querySelector('[data-k="countryCode"]').value.trim().toUpperCase();
      const city = r.querySelector('[data-k="cityName"]').value.trim();
      if (!cn && !cc && !city) continue; // skip empty row
      out.push({
        countryName: cn || '', 
        countryCode: cc || null,
        cityName: city || null
      });
    }
    return out;
  }

  // FoundOn nuggets
  document.getElementById('foundOnNuggets')?.addEventListener('click', (e) => {
    const t = e.target;
    if (t.classList.contains('nugget')) {
      foundOnInput.value = t.textContent.trim();
      foundOnInput.dispatchEvent(new Event('change'));
    }
  });

  // On URL blur: compute fields (respect existing input)
  urlInput.addEventListener('blur', () => {
    const raw = urlInput.value.trim();
    if (!raw) return;
    const d = deduceFromUrl(raw) || {};

    // Support old helper keys if the local file wasn't updated yet
    const foundOn = d.foundOn || d.source;
    const extId = d.externalId || d.ExternalId;
    const company = d.hiringCompanyName || d.company;
    const provider = d.provider || null;
    const tenant = d.providerTenant || d.tenant || null;
    const title = d.title || null;

    if (foundOn && !foundOnInput.value.trim()) foundOnInput.value = foundOn;
    if (extId && !externalIdInput.value.trim()) externalIdInput.value = extId;
    if (company && !companyInput.value.trim()) companyInput.value = company;
    if (provider && !providerInput.value.trim()) providerInput.value = provider;
    if (tenant && !tenantInput.value.trim()) tenantInput.value = tenant;
    if (title && !titleInput.value.trim()) titleInput.value = title;
  });

  // Create
  document.getElementById('btnCreate').addEventListener('click', async (e) => {
    e.preventDefault();
    errEl.classList.add('hidden');
    errEl.textContent = '';

    const url = urlInput.value.trim();
    if (!url) {
      errEl.textContent = 'URL is required.';
      errEl.classList.remove('hidden');
      urlInput.focus();
      return;
    }

    // gather form
    const body = {
      url,
      title: titleInput.value.trim() || undefined,
      hiringCompanyName: companyInput.value.trim() || undefined,
      postingCompanyName: agencyInput.value.trim() || undefined,
      foundOn: foundOnInput.value.trim() || undefined,
      provider: providerInput.value.trim() || undefined,
      providerTenant: tenantInput.value.trim() || undefined,
      externalId: externalIdInput.value.trim() || undefined,
      remoteType: (document.querySelector('input[name="remoteType"]:checked')?.value) || 'Unknown',
      description: descInput.value.trim() || undefined,
      locations: readLocations()
    };

    // remove empty locations array if all rows empty
    if (!body.locations.length) delete body.locations;

    try {
      const resp = await fetch('/ui/jobs', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify(body)
      });
      if (!resp.ok) {
        const tx = await resp.text();
        throw new Error(tx || `HTTP ${resp.status}`);
      }
      const data = await resp.json();
      if (!data.id) throw new Error('Create succeeded but no id returned');
      window.location.assign(`/jobs/${encodeURIComponent(data.id)}`);
    } catch (err) {
      errEl.textContent = `Create failed: ${err.message || err}`;
      errEl.classList.remove('hidden');
    }
  });
</script>
{% endblock %}
