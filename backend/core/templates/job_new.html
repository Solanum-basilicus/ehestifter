{% extends "base.html" %}

{% block head_extra %}
<style>
  .card { border:1px solid #e5e7eb; border-radius:12px; background:#fff; }
  .btn { padding:8px 12px; border:1px solid #e5e7eb; border-radius:8px; cursor:pointer; background:#f9fafb; }
  .btn.primary { background:#eef2ff; border-color:#c7d2fe; }
  .grid { display:grid; gap: 12px 16px; }
  .form-grid { grid-template-columns: 220px 1fr; }
  label { align-self:center; color:#374151; }
  input[type="text"], input[type="url"], input[type="datetime-local"], select {
    width:100%; padding:8px 10px; border:1px solid #e5e7eb; border-radius:8px;
  }
  .muted { color:#6b7280; }
  .help-row { grid-column: 2 / span 1; margin-top: -6px; }
  .chips { display:flex; flex-wrap:wrap; gap:6px; }
  .chip { font-size: .88rem; padding:2px 8px; border:1px dashed #bbb; border-radius:999px; color:#444; cursor:pointer; }
  .radio-row { display:flex; gap:16px; align-items:center; }
  .err { color:#b91c1c; }
  .hidden { display:none; }
  .prose img { max-width:100%; height:auto; border-radius:8px; }
  .placeholder-img { width:100%; height:128px; border-radius:8px; background:#f3f4f6; color:#6b7280;
    display:flex; align-items:center; justify-content:center; font-size:12px; }
  /* Quill (no toolbar) */
  .ql-container { min-height: 180px; border-radius: 8px; }
  .ql-container.ql-snow { border:1px solid #e5e7eb; }
  .ql-editor { min-height: 160px; }
</style>

<link href="{{ url_for('static', filename='css/quill.snow.css') }}" rel="stylesheet">
<script src="{{ url_for('static', filename='js/quill.min.js') }}"></script>
{% endblock %}

{% block content %}
<div class="mx-auto" style="max-width:900px; padding:16px;">
  <h1 style="font-size:20px; font-weight:600; margin:8px 0 6px;">{{ title }}</h1>
  <p class="muted" style="margin-top:0;">Fields marked with * are required.</p>

  <div class="card" style="padding:16px;">
    <form id="job-form" novalidate>
      <div class="grid form-grid">

        <!-- Source + helpers -->
        <label class="req" for="Source">Source *</label>
        <div>
          <input id="Source" name="Source" type="text" required placeholder="e.g. LinkedIn">
          <div class="help-row muted">
            <div class="chips" data-target="Source">
              <span class="chip">LinkedIn</span>
              <span class="chip">Stepstone</span>
              <span class="chip">Indeed</span>
              <span class="chip">Xing</span>
              <span class="chip">arbitenow</span>
              <span class="chip">weworkremotely</span>
              <span class="chip">DinamiteJobs</span>
            </div>
          </div>
        </div>

        <!-- URL -->
        <label class="req" for="Url">Url *</label>
        <input id="Url" name="Url" type="url" required placeholder="https://…">

        <!-- ExternalId with tip -->
        <label class="req" for="ExternalId">ExternalId *</label>
        <div>
          <input id="ExternalId" name="ExternalId" type="text" required placeholder="e.g. 4284137177">
          <div class="muted" style="font-size:.9rem;">Often visible in the job URL, e.g. <code>/jobs/view/<b>4284137177</b></code></div>
        </div>

        <!-- Company mapping -->
        <label class="req" for="Company">Company *</label>
        <input id="Company" name="Company" type="text" required placeholder="Company or agency name">

        <label for="IsAgency">It's a talent agency</label>
        <div class="radio-row">
          <input id="IsAgency" name="IsAgency" type="checkbox" />
          <label class="muted" for="IsAgency" style="margin-left:4px;">If checked, we’ll ask who they hire for.</label>
        </div>

        <label for="TheyHireFor" id="TheyHireForLabel" class="hidden">They hire for</label>
        <div id="TheyHireForBox" class="hidden">
          <input id="TheyHireFor" name="TheyHireFor" type="text" placeholder="Hiring company name, if known">
          <div class="muted" style="font-size:.9rem;">You can leave empty if unsure.</div>
        </div>

        <!-- Title -->
        <label class="req" for="Title">Title *</label>
        <input id="Title" name="Title" type="text" required>

        <!-- Country + helpers -->
        <label class="req" for="Country">Country *</label>
        <div>
          <input id="Country" name="Country" type="text" required placeholder="e.g. Germany">
          <div class="help-row muted">
            <div class="chips" data-target="Country">
              <span class="chip">Germany</span>
              <span class="chip">EU</span>
            </div>
          </div>
        </div>

        <!-- Locality -->
        <label for="Locality">Locality</label>
        <input id="Locality" name="Locality" type="text" placeholder="Munich, Remote, …">

        <!-- RemoteType radios -->
        <label for="RemoteType">RemoteType</label>
        <div class="radio-row" id="RemoteTypeGroup">
          <label><input type="radio" name="RemoteType" value="Remote"> Remote</label>
          <label><input type="radio" name="RemoteType" value="Hybrid"> Hybrid</label>
          <label><input type="radio" name="RemoteType" value="On-Site"> On-Site</label>
          <label><input type="radio" name="RemoteType" value="Unknown" checked> Unknown</label>
        </div>

        <!-- PostedDate -->
        <label for="PostedDate">PostedDate (local)</label>
        <div>
          <input id="PostedDate" name="PostedDate" type="datetime-local" placeholder="auto: now">
          <div class="muted">Default is “now”. If you pick a date from calendar, time will be set to 00:00.</div>
        </div>

        <!-- Description -->
        <label for="Description">Description</label>
        <div>
          <div id="editor" style="background:#fff;"></div>
          <div class="muted" style="font-size:12px; margin-top:6px;">
            Paste rich text. Formatting and links are preserved. External images are blocked; clipboard images (data:) are allowed.
          </div>
        </div>

        <!-- Preview -->
        <label>Preview</label>
        <article class="prose" id="desc-preview"></article>
      </div>

      <div class="err" id="form-error" hidden></div>
      <div style="display:flex; gap:8px; margin-top: 12px;">
        <button type="submit" class="btn primary" id="btn-submit">Create</button>
        <a href="{{ url_for('index') }}" class="btn">Cancel</a>
        <span class="muted" id="form-note" style="display:none;">Submitting…</span>
      </div>
    </form>
  </div>

  <details style="margin-top:12px;">
    <summary><p style="display:inline">Debug</p></summary>
    <pre id="dbg" class="muted"></pre>
  </details>
</div>

<script>
(function(){
  const form = document.getElementById('job-form');
  const btn = document.getElementById('btn-submit');
  const errEl = document.getElementById('form-error');
  const dbg = document.getElementById('dbg');
  const note = document.getElementById('form-note');

  const isAgency = document.getElementById('IsAgency');
  const hireForLabel = document.getElementById('TheyHireForLabel');
  const hireForBox = document.getElementById('TheyHireForBox');
  const postedEl = document.getElementById('PostedDate');
  const preview = document.getElementById('desc-preview');

  // Quill init (no toolbar)
  const quill = new Quill('#editor', { theme: 'snow', modules: { toolbar: false, clipboard: { matchVisual: false } } });

  function toggleAgencyFields() {
    const show = isAgency.checked;
    hireForLabel.classList.toggle('hidden', !show);
    hireForBox.classList.toggle('hidden', !show);
  }
  isAgency.addEventListener('change', toggleAgencyFields);

  // Helper chips: click to fill
  document.querySelectorAll('.chips').forEach(group => {
    const targetId = group.getAttribute('data-target');
    const target = document.getElementById(targetId);
    group.addEventListener('click', (e) => {
      const chip = e.target.closest('.chip');
      if (!chip || !target) return;
      target.value = chip.textContent.trim();
      target.dispatchEvent(new Event('input'));
    });
  });

  // Prefill PostedDate with "now" in local tz (YYYY-MM-DDTHH:mm)
  function localNowForDatetimeLocal() {
    const d = new Date();
    const pad = n => String(n).padStart(2,'0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }
  if (!postedEl.value) {
    postedEl.value = localNowForDatetimeLocal();
    postedEl.dataset.lastDate = postedEl.value.slice(0,10);
  }
  // If user changes date part, snap time to 00:00
  postedEl.addEventListener('change', () => {
    const datePart = postedEl.value.slice(0,10);
    const last = postedEl.dataset.lastDate || '';
    if (datePart && datePart !== last) {
      postedEl.value = `${datePart}T00:00`;
    }
    postedEl.dataset.lastDate = datePart || '';
  });

  // Keep preview in sync
  function sanitizeForPreview(html) {
    if (!html) return '';
    const tmp = document.createElement('div');
    tmp.innerHTML = html;

    tmp.querySelectorAll('script,iframe,style,link,object,embed').forEach(el => el.remove());
    tmp.querySelectorAll('a[href]').forEach(a => {
      a.setAttribute('target','_blank');
      a.setAttribute('rel','noopener noreferrer nofollow');
    });
    tmp.querySelectorAll('img[src]').forEach(img => {
      const src = (img.getAttribute('src') || '').trim();
      if (!src.startsWith('data:')) {
        const ph = document.createElement('div');
        ph.className = 'placeholder-img';
        ph.textContent = 'External image blocked';
        img.replaceWith(ph);
      } else {
        img.loading = 'lazy';
        img.decoding = 'async';
      }
    });
    return tmp.innerHTML;
  }

  function updatePreview() {
    preview.innerHTML = sanitizeForPreview(quill.root.innerHTML || '');
  }
  quill.on('text-change', updatePreview);
  updatePreview();

  async function fetchWithRetry(url, options, attempts=4) {
    let delay = 500;
    for (let i=1;i<=attempts;i++){
      try {
        const resp = await fetch(url, options);
        if (!resp.ok) throw resp;
        return resp;
      } catch (e) {
        if (i===attempts) throw e;
        await new Promise(r=>setTimeout(r, delay));
        delay *= 2;
      }
    }
  }

  function getRadio(name) {
    const el = document.querySelector(`input[name="${name}"]:checked`);
    return el ? el.value : null;
  }

  function getFormData(){
    const o = {};
    o.Source = document.getElementById('Source').value.trim();
    o.Url = document.getElementById('Url').value.trim();
    o.ExternalId = document.getElementById('ExternalId').value.trim();
    o.Title = document.getElementById('Title').value.trim();
    o.Country = document.getElementById('Country').value.trim();
    o.Locality = document.getElementById('Locality').value.trim() || undefined;

    // Description from Quill (sanitized preview version)
    const rawHtml = quill.root.innerHTML || "";
    o.Description = sanitizeForPreview(rawHtml) || undefined;

    // RemoteType radios
    o.RemoteType = getRadio('RemoteType') || 'Unknown';

    // Company mapping
    const company = document.getElementById('Company').value.trim();
    if (isAgency.checked) {
      const hireFor = document.getElementById('TheyHireFor').value.trim();
      o.PostingCompanyName = company || undefined;
      o.HiringCompanyName = hireFor || 'Unknown';
    } else {
      o.HiringCompanyName = company || undefined;
      o.PostingCompanyName = undefined;
    }

    // PostedDate -> ISO (UTC) if present
    const pd = postedEl.value;
    if (pd) {
      const d = new Date(pd);
      if (!isNaN(d)) o.PostedDate = d.toISOString();
    }

    // Drop empty
    for (const k of Object.keys(o)) {
      if (o[k] === undefined || o[k] === null || o[k] === '') delete o[k];
    }
    return o;
  }

  function validateClient(o){
    const req = ["Source","ExternalId","Url","HiringCompanyName","Title","Country"];
    const miss = req.filter(k=>!o[k]);
    if (miss.length) return "Missing required: " + miss.join(", ");

    try { new URL(o.Url); } catch { return "Invalid URL in Url"; }

    const caps = {
      Source:100, ExternalId:200, Url:1000, HiringCompanyName:300,
      PostingCompanyName:300, Title:300, Country:100, Locality:300,
      RemoteType:50, Description:5000
    };
    for (const [k,max] of Object.entries(caps)) {
      if (o[k] && String(o[k]).length > max) return `${k} exceeds max length (${max})`;
    }
    return null;
  }

  function setBusy(b){
    btn.disabled = b;
    note.style.display = b ? 'inline' : 'none';
    btn.textContent = b ? "Creating…" : "Create";
  }

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    errEl.hidden = true; errEl.textContent = '';

    const payload = getFormData();
    const msg = validateClient(payload);
    if (msg) { errEl.hidden = false; errEl.textContent = msg; return; }

    setBusy(true);
    try{
      dbg.textContent = JSON.stringify(payload, null, 2);
      const resp = await fetchWithRetry('/ui/jobs', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'same-origin',
        body: JSON.stringify(payload)
      }, 4);

      const body = await resp.json();
      if (resp.status === 201 && body?.id) {
        const id = encodeURIComponent(body.id);
        window.location.assign(`/jobs/${id}`);
        return;
      }
      errEl.hidden = false; errEl.textContent = body?.message || 'Failed to create';
    } catch (e) {
      let msg = 'Failed to create';
      if (e && typeof e.text === 'function') {
        try { msg = await e.text(); } catch {}
      }
      errEl.hidden = false; errEl.textContent = msg;
    } finally {
      setBusy(false);
    }
  });

  // init
  document.addEventListener('DOMContentLoaded', () => {
    toggleAgencyFields();
  });
})();
</script>
{% endblock %}
