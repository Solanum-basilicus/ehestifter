{% extends "base.html" %}

{% block head_extra %}
<style>
  .line-clamp-2 { line-clamp: 2; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
  .truncate-1 { overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
  .card { border:1px solid #e5e7eb; border-radius:12px; background:#fff; }
  .muted { color:#6b7280; }
  .badge { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #e5e7eb; font-size:12px; }
  .btn { padding:6px 10px; border-radius:8px; border:1px solid #e5e7eb; background:#f9fafb; cursor:not-allowed; opacity:.7; }
  .btn.primary { background:#eef2ff; border-color:#c7d2fe; }
  .btn.ghost { background:transparent; }
  .btn[aria-disabled="false"] { cursor:pointer; opacity:1; }
  .skeleton { background:linear-gradient(90deg,#f4f4f5 25%,#e5e7eb 37%,#f4f4f5 63%); background-size:400% 100%; animation:shimmer 1.2s infinite; border-radius:6px; }
  @keyframes shimmer { 0% { background-position:100% 0; } 100% { background-position:-100% 0; } }
  .prose img { max-width:100%; height:auto; border-radius:8px; }
  .right-rail { width:320px; }
  .sticky-top { position:sticky; top:0; z-index:10; backdrop-filter:saturate(180%) blur(6px); background:rgba(255,255,255,.85); }
  .grid { display:grid; gap:16px; }
  @media (min-width: 1024px) { .grid-main { grid-template-columns: 1fr 320px; } }
  .flex { display:flex; gap:8px; align-items:center; }
  .flex-between { display:flex; justify-content:space-between; align-items:flex-start; gap:12px; }
  .sep-vert { width:1px; height:16px; background:#e5e7eb; margin:0 6px; }
  .placeholder-img { width:100%; height:128px; border-radius:8px; background:#f3f4f6; color:#6b7280;
    display:flex; align-items:center; justify-content:center; font-size:12px; }
</style>

<!-- self-hosted scripts -->
<script src="{{ url_for('static', filename='js/htmx.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/alpine.min.js') }}" defer></script>
{% endblock %}

{% block content %}
<div x-data="jobDetailPage('{{ job_id }}')" x-init="init()" class="mx-auto" style="max-width:1100px; padding:16px;">
  <!-- Sticky meta card -->
  <div class="card sticky-top" style="padding:12px 16px;">
    <div class="flex-between">
      <div style="min-width:0;">
        <div class="flex" style="gap:6px; align-items:center;">
          <h1 class="line-clamp-2" :title="meta.title" style="font-size:20px; font-weight:600; margin:0;">
            <span x-text="meta.title"></span>
          </h1>
          <button class="btn ghost" @click="copy(meta.title)" aria-label="Copy job title" aria-disabled="false">📋</button>
        </div>

        <div class="flex muted" style="flex-wrap:wrap; font-size:14px;">
          <div class="truncate-1" style="max-width:36ch;" :title="companyLine()">
            <span x-text="companyLine()"></span>
          </div>
          <button class="btn ghost" @click="copy(companyLine())" aria-label="Copy company" aria-disabled="false">📋</button>

          <template x-if="geoLine()">
            <div class="flex">
              <div class="sep-vert"></div>
              <div class="truncate-1" style="max-width:28ch;" :title="geoLine()" x-text="geoLine()"></div>
            </div>
          </template>

          <template x-if="meta.applyUrl">
            <div class="flex">
              <div class="sep-vert"></div>
              <a class="muted" :href="meta.applyUrl" target="_blank" rel="noopener noreferrer">Apply now 🔗</a>
            </div>
          </template>

          <template x-if="meta.url">
            <div class="flex">
              <div class="sep-vert"></div>
              <a :href="meta.url" target="_blank" rel="noopener noreferrer">open original 🔗</a>
            </div>
          </template>
        </div>
      </div>

      <div style="text-align:right;">
        <div class="muted" style="font-size:11px; text-transform:uppercase; letter-spacing:.04em;" x-text="seenPrefix()"></div>
        <div style="font-size:14px;" x-text="relativeSeen()"></div>
        <template x-if="(meta.repostCount||0) > 0">
          <div class="muted" style="font-size:12px;">bumped <span x-text="meta.repostCount"></span> times</div>
        </template>
      </div>
    </div>
  </div>

  <!-- App controls -->
  <div class="card private-block"
      style="padding:12px 16px; margin-top:12px;"
      x-data="jobStatusComponent({ jobId: '{{ job_id }}' })"
      x-init="init()">

    <div class="flex-between" style="align-items:center;">
      <!-- LEFT: label + status text + time + buttons (inline) -->
      <div class="flex" style="min-width:0; flex-wrap:wrap; gap:10px; align-items:center;">
        <!-- label styled like your section headers -->
        <div style="font-weight:600;">This position and you:</div>

        <!-- status text (unchanged logic, no pill) -->
        <span class="status-badge"
              :data-k="pending ? 'unset' : statusKey(app.state)"
              x-text="pending ? 'loading…' : (app.state || 'Unset')"></span>

        <!-- relative time, if you later surface changedAtUtc -->
        <template x-if="app.changedAtUtc">
          <div class="flex muted" style="font-size:14px;">
            ⏱ <span x-text="relativeFromUtc(app.changedAtUtc)"></span>
          </div>
        </template>

        <!-- buttons inline next to status -->
        <div class="flex" style="gap:.5rem;">
          <button class="btn"
                  x-show="!editing"
                  @click="startEditing()"
                  :disabled="pending"
                  :aria-disabled="pending ? 'true' : 'false'">change</button>

          <button class="btn primary"
                  x-show="editing"
                  @click="save()"
                  :disabled="pending"
                  :aria-disabled="pending ? 'true' : 'false'">
            <span x-show="!pending">save</span>
            <span x-show="pending">saving…</span>
          </button>

          <button class="btn"
                  x-show="editing"
                  @click="cancelEditing()"
                  :disabled="pending"
                  :aria-disabled="pending ? 'true' : 'false'">cancel</button>
        </div>
      </div>

      <!-- RIGHT: private chip -->
      <div class="flex" style="gap:.5rem;">
        <span class="chip-private">🔒 Only you</span>
      </div>
    </div>

    <!-- Editor row -->
    <div x-show="editing" style="margin-top:10px;">
      <label for="statusSelect" class="muted" style="display:block; font-size:14px; margin-bottom:6px;">Select status</label>
      <select id="statusSelect"
              x-model="selected"
              @change="selected = $event.target.value"
              :disabled="pending"
              style="min-width:260px;">
        <template x-for="opt in statusOptions" :key="opt">
          <option :value="opt" x-text="opt"></option>
        </template>
      </select>
      <p class="muted" x-show="error" x-text="error" style="margin-top:8px; color:#a00;"></p>
    </div>
  </div>

  <!-- Main grid -->
  <div class="grid grid-main" style="margin-top:12px;">
    <div>
      <!-- Description -->
      <div class="card" style="padding:14px;">
        <div class="flex-between" style="margin-bottom:6px;"><div style="font-weight:600;">Full description</div></div>
        <template x-if="!descLoaded">
          <div>
            <div class="skeleton" style="height:24px; width:50%; margin:8px 0;"></div>
            <div class="skeleton" style="height:16px; width:100%; margin:6px 0;"></div>
            <div class="skeleton" style="height:16px; width:90%;  margin:6px 0;"></div>
            <div class="skeleton" style="height:16px; width:80%;  margin:6px 0;"></div>
            <div class="skeleton" style="height:16px; width:70%;  margin:6px 0;"></div>
          </div>
        </template>
        <article class="prose" x-show="descLoaded" x-html="safeDescription"></article>
      </div>

      <!-- Personal comments -->
      <div class="card private-block" style="padding:14px; margin-top:12px;">
        <div class="flex-between">
          <div style="font-weight:600;">Your thoughts on this job</div>
          <div class="flex" style="gap:.5rem;">
            <span class="chip-private">🔒 Only you</span>
            <button class="btn" :aria-disabled="!descLoaded" :disabled="!descLoaded">Add</button>
          </div>
        </div>
        <hr style="border:none; border-top:1px solid #f3f4f6; margin:10px 0;">
        <div class="muted" style="font-size:14px;">Nothing saved yet</div>
      </div>

      <!-- History -->
      <div class="card" style="padding:14px; margin-top:12px;">
        <div style="font-weight:600; margin-bottom:6px;">History</div>
        <div class="muted" style="font-size:14px;">No events yet</div>
      </div>
    </div>

    <!-- Right rail: Enrichers -->
    <aside class="right-rail" style="position:sticky; top:80px; height:fit-content;">
      <div class="grid">

        <div class="card private-block" style="padding:12px;">
          <div class="flex-between">
            <div><div style="font-weight:600;">Compatibility Score</div><div class="muted" style="font-size:12px;">no autorun</div></div>
            <div class="flex" style="gap:.5rem;"><span class="chip-private">🔒 Only you</span></div>
          </div>
          <div style="font-family:monospace; margin:8px 0;">⬡⬡⬡⬡⬡⬡⬡⬡⬡⬡ ?.??</div>
          <div class="flex"><button class="btn" disabled>▶ run</button><button class="btn" disabled>🔎 inspect</button></div>
        </div>

        <div class="card private-block" style="padding:12px;">
          <div class="flex-between">
            <div><div style="font-weight:600;">CV composer</div><div class="muted" style="font-size:12px;">no autorun</div></div>
            <div class="flex" style="gap:.5rem;"><span class="chip-private">🔒 Only you</span></div>
          </div>
          <div style="font-family:monospace; margin:8px 0;">no file to download</div>
          <div class="flex"><button class="btn" disabled>▶ run</button><button class="btn" disabled>🔎 inspect</button></div>
        </div>
      </div>
    </aside>
  </div>
</div>

<script>
  // Alpine components must be registered inside alpine:init
  document.addEventListener('alpine:init', () => {
    Alpine.data('jobStatusComponent', ({ jobId }) => ({
      app: { state: null, changedAtUtc: null },
      statusOptions: window.Status.STATUS_OPTIONS,
      selected: null,
      editing: false,
      pending: true, 
      error: "",

      statusKey: window.Status.statusKey,

      startEditing(){
        if (this.pending) return;
        this.editing = true;
        const next = window.Status.suggestNext(this.app.state || "Unset");
        this.selected = this.statusOptions.includes(next) ? next : this.statusOptions[0];
      },
      cancelEditing(){
        this.editing = false;
        this.selected = this.statusOptions.includes(this.app.state)
          ? this.app.state
          : this.statusOptions[0];
      },

      async init() { await this.refresh(); },

      async refresh(){
        this.pending = true; this.error = "";
        try{
          const resp = await fetch(`/ui/jobs/${jobId}/status`, { credentials: 'same-origin' });
          if(!resp.ok) throw new Error('HTTP '+resp.status);
          const data = await resp.json();
          this.app.state = data.status || "Unset";
          // if we’re currently editing, keep the predictive selection; otherwise, align to current
          if (!this.editing){
            this.selected = this.statusOptions.includes(this.app.state) ? this.app.state : this.statusOptions[0];
          }
        }catch(e){
          this.error = "Could not load status - please try again.";
        }finally{
          this.pending = false;
        }
      },

      async save() {
        if (this.pending) return;
        this.pending = true;
        this.error = "";
        try {
          // Guard against Unset
          const toSend = this.statusOptions.includes(this.selected)
                        ? this.selected
                        : this.statusOptions[0];

          const resp = await fetch(`/ui/jobs/${jobId}/status`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ status: toSend })
          });
          if (!resp.ok) throw new Error('HTTP ' + resp.status);
          const data = await resp.json();

          this.app.state = data.status || toSend;
          this.editing = false;
        } catch (e) {
          this.error = "Could not set status - please try again.";
        } finally {
          this.pending = false;
        }
      },

      // Reuse outer helper if present
      relativeFromUtc(iso){ return window.__relativeFromUtc?.(iso) ?? ''; }
    }));

    Alpine.data('jobDetailPage', (jobId) => ({
      jobId,
      _inited: false,
      meta: {
        title: "", company: "", postingCompany: "", country: "", locality: "",
        remoteType: "", firstSeenUtc: "", lastSeenUtc: "", repostCount: 0, url: "", applyUrl: ""
      },
      app: { state: "New", changedAtUtc: null },
      safeDescription: "",
      descLoaded: false,

      async init() {
        if (this._inited) return;
        this._inited = true;

        const tryFetch = async () => {
          const r = await fetch(`/ui/jobs/${this.jobId}`, { credentials: 'same-origin' });
          if (!r.ok) throw new Error(`HTTP ${r.status}`);
          return r.json();
        };

        try {
          let payload;
          try {
            payload = await tryFetch();
          } catch {
            await new Promise(res => setTimeout(res, 1200));
            payload = await tryFetch();
          }
          window.__lastJobPayload = payload;
          this.hydrateFromPayload(payload);
          this.descLoaded = true;
        } catch (e) {
          this.safeDescription = `<p class="muted">Unable to load description right now.</p>`;
          this.descLoaded = true;
        }
      },

      get(obj, keys) {
        for (const k of keys) if (obj && obj[k] != null) return obj[k];
        return undefined;
      },

      hydrateFromPayload(p) {
        const title          = this.get(p, ["Title","title","JobTitle"]) || "";
        const company        = this.get(p, ["HiringCompanyName","Company","CompanyName"]) || "";
        const postingCompany = this.get(p, ["PostingCompanyName","PostingCompany","PostedBy"]) || "";
        const country        = this.get(p, ["Country"]) || "";
        const locality       = this.get(p, ["Locality","City"]) || "";
        const remoteType     = this.get(p, ["RemoteType","remote_type"]) || "";

        const firstSeenUtc   = this.get(p, ["FirstSeenAt","PostedDate","CreatedAt"]) || "";
        const lastSeenUtc    = this.get(p, ["LastSeenAt","UpdatedAt"]) || firstSeenUtc || "";

        let repostCount = Number.parseInt(this.get(p, ["RepostCount","repostCount"]) || 0, 10);
        if (!Number.isFinite(repostCount)) repostCount = 0;

        const url      = this.get(p, ["Url","OriginalUrl"]) || "";
        const applyUrl = this.get(p, ["ApplyUrl","ApplyLink"]) || "";

        this.meta = { title, company, postingCompany, country, locality, remoteType,
                      firstSeenUtc, lastSeenUtc, repostCount, url, applyUrl };

        const raw = this.get(p, ["descriptionHtml","Description","Html"]) || "";
        this.safeDescription = this.sanitizeDescription(raw);

        const appState = this.get(p, ["appState","Application"]) || {};
        this.app = {
          state: this.get(appState, ["state","State"]) || this.app.state,
          changedAtUtc: this.get(appState, ["changedAtUtc","ChangedAtUtc","changed_at_utc"]) || null
        };
      },

      sanitizeDescription(html) {
        if (!html) return "";
        const tmp = document.createElement('div');
        tmp.innerHTML = html;
        tmp.querySelectorAll('script,iframe,style,link,object,embed').forEach(el => el.remove());
        tmp.querySelectorAll('a[href]').forEach(a => { a.target = '_blank'; a.rel = 'noopener noreferrer nofollow'; });
        tmp.querySelectorAll('img[src]').forEach(img => {
          const src = (img.getAttribute('src') || '').trim();
          if (!src.startsWith('data:')) {
            const ph = document.createElement('div');
            ph.className = 'placeholder-img';
            ph.textContent = 'External image blocked';
            img.replaceWith(ph);
          } else {
            img.loading = 'lazy'; img.decoding = 'async';
          }
        });
        return tmp.innerHTML;
      },

      companyLine() {
        return this.meta.postingCompany
          ? `${this.meta.company}, through ${this.meta.postingCompany}`
          : this.meta.company || "";
      },
      geoLine() {
        const parts = [];
        if (this.meta.country) parts.push(this.meta.country);
        if (this.meta.locality) parts.push(`(${this.meta.locality})`);
        if (this.meta.remoteType) parts.push(this.meta.remoteType);
        return parts.join(', ');
      },
      seenPrefix() { return (this.meta.repostCount || 0) === 0 ? 'First seen' : 'Last seen'; },
      relativeSeen() { return this.relativeFromUtc((this.meta.repostCount||0)===0 ? this.meta.firstSeenUtc : this.meta.lastSeenUtc); },

      relativeFromUtc(iso) {
        if (!iso) return '';
        const now = new Date();
        const todayUTC = Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate());
        const d = new Date(iso);
        const targetUTC = Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate());
        const diff = Math.floor((todayUTC - targetUTC) / (24*3600*1000));
        if (diff <= 0) return 'Today';
        if (diff === 1) return 'Yesterday';
        return `${diff} days ago`;
      },

      copy(text) { navigator.clipboard?.writeText(text).catch(()=>{}); }
    }));
  });

  // Expose helper so jobStatusComponent can reuse it
  window.__relativeFromUtc = (iso) => {
    if (!iso) return '';
    const now = new Date();
    const todayUTC = Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate());
    const d = new Date(iso);
    const targetUTC = Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate());
    const diff = Math.floor((todayUTC - targetUTC) / (24*3600*1000));
    if (diff <= 0) return 'Today';
    if (diff === 1) return 'Yesterday';
    return `${diff} days ago`;
  };
</script>


{% endblock %}
