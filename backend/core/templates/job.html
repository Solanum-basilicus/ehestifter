{% extends "base.html" %}

{% block head_extra %}
<style>
  .line-clamp-2 { line-clamp: 2; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
  .truncate-1 { overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
  .card { border:1px solid #e5e7eb; border-radius:12px; background:#fff; }
  .muted { color:#6b7280; }
  .badge { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #e5e7eb; font-size:12px; }
  .btn { padding:6px 10px; border-radius:8px; border:1px solid #e5e7eb; background:#f9fafb; cursor:not-allowed; opacity:.7; }
  .btn.primary { background:#eef2ff; border-color:#c7d2fe; }
  .btn.ghost { background:transparent; }
  .btn.danger { background:#fee2e2; border-color:#fecaca; }
  .btn[disabled] { cursor:not-allowed; opacity:.5; }
  .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:1000; }
  .modal { width:min(520px,92vw); background:#fff; border-radius:12px; border:1px solid #e5e7eb; box-shadow:0 10px 30px rgba(0,0,0,.1); } 
  /* two-column layout for status + actions block */
  .row-actions { display:grid; grid-template-columns: 1fr; gap:12px; } @media (min-width: 900px){ .row-actions { grid-template-columns: 1fr 280px; } }
  .btn[aria-disabled="false"] { cursor:pointer; opacity:1; }
  .skeleton { background:linear-gradient(90deg,#f4f4f5 25%,#e5e7eb 37%,#f4f4f5 63%); background-size:400% 100%; animation:shimmer 1.2s infinite; border-radius:6px; }
  @keyframes shimmer { 0% { background-position:100% 0; } 100% { background-position:-100% 0; } }
  .prose img { max-width:100%; height:auto; border-radius:8px; }
  .right-rail { width:320px; }
  .sticky-top { position:sticky; top:0; z-index:10; backdrop-filter:saturate(180%) blur(6px); background:rgba(255,255,255,.85); }
  .grid { display:grid; gap:16px; }
  @media (min-width: 1024px) { .grid-main { grid-template-columns: 1fr 320px; } }
  .flex { display:flex; gap:8px; align-items:center; }
  .flex-between { display:flex; justify-content:space-between; align-items:flex-start; gap:12px; }
  .sep-vert { width:1px; height:16px; background:#e5e7eb; margin:0 6px; }
  .placeholder-img { width:100%; height:128px; border-radius:8px; background:#f3f4f6; color:#6b7280;
    display:flex; align-items:center; justify-content:center; font-size:12px; }
  /* History */
  .hist-list { display:grid; gap:10px; }
  .hist-item { display:flex; align-items:flex-start; gap:10px; }
  .hist-ts { width:140px; flex:0 0 140px; color:#6b7280; font-size:12px; line-height:1.3; }
  .hist-body { flex:1; min-width:0; }
  .hist-kind { font-weight:600; }
  .hist-deltas { margin:6px 0 0; padding:0; list-style:none; }
  .hist-deltas li { margin:2px 0; font-size:14px; }
  .hist-pills { display:inline-flex; gap:6px; align-items:center; }

  .chip { display:inline-block; font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid #e5e7eb; background:#f9fafb; }
  .chip.info { background:#eef2ff; border-color:#c7d2fe; }

  .hist-skeleton .line { height:14px; border-radius:6px; }
  .hist-skeleton .line.w40 { width:40%; } .hist-skeleton .line.w60 { width:60%; }
  .hist-skeleton .line.w80 { width:80%; } .hist-skeleton .line.w100 { width:100%; }
  .hist-footer { margin-top:10px; display:flex; gap:8px; }
</style>

<!-- self-hosted scripts -->
<script src="{{ url_for('static', filename='js/htmx.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/alpine.min.js') }}" defer></script>
{% endblock %}

{% block content %}
<div x-data="jobDetailPage('{{ job_id }}')" x-init="init()" class="mx-auto" style="max-width:1100px; padding:16px;">
  <!-- Sticky meta card -->
  <div class="card sticky-top" style="padding:12px 16px;">
    <div class="flex-between">
      <div style="min-width:0;">
        <div class="flex" style="gap:6px; align-items:center;">
          <h1 class="line-clamp-2" :title="meta.title" style="font-size:20px; font-weight:600; margin:0;">
            <span x-text="meta.title"></span>
          </h1>
          <button class="btn ghost" @click="copy(meta.title)" aria-label="Copy job title" aria-disabled="false">üìã</button>
        </div>

        <div class="flex muted" style="flex-wrap:wrap; font-size:14px;">
          <div class="truncate-1" style="max-width:36ch;" :title="companyLine()">
            <span x-text="companyLine()"></span>
          </div>
          <button class="btn ghost" @click="copy(companyLine())" aria-label="Copy company" aria-disabled="false">üìã</button>

          <template x-if="geoLine()">
            <div class="flex">
              <div class="sep-vert"></div>
              <div class="truncate-1" style="max-width:28ch;" :title="geoLine()" x-text="geoLine()"></div>
            </div>
          </template>

          <template x-if="meta.applyUrl">
            <div class="flex">
              <div class="sep-vert"></div>
              <a class="muted" :href="meta.applyUrl" target="_blank" rel="noopener noreferrer">Apply now üîó</a>
            </div>
          </template>

          <!-- Found on -->
          <template x-if="meta.foundOn">
            <div class="flex">
              <div class="sep-vert"></div>
              <span class="badge" x-text="'found on ' + meta.foundOn"></span>
            </div>
          </template>

          <!-- ATS / Provider -->
          <template x-if="providerLine()">
            <div class="flex">
              <div class="sep-vert"></div>
              <span class="badge" x-text="providerLine()"></span>
            </div>
          </template>

          <template x-if="meta.url">
            <div class="flex">
              <div class="sep-vert"></div>
              <a :href="meta.url" target="_blank" rel="noopener noreferrer">open original üîó</a>
            </div>
          </template>
        </div>
      </div>

      <div style="text-align:right;">
        <div class="muted" style="font-size:11px; text-transform:uppercase; letter-spacing:.04em;" x-text="seenPrefix()"></div>
        <div style="font-size:14px;" x-text="relativeSeen()"></div>
        <template x-if="(meta.repostCount||0) > 0">
          <div class="muted" style="font-size:12px;">bumped <span x-text="meta.repostCount"></span> times</div>
        </template>
      </div>
    </div>
  </div>

  <!-- App controls -->
  <div class="row-actions">
    <div class="card private-block"
        style="padding:12px 16px; margin-top:12px;"
        x-data="jobStatusComponent({ jobId: '{{ job_id }}' })"
        x-init="init()">
      
        <!-- LEFT COLUMN: status controls -->
        <div class="flex" style="min-width:0; flex-wrap:wrap; gap:10px; align-items:center;">
          <!-- label styled like your section headers -->
          <div style="font-weight:600;">This position and you:</div>
          <span class="chip-private" style="margin-left:2px;">üîí Only you</span>

          <!-- status text (unchanged logic, no pill) -->
          <span class="status-badge"
                :data-k="pending ? 'unset' : statusKey(app.state)"
                x-text="pending ? 'loading‚Ä¶' : (app.state || 'Unset')"></span>

          <!-- relative time, if you later surface changedAtUtc -->
          <template x-if="app.changedAtUtc">
            <div class="flex muted" style="font-size:14px;">
              <span x-text="relativeFromLocal(app.changedAtUtc)"></span>
            </div>
          </template>

          <!-- buttons inline next to status -->
          <div class="flex" style="gap:.5rem;">
            <button class="btn"
                    x-show="!editing"
                    @click="startEditing()"
                    :disabled="pending"
                    :aria-disabled="pending ? 'true' : 'false'">change</button>

            <button class="btn primary"
                    x-show="editing"
                    @click="save()"
                    :disabled="pending"
                    :aria-disabled="pending ? 'true' : 'false'">
              <span x-show="!pending">save</span>
              <span x-show="pending">saving‚Ä¶</span>
            </button>

            <button class="btn"
                    x-show="editing"
                    @click="cancelEditing()"
                    :disabled="pending"
                    :aria-disabled="pending ? 'true' : 'false'">cancel</button>
          </div>
        </div>

      <!-- Editor row -->
      <div x-show="editing" style="margin-top:10px;">
        <label for="statusSelect" class="muted" style="display:block; font-size:14px; margin-bottom:6px;">Select status</label>
        <select id="statusSelect"
                x-model="selected"
                @change="selected = $event.target.value"
                :disabled="pending"
                style="min-width:260px;">
          <template x-for="opt in statusOptions" :key="opt">
            <option :value="opt" x-text="opt"></option>
          </template>
        </select>
        <p class="muted" x-show="error" x-text="error" style="margin-top:8px; color:#a00;"></p>
      </div>
    </div>

    <!-- RIGHT COLUMN: job actions block (separate from private status area) -->
    <div class="card" style="padding:12px 16px; margin-top:12px;">
      <div class="flex" style="gap:8px; align-items:center; flex-wrap:wrap;">
        <button class="btn" title="Edit job (coming soon)" disabled>‚úèÔ∏è Edit</button>
        <button class="btn danger"
                :disabled="!canEdit"
                :aria-disabled="canEdit ? 'false' : 'true'"
                :title="deleteDebugTitle()"
                @click="openDeleteModal()">
          üóëÔ∏è Delete
        </button>
      </div>
    </div>    
  </div>

<!-- Delete confirmation modal -->
<div id="delete-modal" class="modal-backdrop" x-show="deleteModalOpen" x-transition
     @click.self="closeDeleteModal()" style="display:none;">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="del-title">
    <header id="del-title" style="padding:14px 16px; border-bottom:1px solid #e5e7eb; font-weight:600;">Delete job?</header>
    <div class="body" style="padding:16px; color:#374151;">
      <p>Once it's gone it's gone, you can't revert that. Really want to delete this job from the system?</p>
      <div class="err" x-text="deleteError" style="color:#b91c1c; margin-top:8px; min-height:20px;"></div>
    </div>
    <footer style="padding:12px 16px; border-top:1px solid #e5e7eb; display:flex; gap:8px; justify-content:flex-end;">
      <button class="btn" @click="closeDeleteModal()" :disabled="deleteBusy">Cancel</button>
      <button class="btn danger" @click="confirmDelete()" :disabled="deleteBusy"><span x-show="!deleteBusy">Yes, delete</span><span x-show="deleteBusy">Deleting‚Ä¶</span></button>
    </footer>
  </div>
</div>

  <!-- Main grid -->
  <div class="grid grid-main" style="margin-top:12px;">
    <div>
      <!-- Description -->
      <div class="card" style="padding:14px;">
        <div class="flex-between" style="margin-bottom:6px;"><div style="font-weight:600;">Full description</div></div>
        <template x-if="!descLoaded">
          <div>
            <div class="skeleton" style="height:24px; width:50%; margin:8px 0;"></div>
            <div class="skeleton" style="height:16px; width:100%; margin:6px 0;"></div>
            <div class="skeleton" style="height:16px; width:90%;  margin:6px 0;"></div>
            <div class="skeleton" style="height:16px; width:80%;  margin:6px 0;"></div>
            <div class="skeleton" style="height:16px; width:70%;  margin:6px 0;"></div>
          </div>
        </template>
        <article class="prose" x-show="descLoaded" x-html="safeDescription"></article>
      </div>

      <!-- Personal comments -->
      <div class="card private-block" style="padding:14px; margin-top:12px;">
        <div class="flex-between">
          <div style="font-weight:600;">Your thoughts on this job</div>
          <div class="flex" style="gap:.5rem;">
            <span class="chip-private">üîí Only you</span>
            <button class="btn" :aria-disabled="!descLoaded" :disabled="!descLoaded">Add</button>
          </div>
        </div>
        <hr style="border:none; border-top:1px solid #f3f4f6; margin:10px 0;">
        <div class="muted" style="font-size:14px;">Nothing saved yet</div>
      </div>

      <!-- History -->
      <div class="card" style="padding:14px; margin-top:12px;">
        <div style="font-weight:600; margin-bottom:6px;">History</div>

        <!-- Loading skeleton -->
        <div x-show="!history.loaded && !history.error" class="hist-skeleton">
          <div class="skeleton line w60" style="margin:6px 0;"></div>
          <div class="skeleton line w80" style="margin:6px 0;"></div>
          <div class="skeleton line w40" style="margin:6px 0;"></div>
        </div>

        <!-- Error + retry -->
        <template x-if="history.error">
          <div class="muted" style="font-size:14px;">
            Could not load history.
            <button class="btn" @click="loadHistory()" aria-disabled="false">Retry</button>
          </div>
        </template>

        <!-- Empty state -->
        <template x-if="history.loaded && history.items.length === 0 && !history.error">
          <div class="muted" style="font-size:14px;">No events yet</div>
        </template>

        <!-- List -->
        <div class="hist-list" x-show="history.items.length > 0">
          <template x-for="item in history.items" :key="item.id">
            <div class="hist-item">
              <div class="hist-ts">
                <div x-text="relativeFromLocal(item.timestamp)"></div>
                <div :title="new Date(item.timestamp).toLocaleString()" class="muted" style="font-size:11px;">
                  <span x-text="formatLocalHM(item.timestamp)"></span>
                  <span x-text="localTzAbbr(item.timestamp)"></span>
                </div>
              </div>

              <div class="hist-body">
                <!-- status_changed -->
                <template x-if="item.kind === 'status_changed'">
                  <div>
                    <span class="hist-kind">Status updated</span>
                    <div class="hist-pills" style="margin-top:4px;">
                      <span class="status-badge" :data-k="Status.statusKey(item.data?.from || 'Unset')" x-text="item.data?.from || 'Unset'"></span>
                      <span style="font-size:12px; color:#6b7280;">‚Üí</span>
                      <span class="status-badge" :data-k="Status.statusKey(item.data?.to || 'Unset')" x-text="item.data?.to || 'Unset'"></span>
                    </div>
                  </div>
                </template>

                <!-- job_updated -->
                <template x-if="item.kind === 'job_updated'">
                  <div>
                    <span class="hist-kind">Job updated</span>
                    <ul class="hist-deltas">
                      <template x-for="(chg, field) in (item.data?.changed || {})" :key="field">
                        <li>
                          <span style="font-weight:600;" x-text="field"></span>:
                          <span class="muted" x-text="safeStr(chg.from)"></span>
                          <span style="color:#6b7280;">‚Üí</span>
                          <span x-text="safeStr(chg.to)"></span>
                        </li>
                      </template>
                      <li x-show="item.data?.descriptionChanged">
                        <span class="chip info">Description updated</span>
                      </li>
                    </ul>
                  </div>
                </template>

                <!-- job_created -->
                <template x-if="item.kind === 'job_created'">
                  <div><span class="hist-kind">Job was created</span></div>
                </template>

                <!-- job_deleted -->
                <template x-if="item.kind === 'job_deleted'">
                  <div><span class="hist-kind">Job was deleted</span></div>
                </template>

                <!-- enrichment_requested / enrichment_finished (simple text for now) -->
                <template x-if="item.kind === 'enrichment_requested'">
                  <div>
                    <span class="hist-kind">Enrichment requested</span>
                    <span class="muted" x-text="`(${item.data?.enricher || 'Unknown'})`"></span>
                  </div>
                </template>
                <template x-if="item.kind === 'enrichment_finished'">
                  <div>
                    <span class="hist-kind">Enrichment finished</span>
                    <span class="muted" x-text="`(${item.data?.enricher || 'Unknown'})`"></span>
                  </div>
                </template>

                <!-- Fallback -->
                <template x-if="!['status_changed','job_updated','job_created','job_deleted','enrichment_requested','enrichment_finished'].includes(item.kind)">
                  <div>
                    <span class="hist-kind" x-text="item.kind || 'event'"></span>
                  </div>
                </template>
              </div>
            </div>
          </template>
        </div>

        <!-- Footer: pagination controls -->
        <div class="hist-footer" x-show="history.loaded && (history.nextCursor || history.loadingMore)">
          <button class="btn" @click="loadMore()" :aria-disabled="history.loadingMore ? 'true' : 'false'" :disabled="history.loadingMore">
            <span x-show="!history.loadingMore">Load more</span>
            <span x-show="history.loadingMore">Loading‚Ä¶</span>
          </button>
        </div>
      </div>




    </div>

    <!-- Right rail: Enrichers -->
    <aside class="right-rail" style="position:sticky; top:80px; height:fit-content;">
      <div class="grid">

        <div class="card private-block" style="padding:12px;">
          <div class="flex-between">
            <div><div style="font-weight:600;">Compatibility Score</div><div class="muted" style="font-size:12px;">no autorun</div></div>
            <div class="flex" style="gap:.5rem;"><span class="chip-private">üîí Only you</span></div>
          </div>
          <div style="font-family:monospace; margin:8px 0;">‚¨°‚¨°‚¨°‚¨°‚¨°‚¨°‚¨°‚¨°‚¨°‚¨° ?.??</div>
          <div class="flex"><button class="btn" disabled>‚ñ∂ run</button><button class="btn" disabled>üîé inspect</button></div>
        </div>

        <div class="card private-block" style="padding:12px;">
          <div class="flex-between">
            <div><div style="font-weight:600;">CV composer</div><div class="muted" style="font-size:12px;">no autorun</div></div>
            <div class="flex" style="gap:.5rem;"><span class="chip-private">üîí Only you</span></div>
          </div>
          <div style="font-family:monospace; margin:8px 0;">no file to download</div>
          <div class="flex"><button class="btn" disabled>‚ñ∂ run</button><button class="btn" disabled>üîé inspect</button></div>
        </div>
      </div>
    </aside>
  </div>
</div>














<script>
  // Alpine components must be registered inside alpine:init
  document.addEventListener('alpine:init', () => {

    
    // That one is for user's job status manipulations
    Alpine.data('jobStatusComponent', ({ jobId }) => ({
      jobId,
      app: { state: null, changedAtUtc: null },
      statusOptions: window.Status.STATUS_OPTIONS,
      selected: null,
      editing: false,
      pending: true, 
      error: "",

      statusKey: window.Status.statusKey,

      startEditing(){
        if (this.pending) return;
        this.editing = true;
        const next = window.Status.suggestNext(this.app.state || "Unset");
        this.selected = this.statusOptions.includes(next) ? next : this.statusOptions[0];
      },
      cancelEditing(){
        this.editing = false;
        this.selected = this.statusOptions.includes(this.app.state)
          ? this.app.state
          : this.statusOptions[0];
      },

      async init() { await this.refresh(); },

      async refresh(){
        this.pending = true; this.error = "";
        try{
          const resp = await fetch(`/ui/jobs/${jobId}/status`, { credentials: 'same-origin' });
          if(!resp.ok) throw new Error('HTTP '+resp.status);
          const data = await resp.json();
          this.app.state = data.status || "Unset";
          // if we‚Äôre currently editing, keep the predictive selection; otherwise, align to current
          if (!this.editing){
            this.selected = this.statusOptions.includes(this.app.state) ? this.app.state : this.statusOptions[0];
          }
        }catch(e){
          this.error = "Could not load status - please try again.";
        }finally{
          this.pending = false;
        }
      },

      async save() {
        if (this.pending) return;
        this.pending = true;
        this.error = "";
        try {
          // Guard against Unset
          const toSend = this.statusOptions.includes(this.selected)
                        ? this.selected
                        : this.statusOptions[0];

          const resp = await fetch(`/ui/jobs/${jobId}/status`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ status: toSend })
          });
          if (!resp.ok) throw new Error('HTTP ' + resp.status);
          const data = await resp.json();

          this.app.state = data.status || toSend;
          this.editing = false;
          // notify parent to refresh history
          window.dispatchEvent(new CustomEvent('job-history-refresh', { detail: { jobId: this.jobId } }));
        } catch (e) {
          this.error = "Could not set status - please try again.";
        } finally {
          this.pending = false;
        }
      },

      // Reuse outer helper if present
      relativeFromLocal(iso){ return window.__relativeFromLocal?.(iso) ?? ''; }
    }));




    // That one is for pretty much everything on the page
    Alpine.data('jobDetailPage', (jobId) => ({
      jobId,
      _inited:false,
      meta: {
        title:"", company:"", postingCompany:"",
        remoteType:"", firstSeenUtc:"", lastSeenUtc:"",
        repostCount:0, url:"", applyUrl:"",
        foundOn:"", externalId:"", provider:"", providerTenant:"",
        locations: []
      },
      app:{ state:"New", changedAtUtc:null },
      safeDescription:"", descLoaded:false,
      history:{ items:[], nextCursor:null, loaded:false, loadingMore:false, error:"" },
      createdByUserId: null,
      canEdit: false,
      // delete modal state
      deleteModalOpen: false, deleteBusy: false, deleteError: "",      

      async init(){
        if (this._inited) return; this._inited = true;
        const tryFetch = async () => {
          const r = await fetch(`/ui/jobs/${this.jobId}`, { credentials:'same-origin' });
          if(!r.ok) throw new Error(`HTTP ${r.status}`);
          return r.json();
        };
        try{
          let payload;
          try { payload = await tryFetch(); }
          catch { await new Promise(res => setTimeout(res, 1200)); payload = await tryFetch(); }
          window.__lastJobPayload = payload;
          this.hydrateFromPayload(payload);
          this.descLoaded = true;
        }catch(e){
          this.safeDescription = `<p class="muted">Unable to load description right now.</p>`;
          this.descLoaded = true;
        }
        this.loadHistory();
        window.addEventListener('job-history-refresh', (e) => {
          if (!e.detail || e.detail.jobId === this.jobId) this.loadHistory();
        });

        // Pick up CURRENT_USER_ID if base already hydrated it
        if (typeof window.CURRENT_USER_ID !== 'undefined') {
          this._currentUidCache = String(window.CURRENT_USER_ID || '');
          this.canEdit = !!(this._currentUidCache && this.createdByUserId && this._currentUidCache === String(this.createdByUserId));
        }
        // Listen for late hydration from base.html
        window.addEventListener('user-hydrated', (ev) => {
          const uid = String((ev && ev.detail && ev.detail.id) || '');
          this._currentUidCache = uid;
          this.canEdit = !!(uid && this.createdByUserId && uid === String(this.createdByUserId));
        });
        // In case user bar hasn't fetched yet, politely request it
        try { window.initUser && window.initUser(); } catch(_) {}        
      },

      get(obj, keys){ for (const k of keys) if (obj && obj[k] != null) return obj[k]; },

      hydrateFromPayload(p){
        const title   = this.get(p, ["Title","title","JobTitle"]) || "";
        const extId   = this.get(p, ["ExternalId","externalId"]) || "";
        const company = this.get(p, ["HiringCompanyName","Company","CompanyName"]) || "";
        const posting = this.get(p, ["PostingCompanyName","PostingCompany","PostedBy"]) || "";
        const remote  = this.get(p, ["RemoteType","remote_type"]) || "";
        const foundOn = (this.get(p, ["FoundOn","foundOn"]) || "").toString().trim();
        const provider = (this.get(p, ["Provider","provider"]) || "").toString().trim();
        const tenant   = (this.get(p, ["ProviderTenant","providerTenant"]) || "").toString().trim();

        const firstSeen = this.get(p, ["FirstSeenAt","PostedDate","CreatedAt"]) || "";
        const lastSeen  = this.get(p, ["LastSeenAt","UpdatedAt"]) || firstSeen || "";
        let repostCount = Number.parseInt(this.get(p, ["RepostCount","repostCount"]) || 0, 10);
        if (!Number.isFinite(repostCount)) repostCount = 0;

        const url  = this.get(p, ["Url","OriginalUrl"]) || "";
        const applyUrl = this.get(p, ["ApplyUrl","ApplyLink"]) || "";

        // Locations: prefer new shape
        let locs = Array.isArray(p.locations) ? p.locations : [];
        // Back-compat: derive from Country/Locality if new field absent
        if (!locs.length) {
          const country = this.get(p, ["Country"]) || "";
          const locality = this.get(p, ["Locality","City"]) || "";
          if (country || locality) {
            locs = [{ countryName: country || "", countryCode: null, cityName: locality || null, region: null }];
          }
        }
        // Normalize location fields
        locs = locs.map(it => ({
          countryName: (it.countryName ?? "").toString(),
          countryCode: it.countryCode ? String(it.countryCode).toUpperCase() : null,
          cityName: (it.cityName ?? null) ? String(it.cityName) : null,
          region: (it.region ?? null) ? String(it.region) : null
        }));

        this.meta = {
          title: title || extId || "(untitled)",
          company, postingCompany: posting,
          remoteType: remote, firstSeenUtc:firstSeen, lastSeenUtc:lastSeen,
          repostCount, url, applyUrl,
          foundOn, externalId: extId, provider, providerTenant: tenant,
          locations: locs
        };

        const rawHtml = this.get(p, ["descriptionHtml","Description","Html"]) || "";
        this.safeDescription = this.sanitizeDescription(rawHtml);

        const appState = this.get(p, ["appState","Application"]) || {};
        this.app = {
          state: this.get(appState, ["state","State"]) || this.app.state,
          changedAtUtc: this.get(appState, ["changedAtUtc","ChangedAtUtc","changed_at_utc"]) || null
        };

        // capture creator for edit/delete permissions
        const createdBy = this.get(p, ["CreatedByUserId","createdByUserId","createdBy"]);
        this.createdByUserId = createdBy ? String(createdBy) : null;
        // server should inject current user id if logged in; fallback to empty
        const currentUid = (typeof window.CURRENT_USER_ID !== 'undefined')
          ? String(window.CURRENT_USER_ID || '')
          : '';
        this._currentUidCache = currentUid;
        this.canEdit = !!(currentUid && this.createdByUserId && currentUid === String(this.createdByUserId));
      },

      sanitizeDescription(html){
        if (!html) return "";
        const tmp = document.createElement('div');
        tmp.innerHTML = html;
        tmp.querySelectorAll('script,iframe,style,link,object,embed').forEach(el => el.remove());
        tmp.querySelectorAll('a[href]').forEach(a => { a.target = '_blank'; a.rel = 'noopener noreferrer nofollow'; });
        tmp.querySelectorAll('img[src]').forEach(img => {
          const src = (img.getAttribute('src') || '').trim();
          if (!src.startsWith('data:')) {
            const ph = document.createElement('div'); ph.className='placeholder-img'; ph.textContent='External image blocked';
            img.replaceWith(ph);
          } else { img.loading='lazy'; img.decoding='async'; }
        });
        return tmp.innerHTML;
      },

      companyLine(){
        return this.meta.postingCompany
          ? `${this.meta.company}, through ${this.meta.postingCompany}`
          : (this.meta.company || "");
      },

      // Group locations by country; render "DE: Berlin ¬∑ ES: Madrid ¬∑ GB"
      geoLine(){
        const locs = this.meta.locations || [];
        const parts = [];
        if (locs.length) {
          const groups = new Map(); // label -> [cities]
          for (const it of locs) {
            const label = (it.countryCode || it.countryName || "").toString().trim();
            if (!label) continue;
            if (!groups.has(label)) groups.set(label, []);
            if (it.cityName) groups.get(label).push(it.cityName);
          }
          for (const [label, cities] of groups.entries()) {
            parts.push(cities.length ? `${label}: ${cities.join(', ')}` : label);
          }
        }
        const geo = parts.join(' ¬∑ ');
        // Append remote type if set
        if (this.meta.remoteType) return geo ? `${geo}, ${this.meta.remoteType}` : this.meta.remoteType;
        return geo;
      },

      providerLine(){
        const p = (this.meta.provider || "").toLowerCase();
        if (!p || p === "corporate-site") return "";
        return this.meta.providerTenant
          ? `ATS: ${this.meta.provider}/${this.meta.providerTenant}`
          : `ATS: ${this.meta.provider}`;
      },

      seenPrefix(){ return (this.meta.repostCount||0) === 0 ? 'First seen' : 'Last seen'; },
      relativeSeen(){ return this.relativeFromLocal((this.meta.repostCount||0)===0 ? this.meta.firstSeenUtc : this.meta.lastSeenUtc); },

      // Time helpers
      formatLocalHM(iso){
        if (!iso) return '';
        const d = new Date(iso);
        const hh = String(d.getHours()).padStart(2,'0');
        const mm = String(d.getMinutes()).padStart(2,'0');
        return `${hh}:${mm}`;
      },
      localTzAbbr(iso){
        try{
          const d = new Date(iso);
          const parts = new Intl.DateTimeFormat(undefined, { timeZoneName:'short', hour:'2-digit' }).formatToParts(d);
          return parts.find(p => p.type === 'timeZoneName')?.value || '';
        }catch{ return ''; }
      },
      relativeFromLocal(iso){ return window.__relativeFromLocal?.(iso) ?? ''; },
      relativeFromUtc(iso){ return window.__relativeFromUtc?.(iso) ?? ''; }, // legacy

      safeStr(v){ return (v === null || v === undefined) ? '‚àÖ' : String(v); },

      async loadHistory(limit=10){
        this.history.error = "";
        try{
          const qs = new URLSearchParams({ limit:String(limit) }).toString();
          const url = `/ui/jobs/${this.jobId}/history?` + qs;
          const data = await window.fetchWithRetry(url, 4, 900);
          this.history.items = Array.isArray(data.items) ? data.items : [];
          this.history.nextCursor = data.nextCursor || null;
          this.history.loaded = true;
        }catch(e){
          this.history.error = "please try again";
          this.history.loaded = false;
        }
      },
      async loadMore(limit=10){
        if (!this.history.nextCursor || this.history.loadingMore) return;
        this.history.loadingMore = true;
        try{
          const qs = new URLSearchParams({ limit:String(limit), cursor:this.history.nextCursor }).toString();
          const url = `/ui/jobs/${this.jobId}/history?` + qs;
          const data = await window.fetchWithRetry(url, 3, 900);
          const more = Array.isArray(data.items) ? data.items : [];
          this.history.items = this.history.items.concat(more);
          this.history.nextCursor = data.nextCursor || null;
        }finally{
          this.history.loadingMore = false;
          this.history.loaded = true;
        }
      },
      copy(text){ navigator.clipboard?.writeText(text).catch(()=>{}); }

      // --- Debug tooltip for Delete button: shows expected/actual IDs and computed flag
      ,deleteDebugTitle(){
        const expected = this.createdByUserId ? String(this.createdByUserId) : "(none)";
        const got = this._currentUidCache ? String(this._currentUidCache) : "(none)";
        const flag = this.canEdit ? "true" : "false";
        return `Delete permission\ncreator: ${expected}\nyou: ${got}\ncanEdit: ${flag}`;
      }

      ,openDeleteModal(){
        if (!this.canEdit) return;
        this.deleteError = "";
        this.deleteBusy = false;
        this.deleteModalOpen = true;
        // ensure backdrop is visible for non-Alpine-controlled initial style
        const el = document.getElementById('delete-modal'); if (el) el.style.display = 'flex';
      }
      ,closeDeleteModal(){
        this.deleteModalOpen = false;
        const el = document.getElementById('delete-modal'); if (el) el.style.display = 'none';
      }
      ,async confirmDelete(){
        if (!this.canEdit || this.deleteBusy) return;
        this.deleteBusy = True ? true : true; // keep boolean for minifier safety
        this.deleteError = "";
        try{
          const resp = await fetch(`/ui/jobs/${encodeURIComponent(this.jobId)}`, {
            method: 'DELETE',
            credentials: 'same-origin'
          });
          if (resp.status === 204) {
            this.closeDeleteModal();
            window.location.assign('/jobs');
            return;
          }
          const text = await resp.text();
          this.deleteError = text || `Delete failed (HTTP ${resp.status})`;
        }catch(e){
          this.deleteError = 'Network error. Please try again.';
        }finally{
          this.deleteBusy = false;
        }
      }      
    }));
  });

</script>

{% endblock %}
