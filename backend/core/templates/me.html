{% extends "base.html" %}

{% block head_extra %}
<link href="{{ url_for('static', filename='css/quill.snow.css') }}" rel="stylesheet">

<style>
  /* lightweight card + layout */
  .container { max-width:1100px; margin:0 auto; padding:24px 16px; }
  .grid { display:grid; grid-template-columns: 1fr; gap:16px; }
  @media (min-width: 900px) { .grid { grid-template-columns: 1.2fr .8fr; } }
  .card { border:1px solid #e5e7eb; border-radius:12px; background:#fff; padding:16px; }
  .subtle { color:#6b7280; font-size:14px; }
  .key { width:140px; color:#6b7280; }
  .row { display:flex; gap:12px; padding:6px 0; align-items:center; }
  .skeleton { background:linear-gradient(90deg,#f3f4f6,#e5e7eb,#f3f4f6); background-size:200% 100%; animation: sh 1.2s linear infinite; border-radius:6px; }
  @keyframes sh { 0%{background-position:200% 0} 100%{background-position:-200% 0} }

  .pill { display:inline-block; border:1px solid #e5e7eb; border-radius:999px; padding:2px 10px; font-size:12px; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
  .btn { padding:6px 10px; border-radius:8px; border:1px solid #e5e7eb; background:#f9fafb; cursor:pointer; }
  .btn:disabled { opacity:.6; cursor:not-allowed; }
  .btn-row { display:flex; gap:8px; flex-wrap:wrap; }
  .small { font-size:12px; }
  /* Ensure 'hidden' always hides, regardless of other display rules */
  [hidden] { 
    display: none !important; }  

  /* Quill styling for /me (contained, card grows naturally) */
  #cvToolbar { margin-bottom: 6px; }

  #cvEditor.ql-container.ql-snow {
    border: 1px solid #e5e7eb;
    border-top: 0;
    border-radius: 0 0 8px 8px;
    box-sizing: border-box;

    /* Key part: do NOT stretch/fill; let it be content-driven */
    height: auto;
    min-height: 220px;                      /* visible even when empty */
    margin-bottom: 8px;                     /* ~5px+ gap to card border */
  }

  #cvEditor .ql-editor {
    /* Key part: scroll inside editor for long CVs */
    min-height: 200px;
    max-height: 520px;                      /* adjust if you want */
    overflow-y: auto;
  }

  /* Keep toolbar border consistent */
  #cvToolbar.ql-toolbar.ql-snow {
    border: 1px solid #e5e7eb;
    border-radius: 8px 8px 0 0;
    box-sizing: border-box;
  }
  #cvEditor .ql-editor { font-size: 14px; line-height: 1.4; }

  .err { color:#b91c1c; margin-top:6px; }
  .muted { color:#6b7280; font-size:12px; }
  .card { border:1px solid #e5e7eb; border-radius:12px; background:#fff; padding:16px; overflow:hidden; }
  pre { overflow-x: auto; }
</style>
{% endblock %}

{% block content %}
  <div class="container">
    <h1 style="margin:0 0 12px;">Your profile</h1>
    <p class="subtle" style="margin:0 0 20px;">
      This page shows your in‑app user info. Filters are not implemented yet.
    </p>

    <div class="grid">

      <!-- Profile card -->
      <section id="profile" class="card" aria-busy="true">
        <h2 style="margin:0 0 8px; font-size:18px;">Basic information</h2>
        <div class="row">
          <div class="key">Name</div>
          <div id="ui-name">{{ user.get("name") or '...' }}</div>
        </div>
        <div class="row">
          <div class="key">Email</div>
          <div id="ui-email"><span class="skeleton" style="display:inline-block; width:160px; height:1em;"></span></div>
        </div>
        <div class="row">
          <div class="key">Role</div>
          <div id="ui-role"><span class="skeleton" style="display:inline-block; width:80px; height:1em;"></span></div>
        </div>
        <p id="ui-error" class="subtle" hidden></p>
      </section>

      <!-- Telegram linking card -->
      <section id="telegram" class="card" aria-busy="true">
        <h2 style="margin:0 0 8px; font-size:18px;">Telegram</h2>

        <!-- Single line status that starts as Loading… -->
        <div class="row">
          <div class="key">Status</div>
          <div id="tg-status" class="subtle">Loading…</div>
        </div>

        <!-- Shown only when linked -->
        <div id="tg-linked" class="row" hidden>
          <div class="key">Linked as</div>
          <div id="tg-linked-id" class="mono"></div>
        </div>

        <!-- Shown only when NOT linked -->
        <div id="tg-unlinked" hidden>
          <div class="row">
            <div class="key">Link code</div>
            <div>
              <span id="tg-code" class="mono" style="font-size:16px;">— — — — — — — —</span>
              <div class="btn-row" style="margin-top:8px;">
                <button id="btn-copy-code" class="btn" type="button" disabled>Copy code</button>
                <button id="btn-refresh-status" class="btn" type="button" disabled>Refresh status</button>
                <a id="btn-open-bot" class="btn" href="#" target="_blank" rel="noopener" hidden>Open bot</a>
              </div>
              <p class="subtle small" style="margin-top:8px;">
                Open the bot and send <span class="mono">/link &lt;your code&gt;</span>. The code stays the same until used.
              </p>
            </div>
          </div>
        </div>

        <p id="tg-error" class="subtle" hidden></p>
      </section>

      <!-- Reports card -->
      <section id="reports" class="card">
        <h2 style="margin:0 0 8px; font-size:18px;">Your job status reports</h2>

        <div class="row">
          <div class="key">Range</div>
          <div class="btn-row small" style="gap:12px;">
            <label><input type="radio" name="rep-range" value="day" checked> Last day</label>
            <label><input type="radio" name="rep-range" value="week"> Last week</label>
            <label><input type="radio" name="rep-range" value="month"> Last month</label>
            <label><input type="radio" name="rep-range" value="custom"> Custom</label>
          </div>
        </div>

        <div id="rep-custom-row" class="row" hidden>
          <div class="key">Custom</div>
          <div class="btn-row">
            <input id="rep-start" type="datetime-local" class="btn" />
            <input id="rep-end" type="datetime-local" class="btn" />
          </div>
        </div>

        <div class="row">
          <div class="key">Aggregation</div>
          <label class="small"><input id="rep-agg" type="checkbox"> Aggregate by job</label>
        </div>

        <div class="row">
          <div class="key">Format</div>
          <select id="rep-format" class="btn">
            <option value="csv" selected>CSV</option>
            <!-- future: <option value="text">Text</option> -->
          </select>
        </div>

        <div class="btn-row" style="margin-top:8px;">
          <button id="btn-download-report" class="btn" type="button">Download report</button>
          <span id="rep-note" class="subtle small">Custom range max 6 months.</span>
        </div>

        <p id="rep-error" class="subtle" hidden></p>
      </section>


      
      <!-- Filters placeholder -->
      <section class="card">
        <h2 style="margin:0 0 8px; font-size:18px;">Your filters</h2>
        <p class="subtle" id="user-filters-span">Filters are not implemented yet.</p>
      </section>

      <!-- Preferences card (CV rich text) -->
      <section id="prefs" class="card" aria-busy="true">
        <h2 style="margin:0 0 8px; font-size:18px;">Preferences</h2>
        <p class="subtle" style="margin:0 0 12px;">
          CV is stored as rich text (Quill delta). Other fields are shown for debugging.
        </p>

        <div class="btn-row" style="align-items:center; margin-bottom:8px;">
          <button id="btn-save-prefs" class="btn primary" type="button" disabled>Save changes</button>
          <span id="prefs-status" class="subtle small" hidden>Wait for it…</span>
        </div>
        <div id="prefs-error" class="err" hidden></div>

        <!-- Quill toolbar -->
        <div id="cvToolbar">
          <span class="ql-formats">
            <select class="ql-header">
              <option selected></option>
              <option value="2">H2</option>
              <option value="3">H3</option>
            </select>
          </span>
          <span class="ql-formats">
            <button class="ql-bold"></button>
            <button class="ql-italic"></button>
            <button class="ql-underline"></button>
            <button class="ql-strike"></button>
          </span>
          <span class="ql-formats">
            <button class="ql-blockquote"></button>
            <button class="ql-code-block"></button>
          </span>
          <span class="ql-formats">
            <button class="ql-list" value="ordered"></button>
            <button class="ql-list" value="bullet"></button>
          </span>
          <span class="ql-formats">
            <button class="ql-link"></button>
          </span>
          <span class="ql-formats">
            <button class="ql-clean"></button>
          </span>
        </div>

        <div id="cvEditor"></div>

        <div class="muted" style="margin-top:6px;">
          No images. Links are allowed.
        </div>

        <!-- Debug: collapsed by default -->
        <details style="margin-top:12px;">
          <summary class="subtle">Debug (raw preferences payload)</summary>
          <pre id="prefs-debug" class="mono" style="white-space:pre-wrap; margin-top:8px;"></pre>
        </details>
      </section>




    </div>
  </div>

<script src="{{ url_for('static', filename='js/quill.min.js') }}"></script>


<script>
  (function () {
    const box   = document.getElementById('profile');
    const elName  = document.getElementById('ui-name');
    const elEmail = document.getElementById('ui-email');
    const elRole  = document.getElementById('ui-role');
    const elErr   = document.getElementById('ui-error');

    const tgBox      = document.getElementById('telegram');
    const tgStatus   = document.getElementById('tg-status');
    const tgLinked   = document.getElementById('tg-linked');
    const tgLinkedId = document.getElementById('tg-linked-id');
    const tgUnlinked = document.getElementById('tg-unlinked');
    const tgCode     = document.getElementById('tg-code');
    const tgErr      = document.getElementById('tg-error');
    const btnCopy    = document.getElementById('btn-copy-code');
    const btnRefresh = document.getElementById('btn-refresh-status');
    const btnOpenBot = document.getElementById('btn-open-bot');

    function setBusy(section, b){ section?.setAttribute('aria-busy', b ? 'true' : 'false'); }
    function enableControls(enabled) {
      btnCopy && (btnCopy.disabled = !enabled);
      btnRefresh && (btnRefresh.disabled = !enabled);
    }

    function renderProfile(u){
      if (u?.name || u?.preferred_username || u?.username) {
        elName.textContent = u.name || u.preferred_username || u.username;
      }
      elEmail.textContent = u?.email || '—';
      elRole.textContent = u?.role ?? 'user';
    }

    function showError(el, msg){
      el.hidden = false;
      el.textContent = msg;
    }

    async function fetchLinkCode(){
      // UI proxy (added below) to users function
      return await window.fetchWithRetry('/ui/users/link-code', 4);
    }

    function applyTelegramUi(state){
      // Reset view
      tgLinked.hidden = true;
      tgUnlinked.hidden = true;
      enableControls(false);

      if (!state) {
        tgStatus.textContent = 'Error';
        return;
      }

      if (state.linked) {
        tgStatus.textContent = 'Linked ✅';
        tgLinked.hidden = false;
        tgLinkedId.textContent = state.telegramUserId ? String(state.telegramUserId) : '';
      } else {
        tgStatus.textContent = 'Not linked';
        tgUnlinked.hidden = false;
        tgCode.textContent = state.code || '— — — — — — — —';
        enableControls(Boolean(state.code));

        // Optional deep link to bot
        const botName = (window.TELEGRAM_BOT_USERNAME || '').trim();
        if (botName) {
          btnOpenBot.hidden = false;
          btnOpenBot.href = 'https://t.me/' + encodeURIComponent(botName);
        } else {
          btnOpenBot.hidden = true;
        }
      }
    }

    async function initProfile(){
      setBusy(box, true);
      try {
        const data = await window.fetchWithRetry('/ui/users/me', 4);
        if (data && !data.error) renderProfile(data);
        else showError(elErr, (data && data.message) || 'Please try again.');
      } catch {
        showError(elErr, 'Please try again.');
      } finally {
        setBusy(box, false);
      }
    }

    async function initTelegram(){
      setBusy(tgBox, true);
      tgStatus.textContent = 'Loading…';
      try {
        const data = await fetchLinkCode();
        if (data && !data.error) applyTelegramUi(data);
        else {
          tgStatus.textContent = 'Error';
          showError(tgErr, (data && data.message) || 'Please try again.');
        }
      } catch {
        tgStatus.textContent = 'Error';
        showError(tgErr, 'Please try again.');
      } finally {
        setBusy(tgBox, false);
      }
    }

    // Events
    btnCopy?.addEventListener('click', async () => {
      const code = (tgCode?.textContent || '').replace(/\s+/g, '').trim();
      if (!code || code.includes('—')) return;
      try {
        await navigator.clipboard.writeText(code);
        btnCopy.textContent = 'Copied ✓';
        setTimeout(() => (btnCopy.textContent = 'Copy code'), 1200);
      } catch { /* noop */ }
    });

    btnRefresh?.addEventListener('click', async () => {
      await initTelegram();
    });

    // Reports UI wiring
    const repCard   = document.getElementById('reports');
    const rangeRadios = Array.from(document.querySelectorAll('input[name="rep-range"]'));
    const rowCustom = document.getElementById('rep-custom-row');
    const inpStart  = document.getElementById('rep-start');
    const inpEnd    = document.getElementById('rep-end');
    const inpAgg    = document.getElementById('rep-agg');
    const selFmt    = document.getElementById('rep-format');
    const btnDl     = document.getElementById('btn-download-report');
    const repErr    = document.getElementById('rep-error');

    function syncCustomRowVisibility() {
      clearRepError();
      const val = rangeRadios.find(x=>x.checked)?.value;
      const custom = val === 'custom';
      rowCustom.hidden = !custom;
      if (custom) {
        // Pre-fill only if empty
        if (!inpStart.value) {
          const dayAgo = new Date(Date.now() - 24*3600*1000);
          inpStart.value = currentIso(dayAgo);
        }
        if (!inpEnd.value) {
          inpEnd.value = currentIso(new Date());
        }
      }
    }

    function showRepError(msg){
      repErr.hidden = false;
      repErr.textContent = msg;
    }
    function clearRepError(){
      repErr.hidden = true;
      repErr.textContent = '';
    }

    function currentIso(dt){ // YYYY-MM-DDTHH:MM
      const pad = n => String(n).padStart(2,'0');
      return dt.getFullYear() + '-' + pad(dt.getMonth()+1) + '-' + pad(dt.getDate())
           + 'T' + pad(dt.getHours()) + ':' + pad(dt.getMinutes());
    }

    // (kept, but no longer used to auto-show dates)
    function pickStartEnd(range){ /* noop helper kept for future */ return { start:null, end:null }; }
 

    rangeRadios.forEach(r => r.addEventListener('change', syncCustomRowVisibility));

    btnDl?.addEventListener('click', async () => {
      clearRepError();
      try {
        const chosen = rangeRadios.find(x=>x.checked)?.value || 'day';
        let params = new URLSearchParams();
        params.set('format', selFmt.value || 'csv');
        params.set('aggregate', inpAgg.checked ? 'true' : 'false');

        // NEW: send browser tz
        try {
          const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
          if (tz) params.set('tz', tz);
        } catch {}

        if (chosen === 'custom') {
          const s = (inpStart.value || '').trim();
          if (!s) return showRepError('Please select custom start');
          params.set('start', s);

          const e = (inpEnd.value || '').trim();
          if (e) params.set('end', e);
        } else {
          params.set('range', chosen); // day|week|month
        }

        // Trigger a download via UI endpoint
        const url = '/ui/reports/status?' + params.toString();
        // Create an <a download> to respect filename from headers if provided
        const a = document.createElement('a');
        a.href = url;
        a.rel = 'noopener';
        document.body.appendChild(a);
        a.click();
        setTimeout(()=>a.remove(), 0);
      } catch (e) {
        showRepError('Failed to start download. Please try again.');
      }
    });


    
    // ===== Preferences (CV rich text) =====
    const prefsBox     = document.getElementById('prefs');
    const btnSavePrefs = document.getElementById('btn-save-prefs');
    const prefsErr     = document.getElementById('prefs-error');
    const prefsSaving  = document.getElementById('prefs-status');
    const prefsDebug   = document.getElementById('prefs-debug');

    let cvQuill = null;
    let prefsBusy = false;
    let initialDeltaStr = JSON.stringify({ ops: [] });

    function showPrefsError(msg){
      prefsErr.hidden = false;
      prefsErr.textContent = msg;
    }
    function clearPrefsError(){
      prefsErr.hidden = true;
      prefsErr.textContent = '';
    }

    const prefsStatus  = document.getElementById('prefs-status');

    function setPrefsBusy(b, label){
      prefsBusy = b;
      prefsBox?.setAttribute('aria-busy', b ? 'true' : 'false');

      if (prefsStatus) {
        prefsStatus.hidden = !b;
        prefsStatus.textContent = b ? (label || 'Working…') : '';
      }

      btnSavePrefs.disabled = true;
      if (cvQuill) cvQuill.enable(!b);
    }

    function safeDeltaFromUpstream(x){
      if (!x) return { ops: [] };
      if (typeof x === 'string') {
        try { return JSON.parse(x); } catch { return { ops: [] }; }
      }
      if (typeof x === 'object') return x;
      return { ops: [] };
    }

    function nowDeltaStr(){
      if (!cvQuill) return JSON.stringify({ ops: [] });
      return JSON.stringify(cvQuill.getContents() || { ops: [] });
    }

    function isDirty(){
      return nowDeltaStr() !== initialDeltaStr;
    }

    function syncSaveButton(){
      if (!btnSavePrefs) return;
      if (prefsBusy) { btnSavePrefs.disabled = true; return; }
      btnSavePrefs.disabled = !isDirty();
    }

    async function initPrefs(){
      if (!prefsBox) return;

      setPrefsBusy(true, 'Loading…');
      clearPrefsError();

      // init Quill once
      if (!cvQuill) {
        cvQuill = new Quill('#cvEditor', {
          theme: 'snow',
          modules: { toolbar: '#cvToolbar' }
        });
        cvQuill.on('text-change', () => syncSaveButton());
      }

      try {
        const data = await window.fetchWithRetry('/ui/users/preferences', 4, 750);
        // Fill editor with CV delta
        const delta = safeDeltaFromUpstream(data?.CVQuillDelta);
        cvQuill.setContents(delta);

        // baseline for dirty tracking (AFTER setContents)
        initialDeltaStr = nowDeltaStr();

        // Debug block: show whole payload (collapsed in <details>)
        if (prefsDebug) {
          try { prefsDebug.textContent = JSON.stringify(data, null, 2); }
          catch { prefsDebug.textContent = String(data); }
        }

        // Not dirty after load => keep disabled (your rule)
        btnSavePrefs && (btnSavePrefs.disabled = true);
      } catch (e) {
        showPrefsError('Failed to load preferences. Please try again.');
      } finally {
        setPrefsBusy(false);
        syncSaveButton();
      }
    }

    btnSavePrefs?.addEventListener('click', async () => {
      if (!cvQuill || prefsBusy) return;
      clearPrefsError();

      // only allow save if dirty
      if (!isDirty()) { btnSavePrefs.disabled = true; return; }

      setPrefsBusy(true, 'Saving…');
      try {
        const payload = { CVQuillDelta: cvQuill.getContents() || { ops: [] } };

        const resp = await window.fetchWithRetry(
          '/ui/users/preferences',
          2,      // attempts: don't spam writes
          750,    // baseDelay
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          }
        );

        // success: reset baseline, disable button
        initialDeltaStr = nowDeltaStr();
        btnSavePrefs.disabled = true;

        // merge debug view with latest POST response fields if possible
        if (prefsDebug) {
          try {
            const prev = JSON.parse(prefsDebug.textContent || "{}");
            prefsDebug.textContent = JSON.stringify({ ...prev, ...resp }, null, 2);
          } catch {
            prefsDebug.textContent = JSON.stringify(resp, null, 2);
          }
        }
      } catch (e) {
        showPrefsError('Failed to save preferences. Please try again.');
      } finally {
        setPrefsBusy(false);
        syncSaveButton();
      }
    });


    document.addEventListener('DOMContentLoaded', () => {
      // Hide/show the custom row immediately, without waiting on network
      syncCustomRowVisibility();
      // Kick off the async in parallel (no await to avoid blocking UI)
      initProfile();
      initTelegram();
      initPrefs();
    });

  })();
</script>
{% endblock %}
