{% extends "base.html" %}

{% block head_extra %}
<style>
  /* lightweight card + layout */
  .container { max-width:1100px; margin:0 auto; padding:24px 16px; }
  .grid { display:grid; grid-template-columns: 1fr; gap:16px; }
  @media (min-width: 900px) { .grid { grid-template-columns: 1.2fr .8fr; } }
  .card { border:1px solid #e5e7eb; border-radius:12px; background:#fff; padding:16px; }
  .subtle { color:#6b7280; font-size:14px; }
  .key { width:140px; color:#6b7280; }
  .row { display:flex; gap:12px; padding:6px 0; align-items:center; }
  .skeleton { background:linear-gradient(90deg,#f3f4f6,#e5e7eb,#f3f4f6); background-size:200% 100%; animation: sh 1.2s linear infinite; border-radius:6px; }
  @keyframes sh { 0%{background-position:200% 0} 100%{background-position:-200% 0} }
</style>
{% endblock %}

{% block content %}
  <div class="container">
    <h1 style="margin:0 0 12px;">Your profile</h1>
    <p class="subtle" style="margin:0 0 20px;">
      This page shows your in‑app user info. Filters are not implemented yet.
    </p>

    <div class="grid">

      <!-- Profile card -->
      <section id="profile" class="card" aria-busy="true">
        <h2 style="margin:0 0 8px; font-size:18px;">Basic information</h2>
        <div class="row">
          <div class="key">Name</div>
          <div id="ui-name">{{ user.get("name") or '...' }}</div>
        </div>
        <div class="row">
          <div class="key">Email</div>
          <div id="ui-email"><span class="skeleton" style="display:inline-block; width:160px; height:1em;"></span></div>
        </div>
        <div class="row">
          <div class="key">Role</div>
          <div id="ui-role"><span class="skeleton" style="display:inline-block; width:80px; height:1em;"></span></div>
        </div>
        <p id="ui-error" class="subtle" hidden></p>
      </section>

      <!-- Filters placeholder -->
      <section class="card">
        <h2 style="margin:0 0 8px; font-size:18px;">Your filters</h2>
        <p class="subtle" id="user-filters-span">Filters are not implemented yet.</p>
      </section>

    </div>
  </div>

  <script>
  (function () {
    const box   = document.getElementById('profile');
    const elName  = document.getElementById('ui-name');
    const elEmail = document.getElementById('ui-email');
    const elRole  = document.getElementById('ui-role');
    const elErr   = document.getElementById('ui-error');

    function setBusy(b){ box?.setAttribute('aria-busy', b ? 'true' : 'false'); }

    function renderProfile(u){
      if (u?.name || u?.preferred_username || u?.username) {
        elName.textContent = u.name || u.preferred_username || u.username;
      }
      if (u?.email) elEmail.textContent = u.email; else elEmail.textContent = '—';
      elRole.textContent = u?.role ?? 'user';
    }

    function showError(msg){
      elErr.hidden = false;
      elErr.textContent = msg;
    }

    async function init(){
      setBusy(true);
      try {
        // shared helper from static/js/net-utils.js
        const data = await window.fetchWithRetry('/ui/users/me', 4);
        if (data && !data.error) {
          renderProfile(data);
        } else {
          showError((data && data.message) || 'Please try again.');
        }
      } catch {
        showError('Please try again.');
      } finally {
        setBusy(false);
      }
    }

    document.addEventListener('DOMContentLoaded', init);
  })();
  </script>
{% endblock %}
